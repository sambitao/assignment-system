<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assignment Interruption System</title>
    
    <!-- CSS & Libs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">

    <!-- Firebase SDKs (Compat v8 for existing code compatibility) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 50:'#fff7ed', 100:'#ffedd5', 500:'#f97316', 600:'#ea580c', 700:'#c2410c' },
                        status: { 
                            new:'#3b82f6', 
                            process:'#eab308', 
                            assign:'#a855f7', 
                            approve:'#06b6d4', 
                            finish:'#22c55e', 
                            complete:'#22c55e', 
                            update_fms: '#0891b2',
                            cancel:'#ef4444' 
                        }
                    },
                    fontFamily: { sans: ['Prompt', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Prompt', sans-serif; background-color: #f8fafc; }
        .submenu { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .submenu.open { max-height: 500px; transition: max-height 0.5s ease-in; }
        .status-badge { @apply px-2.5 py-0.5 text-xs rounded-full font-bold border whitespace-nowrap uppercase tracking-wider; }
        .rr-box { @apply border border-orange-200 rounded-xl p-4 bg-orange-50 mb-6 shadow-sm relative; }
        .rr-label { @apply text-xs font-bold text-gray-500 uppercase tracking-wider mb-1; }
        .rr-value { @apply font-bold text-gray-800 text-lg; }
        input:disabled, select:disabled, textarea:disabled { background-color: #f3f4f6; color: #9ca3af; cursor: not-allowed; }
        .other-input { display: none; margin-top: 0.5rem; }
        .other-input.show { display: block; animation: fadeIn 0.3s; }
        .indicator { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .indicator.loading { background-color: #fbbf24; animation: pulse 1.5s infinite; }
        .indicator.online { background-color: #22c55e; box-shadow: 0 0 5px #22c55e; }
        .indicator.error { background-color: #ef4444; }
        .calendar-day:hover { transform: translateY(-2px); z-index: 10; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); cursor: pointer; border-color: #f97316; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 2px; }
        .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 200ms; }
        
        .select2-container .select2-selection--multiple { min-height: 42px; border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 4px; }
        .select2-container--default .select2-selection--multiple .select2-selection__choice { background-color: #ffedd5; border: 1px solid #fed7aa; border-radius: 0.25rem; color: #c2410c; padding: 0 4px; margin-top: 4px; }
        .select2-container--default .select2-selection--multiple .select2-selection__choice__remove { color: #c2410c; margin-right: 5px; }
        .select2-container--default.select2-container--focus .select2-selection--multiple { border-color: #f97316; box-shadow: 0 0 0 1px #f97316; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* Print Styling */
        @media print {
            #sidebar, header, #sidebar-overlay, .print-hide { display: none !important; }
            body, html, main, #content-container, .view-section { 
                height: auto !important; 
                overflow: visible !important; 
                background-color: white !important;
                width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            canvas { max-width: 100% !important; height: auto !important; }
            .break-inside-avoid { break-inside: avoid; }
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-gray-800">
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden lg:hidden transition-opacity"></div>
    
    <!-- Sidebar -->
    <aside id="sidebar" class="fixed lg:static inset-y-0 left-0 w-72 bg-white shadow-xl transform -translate-x-full lg:translate-x-0 transition-all duration-300 z-30 flex flex-col h-full border-r border-gray-200 whitespace-nowrap">
        <div class="p-6 border-b border-gray-100 flex items-center justify-center bg-gray-50">
            <div class="text-center overflow-hidden">
                <div class="flex justify-center items-center mb-3">
						
          				<img src="SYMC logo.png" 
                         alt="Logo" 
                         class="w-16 h-16 rounded-full object-cover shadow-sm border-2 border-white bg-white">
					
                </div>
				
                <h1 class="text-xl font-bold text-gray-800 tracking-tight">Assignment</h1>
                <h2 class="text-xs font-semibold text-gray-500 tracking-wide uppercase mt-1">Interruption Team</h2>
            </div>
        </div>
        <nav class="flex-1 overflow-y-auto p-4 space-y-2 overflow-x-hidden">
            <a href="#" onclick="switchView('dashboard_analytics')" class="nav-item flex items-center p-3 rounded-lg hover:bg-brand-50 hover:text-brand-600 transition-all active-nav bg-brand-50 text-brand-600 font-semibold" data-view="dashboard_analytics">
                <div class="w-8 flex justify-center flex-shrink-0"><i class="fa-solid fa-chart-pie text-lg"></i></div><span class="ml-3">Dashboard Analytics</span>
            </a>
            <a href="#" onclick="switchView('calendar')" class="nav-item flex items-center p-3 rounded-lg hover:bg-brand-50 hover:text-brand-600 transition-all group" data-view="calendar">
                <div class="w-8 flex justify-center flex-shrink-0"><i class="fa-regular fa-calendar-days text-lg"></i></div><span class="ml-3">ปฏิทินงาน (Calendar)</span>
            </a>
            <a href="#" onclick="switchView('plan_interruption')" class="nav-item flex items-center p-3 rounded-lg hover:bg-brand-50 hover:text-brand-600 transition-all group" data-view="plan_interruption">
                <div class="w-8 flex justify-center flex-shrink-0"><i class="fa-solid fa-clipboard-list text-lg group-hover:text-brand-500"></i></div>
                <span class="ml-3">Interruption Plan</span>
                <!-- Badge for Plan -->
                <span id="badge-plan_interruption" class="ml-auto bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full hidden shadow-sm transform scale-100 transition-transform duration-200">0</span>
            </a>
            
            <!-- Summary Plan Menu -->
            <div>
                <button onclick="toggleSubmenu('summary-menu', this)" class="w-full flex items-center justify-between p-3 rounded-lg text-gray-700 hover:bg-brand-50 hover:text-brand-600 transition-all group">
                    <div class="flex items-center">
                        <div class="w-8 flex justify-center flex-shrink-0"><i class="fa-solid fa-file-contract text-lg group-hover:text-brand-500"></i></div>
                        <span class="ml-3">Project Plan</span>
                    </div>
                    <div class="flex items-center">
                        <!-- Parent Badge for Summary -->
                        <span id="badge-parent-summary" class="mr-2 bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full hidden shadow-sm">0</span>
                        <i class="fa-solid fa-chevron-down text-xs transition-transform duration-300 text-gray-400"></i>
                    </div>
                </button>
                <div id="summary-menu" class="submenu pl-4 space-y-1 mt-1">
                    <a href="#" onclick="switchView('summary_plan')" class="block p-2 rounded-md text-sm text-gray-600 hover:text-brand-600 hover:bg-brand-50 pl-12 border-l-2 border-transparent hover:border-brand-300 font-medium flex justify-between items-center" data-view="summary_plan">
                        <span><i class="fa-solid fa-list mr-2 text-xs"></i>Job List</span>
                        <span id="badge-summary_plan" class="bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full hidden">0</span>
                    </a>
                    <a href="#" onclick="switchView('summary_dashboard')" class="block p-2 rounded-md text-sm text-gray-600 hover:text-brand-600 hover:bg-brand-50 pl-12 border-l-2 border-transparent hover:border-brand-300 font-medium" data-view="summary_dashboard"><i class="fa-solid fa-chart-simple mr-2 text-xs"></i>Dashboard Project</a>
                </div>
            </div>

            <a href="#" onclick="switchView('team', 'Interruption Team')" class="nav-item flex items-center p-3 rounded-lg text-gray-700 hover:bg-brand-50 hover:text-brand-600 transition-all" data-view="team">
                <div class="w-8 flex justify-center flex-shrink-0"><i class="fa-solid fa-users text-lg"></i></div>
                <span class="ml-3">Interruption Team</span>
                <!-- Badge for Team -->
                <span id="badge-team" class="ml-auto bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full hidden shadow-sm">0</span>
            </a>
            <div>
                <button onclick="toggleSubmenu('subcontractor-menu', this)" class="w-full flex items-center justify-between p-3 rounded-lg text-gray-700 hover:bg-brand-50 hover:text-brand-600 transition-all group">
                    <div class="flex items-center">
                        <div class="w-8 flex justify-center flex-shrink-0"><i class="fa-solid fa-helmet-safety text-lg group-hover:text-brand-500"></i></div>
                        <span class="ml-3">Subcontractor</span>
                    </div>
                    <div class="flex items-center">
                        <!-- Parent Badge for Subcontractor -->
                        <span id="badge-parent-sub" class="mr-2 bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full hidden shadow-sm">0</span>
                        <i class="fa-solid fa-chevron-down text-xs transition-transform duration-300 text-gray-400"></i>
                    </div>
                </button>
                <div id="subcontractor-menu" class="submenu pl-4 space-y-1 mt-1">
                    <a href="#" onclick="switchView('sub_dashboard')" class="block p-2 rounded-md text-sm text-gray-600 hover:text-brand-600 hover:bg-brand-50 pl-12 border-l-2 border-transparent hover:border-brand-300 font-medium"><i class="fa-solid fa-chart-line mr-2 text-xs"></i>Dashboard & Cost</a>
                    <a href="#" onclick="switchView('sub_preventive', 'Assignment Preventive')" class="block p-2 rounded-md text-sm text-gray-600 hover:text-brand-600 hover:bg-brand-50 pl-12 border-l-2 border-transparent hover:border-brand-300 flex justify-between items-center">
                        <span>Preventive</span>
                        <span id="badge-sub_preventive" class="bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full hidden">0</span>
                    </a>
                    <a href="#" onclick="switchView('sub_reroute', 'Assignment Reroute')" class="block p-2 rounded-md text-sm text-gray-600 hover:text-brand-600 hover:bg-brand-50 pl-12 border-l-2 border-transparent hover:border-brand-300 flex justify-between items-center">
                        <span>Reroute</span>
                        <span id="badge-sub_reroute" class="bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full hidden">0</span>
                    </a>
                    <a href="#" onclick="switchView('sub_reconfigure', 'Assignment Reconfigure')" class="block p-2 rounded-md text-sm text-gray-600 hover:text-brand-600 hover:bg-brand-50 pl-12 border-l-2 border-transparent hover:border-brand-300 flex justify-between items-center">
                        <span>Reconfigure & Cancel</span>
                        <span id="badge-sub_reconfigure" class="bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full hidden">0</span>
                    </a>
                    <a href="#" onclick="switchView('setting')" class="block p-2 rounded-md text-sm text-gray-600 hover:text-brand-600 hover:bg-brand-50 pl-12 border-l-2 border-transparent hover:border-brand-300"><i class="fa-solid fa-gear mr-2"></i>Setting</a>
                </div>
            </div>
            
            <!-- Link Support Menu (Added) -->
            <a href="#" onclick="switchView('link_support')" class="nav-item flex items-center p-3 rounded-lg text-gray-700 hover:bg-brand-50 hover:text-brand-600 transition-all group" data-view="link_support">
                <div class="w-8 flex justify-center flex-shrink-0"><i class="fa-solid fa-link text-lg group-hover:text-brand-500"></i></div><span class="ml-3">Link Support</span>
            </a>
        </nav>
        <div class="p-4 border-t border-gray-100 text-xs text-gray-400 text-center bg-gray-50"><p>© 2026 Assignment Interruption V.4</p></div>
    </aside>
    
    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full relative overflow-y-auto lg:overflow-hidden bg-gray-50">
        <header class="bg-white shadow-sm h-16 flex-none flex items-center justify-between px-4 lg:px-8 z-10 border-b border-gray-200 sticky top-0 lg:static">
            <div class="flex items-center">
                <!-- Mobile Toggle Button -->
                <button onclick="toggleSidebar()" class="lg:hidden text-gray-500 hover:text-brand-600 mr-4 focus:outline-none"><i class="fa-solid fa-bars text-2xl"></i></button>
                
                <!-- Desktop Toggle Button -->
                <button onclick="toggleDesktopSidebar()" id="desktop-toggle-btn" class="hidden lg:block text-gray-500 hover:text-brand-600 mr-4 focus:outline-none transition-transform duration-300"><i class="fa-solid fa-bars-staggered text-2xl"></i></button>
                
                <h2 id="page-title" class="text-xl font-bold text-gray-800"><span class="text-brand-500 mr-2">|</span>Assignment Interruption System</h2>
            </div>
            <div class="flex items-center space-x-4"><div class="flex flex-col items-end"><div id="db-status" class="text-xs px-3 py-1.5 rounded-full bg-gray-100 text-gray-600 flex items-center cursor-pointer hover:bg-gray-200 transition" onclick="testConnection()"><span class="indicator loading" id="status-dot"></span> <span id="status-text" class="font-medium">Connecting...</span></div></div><div class="h-10 w-10 bg-gradient-to-br from-brand-100 to-orange-200 rounded-full flex items-center justify-center text-brand-600 shadow-sm border border-white"><i class="fa-regular fa-user"></i></div></div>
        </header>
        
        <div id="content-container" class="flex-1 flex flex-col overflow-visible lg:overflow-hidden relative p-4 lg:p-6 bg-gray-50 min-h-0 h-auto lg:h-full">
            
            <!-- VIEW: DASHBOARD (MAIN) -->
            <div id="view-dashboard-analytics" class="view-section flex-1 flex flex-col overflow-visible lg:overflow-auto h-auto lg:h-full hidden">
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-200 mb-6 flex flex-wrap gap-4 items-end">
                    <div class="w-full sm:w-auto"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">เลือกหมวดงาน</label><select id="dash-filter-category" onchange="renderDashboardCharts()" class="w-full sm:w-48 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-brand-500"><option value="all">ทั้งหมด</option><option value="plan_interruption">Interruption Plan</option><option value="team">Interruption Team</option><option value="sub_preventive">Preventive</option><option value="sub_reroute">Reroute</option><option value="sub_reconfigure">Reconfigure & Cancel</option></select></div>
                    <div class="w-full sm:w-auto"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">ช่วงเวลา</label><div class="flex gap-2"><input type="date" id="dash-date-start" onchange="renderDashboardCharts()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm"><input type="date" id="dash-date-end" onchange="renderDashboardCharts()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm"></div></div>
                    <div class="w-full sm:w-auto ml-auto flex gap-2">
                        <button onclick="window.print()" class="print-hide px-4 py-2 bg-gray-600 text-white rounded-lg text-sm hover:bg-gray-700 shadow-md"><i class="fa-solid fa-print mr-1"></i> Print PDF</button>
                        <button onclick="renderDashboardCharts()" class="print-hide px-4 py-2 bg-brand-500 text-white rounded-lg text-sm hover:bg-brand-600 shadow-md"><i class="fa-solid fa-sync mr-1"></i> Refresh</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-blue-500"><p class="text-gray-500 text-xs font-bold uppercase">Total Jobs</p><h3 class="text-3xl font-bold text-blue-600 mt-1" id="stat-total">0</h3></div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-green-500"><p class="text-gray-500 text-xs font-bold uppercase">Success Rate</p><h3 class="text-3xl font-bold text-green-600 mt-1" id="stat-success">0%</h3><p class="text-xs text-gray-400 mt-1" id="stat-success-count">0 jobs</p></div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-yellow-500"><p class="text-gray-500 text-xs font-bold uppercase">Pending</p><h3 class="text-3xl font-bold text-yellow-600 mt-1" id="stat-pending">0</h3></div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-red-500"><p class="text-gray-500 text-xs font-bold uppercase">Cancelled</p><h3 class="text-3xl font-bold text-red-600 mt-1" id="stat-cancel">0</h3></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6 break-inside-avoid">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200"><h4 class="font-bold text-gray-700 mb-4">ปริมาณงานแยกตามสถานะ</h4><div class="h-64"><canvas id="chartStatus"></canvas></div></div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200"><h4 class="font-bold text-gray-700 mb-4">แนวโน้มงานรายวัน</h4><div class="h-64"><canvas id="chartTrend"></canvas></div></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6 break-inside-avoid">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 lg:col-span-1"><h4 class="font-bold text-gray-700 mb-4">ประเภทงาน</h4><div class="h-64"><canvas id="chartJobType"></canvas></div></div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 lg:col-span-2"><h4 class="font-bold text-gray-700 mb-4">หน่วยงานที่แจ้ง</h4><div class="h-64"><canvas id="chartAgency"></canvas></div></div>
                </div>
            </div>

            <!-- VIEW: SUMMARY DASHBOARD (NEW) -->
            <div id="view-summary-dashboard" class="view-section hidden w-full h-auto lg:h-full lg:overflow-y-auto overflow-visible pb-40">
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-200 mb-6 flex flex-wrap gap-4 items-end">
                    <div class="flex items-center gap-2 mb-1 w-full"><i class="fa-solid fa-chart-simple text-brand-500"></i><h3 class="font-bold text-gray-700">Project Plan Analytics</h3></div>
                    <div class="w-full sm:w-auto"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Job Type</label><select id="sum-dash-jobtype" onchange="renderSummaryDashboard()" class="w-full sm:w-48 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-brand-500"><option value="all">ทั้งหมด (All)</option></select></div>
                    <div class="w-full sm:w-auto"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">ช่วงเวลา (Date Range)</label><div class="flex gap-2"><input type="date" id="sum-dash-start" onchange="renderSummaryDashboard()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm"><input type="date" id="sum-dash-end" onchange="renderSummaryDashboard()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm"></div></div>
                    <div class="w-full sm:w-auto ml-auto flex gap-2">
                        <button onclick="renderSummaryDashboard()" class="px-4 py-2 bg-brand-500 text-white rounded-lg text-sm hover:bg-brand-600 shadow-md"><i class="fa-solid fa-sync mr-1"></i> Refresh</button>
                    </div>
                </div>

                <!-- 4 Main Stats (Modified Layout for Distances) -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-5 rounded-2xl shadow-lg text-white relative overflow-hidden">
                        <div class="relative z-10">
                            <p class="text-blue-100 text-xs font-bold uppercase mb-2 border-b border-blue-400 pb-1" id="sum-title-route">Total Plan</p>
                            <div class="flex justify-between items-end mb-1">
                                <div>
                                    <h3 class="text-3xl font-bold leading-none" id="sum-stat-route">0</h3>
                                    <p class="text-[10px] text-blue-100 opacity-80 mt-1">Routes</p>
                                </div>
                                <div class="text-right">
                                    <h3 class="text-2xl font-bold leading-none" id="sum-stat-dist-route">0</h3>
                                    <p class="text-[10px] text-blue-100 opacity-80 mt-1">Total km.</p>
                                </div>
                            </div>
                        </div>
                        <i class="fa-solid fa-route absolute -bottom-4 -right-4 text-8xl text-white opacity-10"></i>
                    </div>
                    <div class="bg-gradient-to-br from-orange-500 to-orange-600 p-5 rounded-2xl shadow-lg text-white relative overflow-hidden">
                        <div class="relative z-10">
                            <p class="text-orange-100 text-xs font-bold uppercase mb-2 border-b border-orange-400 pb-1">SYMC Impacted</p>
                            <div class="flex justify-between items-end mb-1">
                                <div>
                                    <h3 class="text-3xl font-bold leading-none" id="sum-stat-impact">0</h3>
                                    <p class="text-[10px] text-orange-100 opacity-80 mt-1">Routes</p>
                                </div>
                                <div class="text-right">
                                    <h3 class="text-2xl font-bold leading-none" id="sum-stat-dist-impact">0</h3>
                                    <p class="text-[10px] text-orange-100 opacity-80 mt-1">Total km.</p>
                                </div>
                            </div>
                        </div>
                        <i class="fa-solid fa-triangle-exclamation absolute -bottom-4 -right-4 text-8xl text-white opacity-10"></i>
                    </div>
                    <div class="bg-gradient-to-br from-green-500 to-green-600 p-5 rounded-2xl shadow-lg text-white relative overflow-hidden">
                        <div class="relative z-10">
                            <p class="text-green-100 text-xs font-bold uppercase mb-2 border-b border-green-400 pb-1">Completed</p>
                            <div class="flex justify-between items-end mb-1">
                                <div>
                                    <h3 class="text-3xl font-bold leading-none" id="sum-stat-complete">0</h3>
                                    <p class="text-[10px] text-green-100 opacity-80 mt-1">Routes</p>
                                </div>
                                <div class="text-right">
                                    <h3 class="text-2xl font-bold leading-none" id="sum-stat-dist-complete">0</h3>
                                    <p class="text-[10px] text-green-100 opacity-80 mt-1">Total km.</p>
                                </div>
                            </div>
                        </div>
                        <i class="fa-solid fa-check-circle absolute -bottom-4 -right-4 text-8xl text-white opacity-10"></i>
                    </div>
                    <div class="bg-gradient-to-br from-yellow-400 to-yellow-500 p-5 rounded-2xl shadow-lg text-white relative overflow-hidden">
                        <div class="relative z-10">
                            <p class="text-yellow-50 text-xs font-bold uppercase mb-2 border-b border-yellow-300 pb-1">On Going</p>
                            <div class="flex justify-between items-end mb-1">
                                <div>
                                    <h3 class="text-3xl font-bold leading-none" id="sum-stat-ongoing">0</h3>
                                    <p class="text-[10px] text-yellow-50 opacity-80 mt-1">Routes</p>
                                </div>
                                <div class="text-right">
                                    <h3 class="text-2xl font-bold leading-none" id="sum-stat-dist-ongoing">0</h3>
                                    <p class="text-[10px] text-yellow-50 opacity-80 mt-1">Total km.</p>
                                </div>
                            </div>
                        </div>
                        <i class="fa-solid fa-person-digging absolute -bottom-4 -right-4 text-8xl text-white opacity-10"></i>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                        <h4 class="font-bold text-gray-700 mb-4 border-b pb-2">สัดส่วน Job Type (Job Type Distribution)</h4>
                        <div class="h-72"><canvas id="chartSumJobType"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                        <h4 class="font-bold text-gray-700 mb-4 border-b pb-2">สถานะงาน (Job Status Overview)</h4>
                        <div class="h-72"><canvas id="chartSumStatus"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- VIEW: SUBCONTRACTOR DASHBOARD (COST ADDED) -->
            <div id="view-sub-dashboard" class="view-section hidden w-full h-auto lg:h-full lg:overflow-y-auto overflow-visible pb-40">
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-200 mb-6 flex flex-wrap gap-4 items-end">
                     <div class="w-full sm:w-auto"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">หมวดงาน Subcontractor</label><select id="sub-filter-category" onchange="renderSubDashboardCharts()" class="w-full sm:w-48 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-orange-500"><option value="all">ทั้งหมด (All)</option><option value="sub_preventive">Preventive</option><option value="sub_reroute">Reroute</option><option value="sub_reconfigure">Reconfigure & Cancel OFC</option></select></div>
                    <div class="w-full sm:w-auto"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">ช่วงเวลา</label><div class="flex gap-2"><input type="date" id="sub-date-start" onchange="renderSubDashboardCharts()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm"><input type="date" id="sub-date-end" onchange="renderSubDashboardCharts()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm"></div></div>
                    <div class="w-full sm:w-auto ml-auto flex gap-2">
                        <button onclick="window.print()" class="print-hide px-4 py-2 bg-gray-600 text-white rounded-lg text-sm hover:bg-gray-700 shadow-md"><i class="fa-solid fa-print mr-1"></i> Print PDF</button>
                        <button onclick="renderSubDashboardCharts()" class="print-hide px-4 py-2 bg-orange-500 text-white rounded-lg text-sm hover:bg-orange-600 shadow-md"><i class="fa-solid fa-sync mr-1"></i> Update</button>
                    </div>
                </div>
                 <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-orange-500"><p class="text-gray-500 text-xs font-bold uppercase">Total Sub Jobs</p><h3 class="text-3xl font-bold text-gray-800 mt-1" id="sub-stat-total">0</h3></div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-green-500"><p class="text-gray-500 text-xs font-bold uppercase">Total Expenses</p><h3 class="text-3xl font-bold text-green-600 mt-1" id="sub-stat-cost">0 ฿</h3><p class="text-xs text-gray-400 mt-1">Estimate Cost</p></div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-blue-500"><p class="text-gray-500 text-xs font-bold uppercase">Active Subs</p><h3 class="text-3xl font-bold text-blue-600 mt-1" id="sub-stat-active">0</h3><p class="text-xs text-gray-400 mt-1">Teams with jobs</p></div>
                     <div class="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-purple-500"><p class="text-gray-500 text-xs font-bold uppercase">Avg Cost/Job</p><h3 class="text-3xl font-bold text-purple-600 mt-1" id="sub-stat-avg">0 ฿</h3></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6 break-inside-avoid">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                        <h4 class="font-bold text-gray-700 mb-4">สัดส่วนค่าใช้จ่ายตามสถานะ (Cost by Status)</h4>
                        <div class="h-64"><canvas id="chartSubCostStatus"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                        <h4 class="font-bold text-gray-700 mb-4">จำนวนงานและค่าใช้จ่ายผู้รับเหมา (Jobs & Cost per Subcontractor)</h4>
                        <div class="h-64"><canvas id="chartSubCount"></canvas></div>
                    </div>
                </div>
                 <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden break-inside-avoid">
                    <div class="p-4 border-b border-gray-100 bg-gray-50"><h4 class="font-bold text-gray-700">สรุปผลงานผู้รับเหมา (Subcontractor Performance Summary)</h4></div>
                    <div class="overflow-x-auto"><table class="w-full text-left text-sm"><thead class="bg-gray-100 text-gray-600 uppercase text-xs"><tr><th class="p-3">ชื่อผู้รับเหมา (Name)</th><th class="p-3 text-center">จำนวนงานรวม</th><th class="p-3 text-center">เสร็จสิ้น (Finish)</th><th class="p-3 text-right">ค่าใช้จ่ายรวม (Total Cost)</th></tr></thead><tbody id="table-sub-summary" class="divide-y divide-gray-100"></tbody></table></div>
                </div>
                <div class="h-24 w-full"></div>
            </div>

            <!-- VIEW: CALENDAR -->
            <div id="view-calendar" class="view-section hidden flex-1 flex flex-col overflow-visible lg:overflow-hidden h-auto lg:h-full">
                <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-200 h-[600px] lg:h-full flex flex-col overflow-hidden">
                     <div class="flex flex-col xl:flex-row justify-between items-center mb-4 flex-none gap-4">
                        <div class="flex items-center space-x-4">
                            <button onclick="changeCalendarPeriod(-1)" class="w-10 h-10 rounded-full hover:bg-gray-100 text-gray-600 transition flex items-center justify-center border border-gray-200 shadow-sm"><i class="fa-solid fa-chevron-left"></i></button>
                            <h2 id="calendar-month-year" class="text-xl md:text-2xl font-bold text-gray-800 w-64 text-center"></h2>
                            <button onclick="changeCalendarPeriod(1)" class="w-10 h-10 rounded-full hover:bg-gray-100 text-gray-600 transition flex items-center justify-center border border-gray-200 shadow-sm"><i class="fa-solid fa-chevron-right"></i></button>
                        </div>
                        
                        <div class="flex gap-2 flex-wrap justify-end">
                            <!-- Category Filter for Calendar -->
                            <select id="calendar-filter-category" onchange="renderCalendar()" class="border border-gray-300 rounded-lg px-3 py-1.5 text-sm focus:ring-2 focus:ring-brand-500 bg-white shadow-sm text-gray-700">
                                <option value="all">งานทั้งหมด (All)</option>
                                <option value="plan_interruption">Interruption Plan</option>
                                <option value="team">Interruption Team</option>
                                <option value="sub_preventive">Sub: Preventive</option>
                                <option value="sub_reroute">Sub: Reroute</option>
                                <option value="sub_reconfigure">Sub: Reconfigure & Cancel</option>
                            </select>

                            <!-- View Toggle Buttons -->
                            <div class="bg-gray-100 p-1 rounded-lg flex text-sm font-medium text-gray-500">
                                <button onclick="setCalendarView('month')" id="btn-view-month" class="px-4 py-1.5 rounded-md transition-all shadow-sm bg-white text-brand-600">Month</button>
                                <button onclick="setCalendarView('week')" id="btn-view-week" class="px-4 py-1.5 rounded-md transition-all hover:text-gray-700">Week</button>
                                <button onclick="setCalendarView('day')" id="btn-view-day" class="px-4 py-1.5 rounded-md transition-all hover:text-gray-700">Day</button>
                            </div>
                            <button onclick="jumpToToday()" class="px-4 py-1.5 bg-brand-500 text-white rounded-lg text-sm hover:bg-brand-600 shadow-md hover:shadow-lg transition font-medium flex items-center"><i class="fa-solid fa-calendar-day mr-2"></i> วันนี้</button>
                        </div>
                    </div>
                    
                    <!-- Calendar Header (Days) -->
                    <div id="calendar-header-days" class="grid grid-cols-7 gap-2 mb-2 text-center font-bold text-gray-500 text-sm flex-none uppercase tracking-wide">
                        <div class="text-red-500">อา</div><div>จ</div><div>อ</div><div>พ</div><div>พฤ</div><div>ศ</div><div class="text-brand-500">ส</div>
                    </div>
                    
                    <!-- Calendar Grid Container -->
                    <div id="calendar-days" class="flex-1 overflow-y-auto pr-1 grid gap-2"></div>
                </div>
            </div>
            
            <!-- VIEW: DATA TABLE -->
            <div id="view-datatable" class="view-section hidden flex-1 flex flex-col overflow-visible lg:overflow-hidden h-auto lg:h-full">
                
                <!-- PLAN DASHBOARD (NEW: 5 Boxes) -->
                <div id="plan-dashboard" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3 hidden mb-4 flex-none transition-all">
                    <!-- ... existing plan boxes ... -->
                    <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-blue-500"><p class="text-[10px] text-gray-500 uppercase font-bold tracking-wide">New Job</p><h3 id="plan-count-new" class="text-2xl font-bold text-blue-600">0</h3></div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-yellow-500"><p class="text-[10px] text-gray-500 uppercase font-bold tracking-wide">Inprocess</p><h3 id="plan-count-process" class="text-2xl font-bold text-yellow-600">0</h3></div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-green-500"><p class="text-[10px] text-gray-500 uppercase font-bold tracking-wide">Complete</p><h3 id="plan-count-complete" class="text-2xl font-bold text-green-600">0</h3></div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-cyan-600"><p class="text-[10px] text-gray-500 uppercase font-bold tracking-wide">Update FMS</p><h3 id="plan-count-updatefms" class="text-2xl font-bold text-cyan-700">0</h3></div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-red-500"><p class="text-[10px] text-gray-500 uppercase font-bold tracking-wide">Job Cancel</p><h3 id="plan-count-cancel" class="text-2xl font-bold text-red-600">0</h3></div>
                </div>

                <!-- NEW: SUMMARY PLAN JOB LIST DASHBOARD (4 Boxes) -->
                <div id="summary-plan-dashboard" class="grid grid-cols-2 sm:grid-cols-4 gap-4 hidden mb-4 flex-none transition-all">
                    <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-blue-500">
                        <div class="flex justify-between items-center">
                            <div><p class="text-xs text-gray-500 uppercase font-bold tracking-wide">New Job</p><h3 id="sum-list-new" class="text-2xl font-bold text-blue-600">0</h3></div>
                            <i class="fa-solid fa-file-circle-plus text-blue-100 text-3xl"></i>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-yellow-500">
                        <div class="flex justify-between items-center">
                            <div><p class="text-xs text-gray-500 uppercase font-bold tracking-wide">Inprocess</p><h3 id="sum-list-process" class="text-2xl font-bold text-yellow-600">0</h3></div>
                            <i class="fa-solid fa-person-digging text-yellow-100 text-3xl"></i>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-green-500">
                        <div class="flex justify-between items-center">
                            <div><p class="text-xs text-gray-500 uppercase font-bold tracking-wide">Complete</p><h3 id="sum-list-complete" class="text-2xl font-bold text-green-600">0</h3></div>
                            <i class="fa-solid fa-circle-check text-green-100 text-3xl"></i>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-red-500">
                        <div class="flex justify-between items-center">
                            <div><p class="text-xs text-gray-500 uppercase font-bold tracking-wide">Cancel</p><h3 id="sum-list-cancel" class="text-2xl font-bold text-red-600">0</h3></div>
                            <i class="fa-solid fa-ban text-red-100 text-3xl"></i>
                        </div>
                    </div>
                </div>

                <!-- SUB DASHBOARD -->
                <div id="sub-dashboard" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3 hidden mb-4 flex-none transition-all">
                    <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-blue-500"><p class="text-[10px] text-gray-500 uppercase font-bold tracking-wide">New Job</p><h3 id="sub-count-new" class="text-xl font-bold text-blue-600">0</h3><p class="text-[10px] text-gray-400 mt-1" id="sub-cost-new">0 ฿</p></div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-yellow-500"><p class="text-[10px] text-gray-500 uppercase font-bold tracking-wide">Inprocess</p><h3 id="sub-count-process" class="text-xl font-bold text-yellow-600">0</h3><p class="text-[10px] text-gray-400 mt-1" id="sub-cost-process">0 ฿</p></div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-purple-500"><p class="text-[10px] text-gray-500 uppercase font-bold tracking-wide">Assign Job</p><h3 id="sub-count-assign" class="text-xl font-bold text-purple-600">0</h3><p class="text-[10px] text-gray-400 mt-1" id="sub-cost-assign">0 ฿</p></div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-cyan-500"><p class="text-[10px] text-gray-500 uppercase font-bold tracking-wide">Approve Job</p><h3 id="sub-count-approve" class="text-xl font-bold text-cyan-600">0</h3><p class="text-[10px] text-gray-400 mt-1" id="sub-cost-approve">0 ฿</p></div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-green-500"><p class="text-[10px] text-gray-500 uppercase font-bold tracking-wide">Finish</p><h3 id="sub-count-finish" class="text-xl font-bold text-green-600">0</h3><p class="text-[10px] text-gray-400 mt-1" id="sub-cost-finish">0 ฿</p></div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-red-500"><p class="text-[10px] text-gray-500 uppercase font-bold tracking-wide">Job Cancel</p><h3 id="sub-count-cancel" class="text-xl font-bold text-red-600">0</h3><p class="text-[10px] text-gray-400 mt-1" id="sub-cost-cancel">0 ฿</p></div>
                </div>

                <!-- TEAM DASHBOARD -->
                <div id="team-dashboard" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 hidden mb-4 flex-none">
                    <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-blue-500 flex justify-between"><div><p class="text-xs text-gray-500 uppercase font-bold">New Job</p><h3 id="team-count-new" class="text-2xl font-bold text-blue-600">0</h3></div><i class="fa-solid fa-file-circle-plus text-blue-100 text-3xl"></i></div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-yellow-500 flex justify-between"><div><p class="text-xs text-gray-500 uppercase font-bold">Inprocess</p><h3 id="team-count-process" class="text-2xl font-bold text-yellow-600">0</h3></div><i class="fa-solid fa-spinner text-yellow-100 text-3xl"></i></div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-green-500 flex justify-between"><div><p class="text-xs text-gray-500 uppercase font-bold">Complete</p><h3 id="team-count-complete" class="text-2xl font-bold text-green-600">0</h3></div><i class="fa-solid fa-check-circle text-green-100 text-3xl"></i></div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-red-500 flex justify-between"><div><p class="text-xs text-gray-500 uppercase font-bold">Job Cancel</p><h3 id="team-count-cancel" class="text-2xl font-bold text-red-600">0</h3></div><i class="fa-solid fa-ban text-red-100 text-3xl"></i></div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 flex-none lg:flex-1 flex flex-col overflow-hidden h-auto lg:h-full">
                    <div class="p-6 flex-none border-b border-gray-100">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                            <div class="flex items-center">
                                <h3 id="table-header" class="text-xl font-bold text-gray-800 flex items-center"><i class="fa-solid fa-list-ul mr-2 text-brand-500"></i> รายการงาน</h3>
                                <span id="table-grand-total" class="ml-4 px-3 py-1 bg-green-100 text-green-700 text-xs font-bold rounded-full hidden">Total: 0 ฿</span>
                            </div>
                            <div class="flex space-x-2"><button onclick="exportExcel()" class="px-4 py-2 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 transition flex items-center text-sm font-medium"><i class="fa-solid fa-file-excel mr-2"></i> Export</button><button onclick="openModal()" class="px-4 py-2 bg-brand-500 text-white rounded-lg shadow hover:bg-brand-600 transition flex items-center text-sm font-medium"><i class="fa-solid fa-plus mr-2"></i> เพิ่มงาน</button></div>
                        </div>
                        <div class="flex flex-wrap gap-3 items-center bg-gray-50 p-3 rounded-xl border border-gray-100"><div class="flex-1 min-w-[200px] relative"><i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-gray-400"></i><input type="text" id="search-input" placeholder="ค้นหา Job ID, รายละเอียด..." class="w-full border border-gray-300 rounded-lg pl-10 pr-4 py-2 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 text-sm transition"></div><select id="filter-status" onchange="renderTable()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-brand-500 bg-white"><option value="all">สถานะทั้งหมด</option><option value="new">New Job</option><option value="process">Inprocess</option><option value="assign">Assign</option><option value="approve">Approve</option><option value="finish">Finish</option><option value="complete">Complete</option><option value="update_fms">Update FMS</option><option value="cancel">Cancel</option></select></div>
                    </div>
                    <div class="flex-1 overflow-auto bg-white relative"><table class="w-full text-left border-collapse min-w-[1200px]" id="data-table"><thead class="bg-gray-50 text-gray-600 text-xs uppercase sticky top-0 z-10 shadow-sm font-semibold tracking-wider"><tr id="table-header-row"></tr></thead><tbody id="table-body" class="text-xs divide-y divide-gray-100"></tbody></table><div id="empty-state" class="hidden py-20 text-center text-gray-400 absolute inset-0 flex items-center justify-center flex-col pointer-events-none"><i class="fa-regular fa-folder-open text-5xl mb-4 text-gray-300"></i><p class="text-sm font-medium">ไม่พบข้อมูลในระบบ</p></div></div>
                    <div class="flex-none p-4 border-t border-gray-100 bg-gray-50 flex justify-between items-center text-xs text-gray-500">
                        <div class="flex items-center gap-2">Rows per page: 
                            <select id="rows-per-page" onchange="changeRowsPerPage()" class="border rounded p-1 bg-white focus:outline-none focus:ring-2 focus:ring-brand-500">
                                <option value="10">10</option>
                                <option value="20">20</option>
                                <option value="30">30</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                                <option value="all">All</option>
                            </select>
                        </div>
                        <div id="pagination-controls" class="flex items-center gap-2"></div><div id="pagination-info"></div>
                    </div>
                </div>
            </div>
            
            <!-- SETTING View -->
            <div id="view-setting" class="view-section hidden flex-1 flex flex-col overflow-auto">
                <div class="max-w-6xl mx-auto w-full space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 flex flex-col md:flex-row justify-between items-center gap-4"><div><h3 class="text-2xl font-bold text-gray-800 flex items-center"><i class="fa-solid fa-database mr-3 text-brand-500"></i> ฐานข้อมูล (Master Data)</h3><p class="text-sm text-gray-500 mt-1">จัดการเฉพาะข้อมูล Subcontractor และ NS Respond</p></div><button onclick="confirmClearDatabase()" class="px-5 py-2.5 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 text-sm font-medium border border-red-200 transition flex items-center shadow-sm"><i class="fa-solid fa-trash-can mr-2"></i> ล้างข้อมูลทั้งหมด (Reset Database)</button></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 flex flex-col"><h4 class="font-bold text-gray-800 mb-4 pb-3 border-b border-gray-100 flex items-center"><i class="fa-solid fa-helmet-safety text-orange-500 mr-2"></i> Subcontractors (Round Robin)</h4><div class="flex gap-2 mb-4"><input type="text" id="add-sub" class="flex-1 border border-gray-300 rounded-lg px-4 py-2 text-sm focus:border-brand-500 focus:outline-none" placeholder="ชื่อทีม..."><button onclick="addSettingItem('subcontractors', 'add-sub')" class="bg-brand-500 text-white px-4 rounded-lg hover:bg-brand-600 shadow-md transition"><i class="fa-solid fa-plus"></i></button></div><ul id="list-subcontractors" class="space-y-2 overflow-y-auto flex-1 max-h-64 pr-2 scrollbar-thin"></ul></div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 flex flex-col"><h4 class="font-bold text-gray-800 mb-4 pb-3 border-b border-gray-100 flex items-center"><i class="fa-solid fa-user-tag text-blue-500 mr-2"></i> NS Respond</h4><div class="flex gap-2 mb-4"><input type="text" id="add-ns-name" class="flex-1 border border-gray-300 rounded-lg px-4 py-2 text-sm focus:border-blue-500 focus:outline-none" placeholder="ชื่อ..."><input type="text" id="add-ns-phone" class="w-28 border border-gray-300 rounded-lg px-4 py-2 text-sm focus:border-blue-500 focus:outline-none" placeholder="โทร..."><button onclick="addNSRespond()" class="bg-blue-500 text-white px-4 rounded-lg hover:bg-blue-600 shadow-md transition"><i class="fa-solid fa-plus"></i></button></div><ul id="list-nsRespond" class="space-y-2 overflow-y-auto flex-1 max-h-64 pr-2 scrollbar-thin"></ul></div>
                    </div>
                </div>
            </div>

            <!-- VIEW: LINK SUPPORT (NEW) -->
            <div id="view-link-support" class="view-section hidden flex-1 flex flex-col overflow-auto">
                <div class="max-w-7xl mx-auto w-full p-4 md:p-6 space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                        <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                            <span class="bg-brand-100 text-brand-600 p-2 rounded-lg mr-3 shadow-sm"><i class="fa-solid fa-link"></i></span> Link Support Center
                        </h3>
                        
                        <!-- Add/Edit Form -->
                        <div class="bg-gray-50 p-5 rounded-xl border border-gray-100 mb-6 shadow-inner">
                            <label class="block text-sm font-bold text-gray-600 mb-3 uppercase tracking-wide">จัดการลิงก์ (Manage Links)</label>
                            
                            <!-- Hidden input to store index for editing -->
                            <input type="hidden" id="ls-edit-index" value="">

                            <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-start">
                                <div class="md:col-span-2">
                                    <label class="block text-xs text-gray-500 mb-1">ชื่อเว็บไซต์ (Name) <span class="text-red-500">*</span></label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400"><i class="fa-solid fa-tag"></i></div>
                                        <input type="text" id="ls-name" class="w-full pl-10 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition" placeholder="ชื่อเว็บ...">
                                    </div>
                                </div>
                                <div class="md:col-span-3">
                                    <label class="block text-xs text-gray-500 mb-1">URL (Address) <span class="text-red-500">*</span></label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400"><i class="fa-solid fa-globe"></i></div>
                                        <input type="url" id="ls-url" class="w-full pl-10 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition" placeholder="https://...">
                                    </div>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-xs text-gray-500 mb-1">ประเภท (Type) <span class="text-red-500">*</span></label>
                                    <select id="ls-type" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500 bg-white">
                                        <option value="">เลือก...</option>
                                        <option value="Site Access">Site Access</option>
                                        <option value="Link Support">Link Support</option>
                                        <option value="Link File Shared">Link File Shared</option>
                                        <option value="Other">Other</option>
                                    </select>
                                    <input type="text" id="ls-type-other" class="w-full mt-2 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500 hidden bg-white" placeholder="ระบุประเภทอื่นๆ...">
                                </div>
                                <div class="md:col-span-3">
                                    <label class="block text-xs text-gray-500 mb-1">รายละเอียด (Detail)</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400"><i class="fa-solid fa-circle-info"></i></div>
                                        <input type="text" id="ls-detail" class="w-full pl-10 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition" placeholder="คำอธิบายเพิ่มเติม...">
                                    </div>
                                </div>
                                <div class="md:col-span-2 flex gap-2 mt-6 md:mt-0 items-end h-full pb-0.5">
                                    <button onclick="saveLinkItem()" id="btn-save-link" class="flex-1 bg-brand-500 text-white px-4 py-2 rounded-lg hover:bg-brand-600 shadow-md transition font-medium text-sm flex items-center justify-center h-[38px]">
                                        <i class="fa-solid fa-plus mr-1"></i> เพิ่ม
                                    </button>
                                    <button onclick="cancelLinkEdit()" id="btn-cancel-link" class="hidden bg-gray-300 text-gray-700 px-3 py-2 rounded-lg hover:bg-gray-400 shadow-sm transition font-medium text-sm h-[38px]">
                                        ยกเลิก
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Search Bar & Filter -->
                        <div class="mb-4 flex flex-col md:flex-row gap-3">
                            <div class="flex-1 relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400"><i class="fa-solid fa-magnifying-glass"></i></div>
                                <input type="text" id="ls-search" oninput="renderLinkSupport()" class="w-full pl-10 border border-gray-300 rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition" placeholder="ค้นหาชื่อเว็บไซต์, URL, ประเภท หรือรายละเอียด...">
                            </div>
                            <div class="w-full md:w-48">
                                <select id="ls-filter-type" onchange="renderLinkSupport()" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500 bg-white">
                                    <option value="all">ทุกประเภท (All Types)</option>
                                    <option value="Site Access">Site Access</option>
                                    <option value="Link Support">Link Support</option>
                                    <option value="Link File Shared">Link File Shared</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>

                        <!-- Link List Table -->
                        <div class="overflow-x-auto border border-gray-200 rounded-xl shadow-sm">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider w-1/5">ชื่อเว็บไซต์ (Name)</th>
                                        <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider w-1/5">URL (Address)</th>
                                        <th scope="col" class="px-6 py-4 text-center text-xs font-bold text-gray-500 uppercase tracking-wider w-1/6">Link Type</th>
                                        <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">รายละเอียด (Detail)</th>
                                        <th scope="col" class="px-6 py-4 text-right text-xs font-bold text-gray-500 uppercase tracking-wider w-28">จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody id="list-link-support" class="bg-white divide-y divide-gray-200">
                                    <!-- Items will be injected here -->
                                </tbody>
                            </table>
                            <div id="ls-empty-state" class="hidden py-12 text-center flex flex-col items-center justify-center text-gray-400 bg-white">
                                <div class="bg-gray-100 p-4 rounded-full mb-3"><i class="fa-solid fa-link-slash text-2xl text-gray-300"></i></div>
                                <p class="text-sm">ยังไม่มีรายการลิงก์ในระบบ</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- ASSIGNMENT MODAL -->
    <div id="assignment-modal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-900 bg-opacity-60 transition-opacity backdrop-blur-sm" onclick="closeModal()"></div>
            <div class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl w-full border border-gray-100">
                <form id="assignment-form" onsubmit="return false;">
                    <div class="bg-white px-8 py-6">
                        <div class="flex justify-between items-center border-b border-gray-100 pb-4 mb-6"><h3 class="text-2xl font-bold text-gray-800 flex items-center" id="modal-title"><span class="bg-brand-100 text-brand-600 p-2 rounded-lg mr-3"><i class="fa-solid fa-pen-to-square"></i></span> บันทึกงานใหม่</h3><span id="display-internal-id" class="px-3 py-1 bg-gray-100 text-gray-600 rounded-lg text-sm font-mono font-bold border border-gray-200">Auto ID</span></div>
                        <input type="hidden" id="doc-id" name="docId"><input type="hidden" id="form-internal-id" name="internalId"><input type="hidden" id="form-category" name="category"><input type="hidden" id="form-file-url" name="fileUrl"><input type="hidden" id="form-file-name" name="fileName">
                        
                        <!-- แก้ไข HTML: ปรับปรุงส่วน Round Robin ให้รองรับ Special Job -->
                        <div class="group-sub hidden mb-6">
                            <div class="rr-box border border-orange-200 rounded-xl p-4 bg-orange-50 mb-6 shadow-sm relative">
                                <!-- ส่วนแสดงผล Round Robin ปกติ -->
                                <div id="rr-normal-view">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <p class="rr-label text-gray-500 text-xs font-bold uppercase mb-1">ทีมก่อนหน้า (Previous)</p>
                                            <div class="flex flex-col">
                                                <p class="text-xl font-bold text-gray-400 mr-2" id="rr-prev-name">-</p>
                                                <p class="text-xs text-gray-400 truncate max-w-[200px]" id="rr-prev-job">Job: -</p>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <p class="rr-label text-brand-600 text-xs font-bold uppercase mb-1">ทีมที่ได้รับงานนี้ (Current)</p>
                                            <p class="text-4xl font-extrabold text-brand-600" id="rr-next-name">-</p>
                                            <div class="mt-3 flex justify-end gap-2" id="rr-action-buttons">
                                                <button type="button" onclick="skipRoundRobin()" class="text-xs bg-white border border-gray-200 hover:bg-gray-50 text-gray-600 px-3 py-1.5 rounded-lg shadow-sm transition"><i class="fa-solid fa-forward mr-1"></i> ข้าม (Skip)</button>
                                                <button type="button" onclick="resetRoundRobin()" class="text-xs bg-white border border-red-200 hover:bg-red-50 text-red-600 px-3 py-1.5 rounded-lg shadow-sm transition"><i class="fa-solid fa-rotate-left mr-1"></i> เริ่มใหม่ (Reset)</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- ส่วนแสดงผลสำหรับ Special Job (เลือกเอง) -->
                                <div id="rr-special-view" class="hidden">
                                    <label class="block text-sm font-bold text-brand-700 mb-2 flex items-center">
                                        <i class="fa-solid fa-star text-yellow-500 mr-2"></i> เลือกผู้รับเหมา (Special Job)
                                    </label>
                                    <select id="form-manual-sub" class="w-full border border-orange-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-brand-500 focus:outline-none bg-white" onchange="$('#form-sub-name').val(this.value)">
                                        <option value="">เลือกผู้รับเหมา...</option>
                                    </select>
                                    <p class="text-xs text-gray-500 mt-2">* งาน Special Job จะไม่ถูกนำไปคำนวณในระบบวนคิว (Round Robin)</p>
                                </div>

                                <!-- Hidden Input เก็บค่าผู้รับเหมาจริงที่จะบันทึก -->
                                <input type="hidden" id="form-sub-name">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                            <div class="plan-only hidden"><label>Interruption ID - CM</label><input type="text" id="form-interruption-id-cm" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm"></div>
                            <div class="plan-only hidden"><label>Project</label><select id="form-project" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm"><option value="">เลือก Project...</option></select><input type="text" id="form-project-other" class="w-full border border-gray-300 rounded-lg p-2.5 mt-2 text-sm other-input" placeholder="ระบุอื่นๆ..."></div>
                            <div><label>Job Type <span class="text-red-500">*</span></label><select id="form-job-type" name="jobType" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm" required><option value="">เลือก...</option></select><input type="text" id="form-job-type-other" class="w-full border border-gray-300 rounded-lg p-2.5 mt-2 text-sm other-input" placeholder="ระบุอื่นๆ..."></div>
                            <div class="col-span-1 md:col-span-2 summary-plan-hide"><label>Description <span class="text-red-500">*</span></label><input type="text" id="form-desc" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm" placeholder="รายละเอียดงาน"></div>
                            <div class="summary-plan-hide">
                                <label id="label-agency">Agency Inf. <span class="text-red-500">*</span></label>
                                <select id="form-agency" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm"></select>
                                <input type="text" id="form-agency-other" class="w-full border border-gray-300 rounded-lg p-2.5 mt-2 text-sm other-input" placeholder="ระบุอื่นๆ...">
                            </div>
                            
                            <div class="not-plan-only summary-plan-hide"><label>Action Date <span class="text-red-500">*</span></label><input type="datetime-local" id="form-action-date" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm"></div>
                            
                            <!-- Summary Plan Fields -->
                            <div class="summary-plan-only hidden"><label>รหัสเส้นทาง (Route Code)</label><input type="text" id="form-route-code" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm" placeholder="ใส่หรือไม่ใส่ก็ได้"></div>
                            <div class="summary-plan-only hidden"><label>ไฟฟ้าเขต (Electric District)</label><input type="text" id="form-electric-district" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm"></div>
                            <div class="summary-plan-only hidden col-span-1 md:col-span-2"><label>ชื่อเส้นทาง (Route Name)</label><input type="text" id="form-route-name" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm"></div>
                            <div class="summary-plan-only hidden"><label>จำนวนฝั่ง (Side Count)</label><select id="form-side-count" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm"><option value="">เลือก...</option></select></div>
                            <div class="summary-plan-only hidden"><label>จุดเริ่ม GPS (Start GPS)</label><input type="text" id="form-gps-start" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm" placeholder="ใส่หรือไม่ใส่ก็ได้"></div>
                            <div class="summary-plan-only hidden"><label>จุดสิ้นสุด GPS (End GPS)</label><input type="text" id="form-gps-end" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm" placeholder="ใส่หรือไม่ใส่ก็ได้"></div>
                            <div class="summary-plan-only hidden"><label>ระยะทาง (กม.)</label><input type="number" step="0.01" id="form-distance" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm"></div>
                            <div class="summary-plan-only hidden"><label>OWNER (บริษัทที่รับผิดชอบ)</label><input type="text" id="form-owner" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm"></div>
                            <div class="summary-plan-only hidden col-span-1 md:col-span-2"><label>ข้อกำหนดแนวข้าม (Cross Req)</label><input type="text" id="form-cross-req" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm" placeholder="ใส่หรือไม่ใส่ก็ได้"></div>
                            <div class="summary-plan-only hidden"><label>Due Date (วันตัดสาย)</label><input type="date" id="form-due-date-summary" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm"></div>

                            <div class="plan-only hidden"><label>Action Date (วันที่ปฏิบัติงาน)</label><input type="date" id="form-plan-date" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm"></div>
                            <div class="plan-only hidden grid grid-cols-2 gap-2">
                                <div><label>Start Time</label><input type="time" id="form-plan-start" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm"></div>
                                <div><label>End Time</label><input type="time" id="form-plan-end" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm"></div>
                            </div>
                            <div class="plan-only hidden"><label>Sent Plan Date (วันที่ส่งแผน)</label><input type="date" id="form-sent-plan-date" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm"></div>
                            <div class="plan-only hidden col-span-1 md:col-span-2"><label>Unplanned Impact</label><input type="text" id="form-unplanned-impact" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm" placeholder="ระบุผลกระทบ..."></div>
                            
                            <div class="plan-only hidden"><label>Interruption Item (ลูกค้าที่กระทบ)</label><input type="number" id="form-interruption-item" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm" min="0" placeholder="0"></div>
                            <div class="team-only"><label>Due Date</label><input type="date" id="form-due-date" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm"></div>
                            <div class="group-sub hidden"><label>Due Date</label><input type="date" id="form-due-date-sub" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm"></div>
                            <div class="team-only hidden plan-only hidden"><label>Team Request</label><select id="form-team-req" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm"></select><input type="text" id="form-team-req-other" class="w-full border border-gray-300 rounded-lg p-2.5 mt-2 text-sm other-input" placeholder="ระบุทีมอื่นๆ..."></div>
                            <div class="team-only hidden"><label>Req Person</label><input type="number" id="form-req-person" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm" min="1" value="1"></div>
                            <div class="team-only hidden"><label>Ref Job ID</label><input type="text" id="form-ref-job-id" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm"></div>
                            <div class="group-sub hidden"><label>รายละเอียดราคา (Objective)</label><input type="text" id="form-objective" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm"></div>
                            <div class="group-sub hidden"><label>ราคาประมาณการ (Expenses)</label><input type="number" id="form-expenses" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm"></div>
                            <div class="group-sub hidden"><label>Route Code</label><input type="text" id="form-route-code-sub" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm"></div>
                            <div class="col-span-1 md:col-span-2 summary-plan-hide"><label>Location / Road</label><input type="text" id="form-location" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm"></div>
                            
                            <!-- Summary Plan Region Section Header & Fields -->
                            <div class="summary-plan-only hidden col-span-full border-t border-gray-200 pt-4 mt-2"><h4 class="font-bold text-gray-700 text-sm mb-2">// ส่วนของ Region ลงข้อมูล //</h4></div>
                            <div class="summary-plan-only hidden">
                                <label>Sym Impact</label>
                                <select id="form-sym-impact" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm">
                                    <option value="">เลือก...</option>
                                    <option value="Impact">Impact</option>
                                    <option value="Non Impact">Non Impact</option>
                                    <option value="Other">Other</option>
                                </select>
                                <input type="text" id="form-sym-impact-other" class="w-full border border-gray-300 rounded-lg p-2.5 mt-2 text-sm other-input" placeholder="ระบุเพิ่มเติม...">
                            </div>

                            <div class="row-span-2"><label>NS Respond (ผู้รับผิดชอบ)</label><select id="form-ns-respond" class="select2 w-full border border-gray-300 rounded-lg p-2.5 text-sm" multiple="multiple" style="width: 100%;"></select></div>
                            <div class="col-span-1 md:col-span-2 not-plan-only summary-plan-hide"><label>GPS (Multi-line)</label><textarea id="form-gps" rows="3" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm" placeholder="วางพิกัดได้หลายบรรทัด"></textarea><button type="button" onclick="getLocation()" class="text-brand-500 text-xs mt-1 hover:underline"><i class="fa-solid fa-location-crosshairs"></i> Get Location</button></div>
                            <div class="col-span-1 md:col-span-2 summary-plan-hide"><label>Remark</label><input type="text" id="form-remark" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm"></div>
                            
                            <div class="col-span-1 md:col-span-3 not-plan-only summary-plan-hide"><label>Image/File แนบรูปหรือไฟล์</label><div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:bg-brand-50 hover:border-brand-300 cursor-pointer relative bg-gray-50 transition group"><input type="file" id="form-file" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx"><div class="flex flex-col items-center"><i class="fa-solid fa-cloud-arrow-up text-3xl text-gray-400 group-hover:text-brand-500 mb-2 transition"></i><p class="text-sm text-gray-600 font-medium" id="file-name-display">คลิกเพื่อเลือกไฟล์ หรือลากไฟล์มาวางที่นี่</p></div></div><div id="existing-file-link" class="mt-2 text-xs text-brand-600 hidden font-medium flex items-center"><i class="fa-solid fa-paperclip mr-1"></i> <a href="#" target="_blank" class="hover:underline">ดูไฟล์เดิม</a></div></div>
                            
                            <!-- Actions Copy for Summary Plan -->
                            <div id="summary-copy-actions" class="hidden col-span-full flex gap-2 justify-end">
                                <!-- ... placeholder for future actions ... -->
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 px-8 py-5 sm:flex sm:flex-row-reverse border-t border-gray-100">
                        <button type="button" onclick="performSave()" class="w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-6 py-2.5 bg-brand-600 text-base font-medium text-white hover:bg-brand-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm transition"><i class="fa-solid fa-save mr-2 mt-0.5"></i> บันทึกข้อมูล</button>
                        <button type="button" onclick="closeModal()" class="mt-3 w-full inline-flex justify-center rounded-lg border border-gray-300 shadow-sm px-6 py-2.5 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm transition">ยกเลิก</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
       // === GLOBAL SETUP ===
       const firebaseConfig = {
			   apiKey: "AIzaSyBY0ZewKLp8MJbkq2xxcQ2Z_cz7p04e0EY",
			   authDomain: "assignment-interruption-final.firebaseapp.com",
			   projectId: "assignment-interruption-final",
			   storageBucket: "assignment-interruption-final.firebasestorage.app",
			   messagingSenderId: "578868197362",
			   appId: "1:578868197362:web:09649a591443922fe69d6b"
				};
				
		const appId = 'assignment-app'; 
		
        let auth, db; 
        try { 
            firebase.initializeApp(firebaseConfig); 
            auth = firebase.auth(); 
            db = firebase.firestore(); 
        } catch (e) { 
            console.error("Firebase Init Error:", e); 
        }
        
        const GAS_URL = "https://script.google.com/macros/s/AKfycbx5KFStUdu_gJ-FmB99YluYydM6ObImyUqrF2vGh6DO1gCAK5JWIxz5AGG40B_iViiULQ/exec";

        let assignments = [];
        let masterData = {};
        let currentView = 'calendar';
        let currentCategoryFilter = 'all';
        let rrState = { next: null, prev: null };
        let currentPage = 1;
        let rowsPerPage = 10;
        let filteredData = [];
        let charts = {}; // <--- Adding this
        
        // Calendar State
        let currentCalendarDate = new Date();
        let calendarViewMode = 'month'; // 'month', 'week', 'day'
        let currentMonth = new Date().getMonth(); // Legacy support if needed
        let currentYear = new Date().getFullYear(); // Legacy support if needed

        const CONST_DATA = { 
            projects: [ "MEA", "PEA", "NBTC", "Sky Train", "Bangkok Metropolis", "BTS", "MRT", "NT", "Customer", "Department Of Highways", "Department Of Rural Road", "Landlord", "Local Authorty", "Motorway", "State Railway OF Thailand", "Underground", "MOI", "Noah", "DWDM", "OLT and ONU", "Site Relocation", "Fiber Infra Sharing", "Improvement", "Migration","Other" ], 
            agencies: [ "MEA", "PEA", "NBTC", "Sky Train", "NPD", "SQM", "Region", "NOC", "SQI", "ROW", "Landlord", "TPD", "Customer", "Bangkok Metropolis", "BTS", "MRT", "NT", "Motorway", "Department Of Highways", "Department Of Rural Road", "Other" ],
            teamRequests: [ "NOC", "HelpDesk", "TPD", "NPD", "SQM", "SQI", "Sale", "Region BKK", "Cores Network", "Landlord", "SDM", "Region Provincial", "ROW", "Other" ], 
            sideCounts: ["1 ฝั่ง", "2 ฝั่ง"],
            jobTypes: { 
                team: ["Improvement", "Create Route", "Meeting", "Team Daily", "Support", "Other"], 
                plan: ["Interruption OFC", "Interruption Equipment", "Information", "Other"], 
                summary_plan: ["MEA", "PEA","MOI","Sky Trai","Bangkok Metropolis","Department Of Highways","Landlord","Underground","Fiber Infra Sharing", "Other"],
                // แก้ไข: เพิ่ม "Special Job" ในรายการ
                preventive: ["Preventive มัดรวบสาย", "Preventive ย้ายแนวสาย", "Preventive เข้าคอนใหม่", "Preventive ติดสติ๊กเกอร์", "Preventive รื้อถอนสายตาย", "Preventive Stand by", "Preventive ทำความสะอาดSite","Preventive งานร้องเรียน", "Special Job", "Other"], 
                reroute: ["Reroute Project", "Underground", "MOI", "Reconfig for Reroute", "Special Job", "Other"], 
                reconfigure: ["Reconfig high loss", "Reconfig New Route","Cancle OFC","Special Job", "Other"] 
            } 
        };
        const menuConfig = { 'plan_interruption': { title: 'Interruption Plan', isSub: false, isPlan: true, prefix: 'IP', jobTypeKey: 'plan', sheetName: 'Interruption Plan' }, 'summary_plan': { title: 'Project Plan', isSub: false, isPlan: true, prefix: 'Sum', jobTypeKey: 'summary_plan', sheetName: 'Summary Plan' }, 'team': { title: 'Assignment Interruption Team', isSub: false, prefix: 'AI', jobTypeKey: 'team', sheetName: 'Interruption Team' }, 'sub_preventive': { title: 'Assignment Preventive', isSub: true, prefix: 'PVT', jobTypeKey: 'preventive', sheetName: 'Assignment Preventive' }, 'sub_reroute': { title: 'Assignment Reroute', isSub: true, prefix: 'RER', jobTypeKey: 'reroute', sheetName: 'Assignment Reroute' }, 'sub_reconfigure': { title: 'Assignment Reconfigure & Cancel', isSub: true, prefix: 'REF', jobTypeKey: 'reconfigure', sheetName: 'Assignment Reconfigure' }, 'dashboard_analytics': { title: 'Dashboard Analytics', isSub: false, isPlan: false, prefix: 'DB', jobTypeKey: 'team' }, 'sub_dashboard': { title: 'Dashboard Subcontractor', isSub: false, isPlan: false, prefix: 'DBS', jobTypeKey: 'preventive' } };

        function getAssignmentsRef() { return db ? db.collection('assignments') : null; }
        function getSettingsRef() { return db ? db.collection('settings').doc('masterData') : null; }
        
        function fmtDate(s, d) { if(!s) return '-'; let dt; if(s.seconds) dt = new Date(s.seconds*1000); else dt=new Date(s); if(isNaN(dt.getTime())) return '-'; const day=dt.getDate(), m=dt.getMonth()+1, y=dt.getFullYear()+543, h=String(dt.getHours()).padStart(2,'0'), mn=String(dt.getMinutes()).padStart(2,'0'); return d ? `${day}/${m}/${y}` : `${day}/${m}/${y} ${h}:${mn}`; }
        function extractNS(d) { const a=Array.isArray(d)?d:(d?[d]:[]); const names=[], phones=[]; a.forEach(s=>{ if(s.includes(' - ')){ const p=s.split(' - '); names.push(p[0]); phones.push(p[1]); } else { names.push(s); } }); return {names:names.join(', '), phones:phones.join(', ') || '-'}; }
        function extractGPS(g) { const lines = (g||'').split('\n'); return {start: lines[0]||'-', end: lines[1]||'-'}; }

        // === FUNCTION DEFINITIONS ===

        // === CALENDAR FUNCTIONS (REFACTORED) ===
        window.setCalendarView = function(mode) {
            calendarViewMode = mode;
            // Update buttons styling
            ['month', 'week', 'day'].forEach(m => {
                const btn = $(`#btn-view-${m}`);
                if (m === mode) {
                    btn.addClass('bg-white text-brand-600 shadow-sm').removeClass('hover:text-gray-700');
                } else {
                    btn.removeClass('bg-white text-brand-600 shadow-sm').addClass('hover:text-gray-700');
                }
            });
            window.renderCalendar();
        };

        window.changeCalendarPeriod = function(step) {
            if (calendarViewMode === 'month') {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + step);
            } else if (calendarViewMode === 'week') {
                currentCalendarDate.setDate(currentCalendarDate.getDate() + (step * 7));
            } else { // day
                currentCalendarDate.setDate(currentCalendarDate.getDate() + step);
            }
            // Sync legacy vars just in case
            currentMonth = currentCalendarDate.getMonth();
            currentYear = currentCalendarDate.getFullYear();
            window.renderCalendar();
        };

        window.jumpToToday = function() {
            currentCalendarDate = new Date();
            currentMonth = currentCalendarDate.getMonth();
            currentYear = currentCalendarDate.getFullYear();
            window.renderCalendar();
        };

        window.renderCalendar = function() {
            const container = document.getElementById("calendar-days");
            const headerRow = document.getElementById("calendar-header-days");
            if (!container) return;
            container.innerHTML = "";

            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            const thaiMonths = ["มกราคม","กุมภาพันธ์","มีนาคม","เมษายน","พฤษภาคม","มิถุนายน","กรกฎาคม","สิงหาคม","กันยายน","ตุลาคม","พฤศจิกายน","ธันวาคม"];
            const shortThaiMonths = ["ม.ค.","ก.พ.","มี.ค.","เม.ย.","พ.ค.","มิ.ย.","ก.ค.","ส.ค.","ก.ย.","ต.ค.","พ.ย.","ธ.ค."];

            // Helper to render jobs
            const getJobsForDate = (dateStr) => {
                const catFilter = $('#calendar-filter-category').val();
                
                return assignments.filter(a => {
                    const isDateMatch = (a.actionDate||'').startsWith(dateStr);
                    const isStatusValid = a.status!=='new' && a.status!=='cancel';
                    const isTypeValid = a.category !== 'summary_plan';
                    
                    if (!isDateMatch || !isStatusValid || !isTypeValid) return false;
                    
                    // Filter by Category
                    if (catFilter && catFilter !== 'all') {
                        return a.category === catFilter;
                    }
                    return true;
                }).sort((a,b) => (a.actionDate||'').localeCompare(b.actionDate||''));
            };

            const createJobHTML = (j, isCompact = true) => {
                let cl = j.status==='process'?'bg-yellow-100 text-yellow-800 border-yellow-200':(j.status==='finish'||j.status==='complete'?'bg-green-100 text-green-800 border-green-200':'bg-gray-100 border-gray-200');
                const time = j.actionDate.split('T')[1].slice(0,5);
                
                if (isCompact) {
                    return `<div class="text-[10px] ${cl} border rounded px-1.5 py-0.5 mb-1 truncate cursor-pointer hover:shadow-md transition" onclick="showJobDetail('${j.id}'); event.stopPropagation();" title="${j.description}">
                        <b>${time}</b> ${j.internalId}
                    </div>`;
                } else {
                    // Detailed card for Week/Day view
                    return `<div class="flex flex-col ${cl} border rounded-lg p-2 mb-2 cursor-pointer hover:shadow-md transition relative group" onclick="showJobDetail('${j.id}'); event.stopPropagation();">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-bold text-xs bg-white bg-opacity-50 px-1 rounded">${time}</span>
                            <span class="text-[10px] font-mono opacity-70">${j.internalId}</span>
                        </div>
                        <div class="text-xs font-semibold truncate leading-tight">${j.description}</div>
                        <div class="text-[10px] mt-1 opacity-80 truncate"><i class="fa-solid fa-user-tag mr-1"></i>${(j.subcontractor || j.teamReq || '-')}</div>
                        <div class="absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-magnifying-glass-plus text-gray-500"></i></div>
                    </div>`;
                }
            };

            if (calendarViewMode === 'month') {
                // === MONTH VIEW ===
                $('#calendar-month-year').text(`${thaiMonths[month]} ${year + 543}`);
                if(headerRow) headerRow.classList.remove('hidden');
                container.className = "grid grid-cols-7 gap-2 flex-1 overflow-y-auto custom-scrollbar content-start"; // Fixed grid

                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                for(let i=0; i<firstDay; i++) container.appendChild(document.createElement("div"));
                
                for(let i=1; i<=daysInMonth; i++) {
                    const ds = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                    const jobs = getJobsForDate(ds);
                    const el = document.createElement("div"); 
                    
                    // Highlight today
                    const today = new Date();
                    const isToday = i === today.getDate() && month === today.getMonth() && year === today.getFullYear();
                    const borderClass = isToday ? "border-brand-500 ring-1 ring-brand-200" : "border-gray-200";
                    const bgClass = isToday ? "bg-brand-50" : "bg-white";

                    el.className = `calendar-day relative min-h-[100px] border rounded-xl p-1 hover:bg-gray-50 overflow-hidden flex flex-col ${borderClass} ${bgClass}`;
                    
                    let h = ''; jobs.forEach(j => h += createJobHTML(j, true));
                    el.innerHTML = `<div class="text-right text-xs font-bold ${isToday ? 'text-brand-600' : 'text-gray-400'} mb-1 mr-1">${i}</div><div class="overflow-y-auto flex-1 custom-scrollbar w-full">${h}</div>`;
                    container.appendChild(el);
                }

            } else if (calendarViewMode === 'week') {
                // === WEEK VIEW ===
                // Calculate start of week (Sunday)
                const startOfWeek = new Date(currentCalendarDate);
                startOfWeek.setDate(currentCalendarDate.getDate() - currentCalendarDate.getDay());
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(startOfWeek.getDate() + 6);

                const sDay = startOfWeek.getDate(), sMonth = shortThaiMonths[startOfWeek.getMonth()];
                const eDay = endOfWeek.getDate(), eMonth = shortThaiMonths[endOfWeek.getMonth()];
                $('#calendar-month-year').text(`${sDay} ${sMonth} - ${eDay} ${eMonth} ${endOfWeek.getFullYear()+543}`);
                
                if(headerRow) headerRow.classList.remove('hidden');
                container.className = "grid grid-cols-7 gap-2 flex-1 overflow-y-hidden h-full"; // Columns extend full height

                for(let i=0; i<7; i++) {
                    const d = new Date(startOfWeek);
                    d.setDate(startOfWeek.getDate() + i);
                    const ds = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                    const jobs = getJobsForDate(ds);
                    
                    const isToday = d.toDateString() === new Date().toDateString();
                    const borderClass = isToday ? "border-brand-500 bg-brand-50" : "border-gray-200 bg-white";

                    const el = document.createElement("div");
                    el.className = `flex flex-col h-full border rounded-xl overflow-hidden ${borderClass}`;
                    
                    let h = ''; jobs.forEach(j => h += createJobHTML(j, false)); // Use detailed card
                    
                    el.innerHTML = `
                        <div class="p-2 text-center border-b ${isToday ? 'border-brand-200 bg-brand-100' : 'border-gray-100 bg-gray-50'}">
                            <div class="text-lg font-bold ${isToday ? 'text-brand-700' : 'text-gray-700'}">${d.getDate()}</div>
                        </div>
                        <div class="flex-1 overflow-y-auto p-1 custom-scrollbar space-y-1">
                            ${h}
                        </div>
                    `;
                    container.appendChild(el);
                }

            } else {
                // === DAY VIEW ===
                $('#calendar-month-year').text(`${currentCalendarDate.getDate()} ${thaiMonths[currentCalendarDate.getMonth()]} ${currentCalendarDate.getFullYear()+543}`);
                if(headerRow) headerRow.classList.add('hidden'); // Hide Sun-Sat header
                container.className = "flex flex-col h-full overflow-hidden bg-white border rounded-xl";

                const ds = `${year}-${String(month+1).padStart(2,'0')}-${String(currentCalendarDate.getDate()).padStart(2,'0')}`;
                const jobs = getJobsForDate(ds);

                if (jobs.length === 0) {
                    container.innerHTML = `<div class="flex-1 flex flex-col items-center justify-center text-gray-400">
                        <i class="fa-regular fa-calendar-xmark text-6xl mb-4 text-gray-200"></i>
                        <p>ไม่มีงานในวันนี้</p>
                    </div>`;
                } else {
                    let html = `<div class="flex-1 overflow-y-auto p-4 custom-scrollbar"><div class="space-y-3">`;
                    jobs.forEach(j => {
                        let statusColor = j.status==='process'?'border-l-4 border-yellow-400':(j.status==='finish'||j.status==='complete'?'border-l-4 border-green-500':'border-l-4 border-blue-500');
                        let time = j.actionDate.split('T')[1].slice(0,5);
                        
                        html += `
                        <div class="flex items-start bg-white border border-gray-200 rounded-lg p-4 shadow-sm hover:shadow-md transition cursor-pointer ${statusColor}" onclick="showJobDetail('${j.id}')">
                            <div class="mr-4 text-center min-w-[60px]">
                                <div class="text-xl font-bold text-gray-800">${time}</div>
                                <div class="text-xs text-gray-500 uppercase font-bold mt-1 tracking-wider">${j.status}</div>
                            </div>
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <h4 class="font-bold text-lg text-gray-800">${j.description}</h4>
                                    <span class="font-mono text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">${j.internalId}</span>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2 text-sm text-gray-600">
                                    <div><i class="fa-solid fa-helmet-safety w-5 text-center text-orange-500"></i> ${j.subcontractor || j.teamReq || '-'}</div>
                                    <div><i class="fa-solid fa-location-dot w-5 text-center text-red-500"></i> ${j.location || '-'}</div>
                                    <div><i class="fa-solid fa-user w-5 text-center text-blue-500"></i> ${extractNS(j.nsRespond).names}</div>
                                    <div><i class="fa-solid fa-phone w-5 text-center text-green-500"></i> ${extractNS(j.nsRespond).phones}</div>
                                </div>
                            </div>
                            <div class="ml-4 flex items-center justify-center self-center text-gray-300">
                                <i class="fa-solid fa-chevron-right"></i>
                            </div>
                        </div>`;
                    });
                    html += `</div></div>`;
                    container.innerHTML = html;
                }
            }
        };

        // === LINK SUPPORT FUNCTIONS (NEW) ===
        window.renderLinkSupport = function() {
            const list = $('#list-link-support');
            list.empty();
            let links = masterData.linkSupport || [];
            
            // Search Filter
            const searchTerm = $('#ls-search').val() ? $('#ls-search').val().toLowerCase() : '';
            // Type Filter
            const filterType = $('#ls-filter-type').val();

            links = links.filter(l => {
                const matchesSearch = 
                    (l.name && l.name.toLowerCase().includes(searchTerm)) || 
                    (l.url && l.url.toLowerCase().includes(searchTerm)) ||
                    (l.type && l.type.toLowerCase().includes(searchTerm)) ||
                    (l.detail && l.detail.toLowerCase().includes(searchTerm));
                
                const matchesType = (filterType === 'all' || !filterType) ? true : (l.type === filterType);
                
                return matchesSearch && matchesType;
            });
            
            if (links.length === 0) {
                $('#ls-empty-state').removeClass('hidden');
                if(searchTerm || filterType !== 'all') $('#ls-empty-state p').text('ไม่พบข้อมูลที่ค้นหา');
                else $('#ls-empty-state p').text('ยังไม่มีรายการลิงก์ในระบบ');
            } else {
                $('#ls-empty-state').addClass('hidden');
                
                const originalLinks = masterData.linkSupport || [];
                
                links.forEach((item) => {
                    let originalIndex = -1;
                    for(let i=0; i<originalLinks.length; i++) {
                        if(originalLinks[i].name === item.name && originalLinks[i].url === item.url && originalLinks[i].type === item.type) {
                            originalIndex = i;
                            break;
                        }
                    }
                    
                    // Link Type Badge Color
                    let badgeColor = 'bg-gray-100 text-gray-800';
                    const t = item.type || '-';
                    if(t === 'Site Access') badgeColor = 'bg-blue-100 text-blue-800';
                    else if(t === 'Link Support') badgeColor = 'bg-purple-100 text-purple-800';
                    else if(t === 'Link File Shared') badgeColor = 'bg-orange-100 text-orange-800';
                    
                    const row = `
                        <tr class="hover:bg-gray-50 transition-colors group">
                            <td class="px-6 py-4">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 h-8 w-8 rounded-full bg-brand-50 flex items-center justify-center text-brand-500 mr-3 border border-brand-100">
                                        <i class="fa-solid fa-globe text-xs"></i>
                                    </div>
                                    <div class="text-sm font-bold text-gray-700">${item.name}</div>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <a href="${item.url}" target="_blank" class="text-sm text-blue-600 hover:text-blue-800 hover:underline block break-all line-clamp-2" title="${item.url}">
                                    ${item.url} <i class="fa-solid fa-arrow-up-right-from-square ml-1.5 text-xs opacity-50"></i>
                                </a>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full ${badgeColor}">${t}</span>
                            </td>
                            <td class="px-6 py-4">
                                <span class="text-sm text-gray-500">${item.detail || '-'}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button onclick="editLinkItem(${originalIndex})" class="text-gray-300 hover:text-blue-500 transition-colors p-1.5 rounded-md hover:bg-blue-50 mr-1" title="แก้ไข">
                                    <i class="fa-solid fa-pen-to-square"></i>
                                </button>
                                <button onclick="deleteLinkItem(${originalIndex})" class="text-gray-300 hover:text-red-500 transition-colors p-1.5 rounded-md hover:bg-red-50" title="ลบ">
                                    <i class="fa-solid fa-trash-can"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    list.append(row);
                });
            }
        };

        window.saveLinkItem = async function() {
            const name = $('#ls-name').val().trim();
            let url = $('#ls-url').val().trim();
            const detail = $('#ls-detail').val().trim();
            let type = $('#ls-type').val();
            
            if(type === 'Other') {
                type = $('#ls-type-other').val().trim();
                if(!type) type = 'Other'; // Fallback if empty
            }

            const editIndexStr = $('#ls-edit-index').val();
            
            if (!name || !url || !type) {
                Swal.fire('แจ้งเตือน', 'กรุณาระบุชื่อ, URL และประเภทให้ครบถ้วน', 'warning');
                return;
            }

            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                url = 'https://' + url;
            }

            const newItem = { name, url, type, detail };
            
            try {
                const ref = getSettingsRef();
                const doc = await ref.get();
                
                if (doc.exists) {
                    let currentLinks = doc.data().linkSupport || [];
                    
                    if (editIndexStr !== "") {
                        const idx = parseInt(editIndexStr);
                        if (idx >= 0 && idx < currentLinks.length) {
                            currentLinks[idx] = newItem;
                            await ref.update({ linkSupport: currentLinks });
                            Swal.fire({ icon: 'success', title: 'แก้ไขข้อมูลเรียบร้อย', toast: true, position: 'top-end', showConfirmButton: false, timer: 1500 });
                        }
                    } else {
                        currentLinks.push(newItem);
                        await ref.update({ linkSupport: currentLinks });
                        Swal.fire({ icon: 'success', title: 'เพิ่มลิงก์เรียบร้อย', toast: true, position: 'top-end', showConfirmButton: false, timer: 1500 });
                    }
                } else {
                    await ref.set({ linkSupport: [newItem] }, { merge: true });
                    Swal.fire({ icon: 'success', title: 'เพิ่มลิงก์เรียบร้อย', toast: true, position: 'top-end', showConfirmButton: false, timer: 1500 });
                }
                
                cancelLinkEdit(); 
            } catch (error) {
                console.error("Error saving link:", error);
                Swal.fire('Error', 'บันทึกไม่สำเร็จ: ' + error.message, 'error');
            }
        };

        window.editLinkItem = function(index) {
            const links = masterData.linkSupport || [];
            if (index >= 0 && index < links.length) {
                const item = links[index];
                
                $('#ls-name').val(item.name);
                $('#ls-url').val(item.url);
                $('#ls-detail').val(item.detail || '');
                $('#ls-edit-index').val(index);
                
                // Handle Type Selection
                const predefinedTypes = ["Site Access", "Link Support", "Link File Shared"];
                if (predefinedTypes.includes(item.type)) {
                    $('#ls-type').val(item.type).trigger('change');
                } else {
                    $('#ls-type').val('Other').trigger('change');
                    $('#ls-type-other').val(item.type);
                }
                
                $('#btn-save-link').html('<i class="fa-solid fa-save mr-1"></i> บันทึก').removeClass('bg-brand-500 hover:bg-brand-600').addClass('bg-green-600 hover:bg-green-700');
                $('#btn-cancel-link').removeClass('hidden');
                
                $('#ls-name').focus();
            }
        };

        window.cancelLinkEdit = function() {
            $('#ls-name').val('');
            $('#ls-url').val('');
            $('#ls-detail').val('');
            $('#ls-type').val('').trigger('change');
            $('#ls-type-other').val('');
            $('#ls-edit-index').val('');
            
            $('#btn-save-link').html('<i class="fa-solid fa-plus mr-1"></i> เพิ่ม').removeClass('bg-green-600 hover:bg-green-700').addClass('bg-brand-500 hover:bg-brand-600');
            $('#btn-cancel-link').addClass('hidden');
        };

        window.deleteLinkItem = async function(index) {
            if(index === -1) return;
            
            Swal.fire({
                title: 'ยืนยันการลบ?',
                text: "คุณต้องการลบลิงก์นี้ใช่หรือไม่",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                confirmButtonText: 'ลบ',
                cancelButtonText: 'ยกเลิก'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        const ref = getSettingsRef();
                        const doc = await ref.get();
                        if (doc.exists) {
                            const currentLinks = doc.data().linkSupport || [];
                            if (index >= 0 && index < currentLinks.length) {
                                currentLinks.splice(index, 1);
                                await ref.update({ linkSupport: currentLinks });
                                Swal.fire({ icon: 'success', title: 'ลบเรียบร้อย', toast: true, position: 'top-end', showConfirmButton: false, timer: 1500 });
                                if ($('#ls-edit-index').val() == index) cancelLinkEdit();
                            }
                        }
                    } catch (error) {
                        Swal.fire('Error', error.message, 'error');
                    }
                }
            });
        };

        // NEW: Robust Setting Render Function
        window.renderSettings = function() {
            const listSub = $('#list-subcontractors');
            const listNs = $('#list-nsRespond');
            
            if (listSub.length === 0 || listNs.length === 0) return; // Safety check

            listSub.empty();
            listNs.empty();

            // Handle case sensitivity and fallback
            const subs = masterData.subcontractors || masterData.Subcontractors || [];
            const ns = masterData.nsRespond || masterData.NsRespond || [];

            if (subs.length === 0) {
                listSub.append('<li class="text-gray-400 text-sm text-center p-2">ไม่มีข้อมูล</li>');
            } else {
                subs.forEach(item => {
                    // Determine key for removal
                    const key = masterData.subcontractors ? 'subcontractors' : 'Subcontractors';
                    listSub.append(`
                        <li class="flex justify-between items-center bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm shadow-sm">
                            <span class="font-medium text-gray-700">${item}</span>
                            <button onclick="removeSettingItem('${key}', '${item}')" class="text-gray-400 hover:text-red-500 transition-colors p-1 rounded-md hover:bg-red-50">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </li>
                    `);
                });
            }

            if (ns.length === 0) {
                listNs.append('<li class="text-gray-400 text-sm text-center p-2">ไม่มีข้อมูล</li>');
            } else {
                ns.forEach(item => {
                    const key = masterData.nsRespond ? 'nsRespond' : 'NsRespond';
                    listNs.append(`
                        <li class="flex justify-between items-center bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm shadow-sm">
                            <span class="font-medium text-gray-700">${item}</span>
                            <button onclick="removeSettingItem('${key}', '${item}')" class="text-gray-400 hover:text-red-500 transition-colors p-1 rounded-md hover:bg-red-50">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </li>
                    `);
                });
            }
        };

        window.renderSummaryDashboard = function() {
            const jobTypeFilter = $('#sum-dash-jobtype').val();
            const dateStart = $('#sum-dash-start').val();
            const dateEnd = $('#sum-dash-end').val();

            // Data source: Only summary_plan category
            let data = assignments.filter(a => a.category === 'summary_plan');

            // Apply Filters
            if(jobTypeFilter !== 'all') {
                data = data.filter(a => a.jobType === jobTypeFilter);
            }
            if(dateStart) {
                // Using dueDate for Summary Plan date filter if available, or createdAt fallback
                data = data.filter(a => {
                    const d = a.dueDate ? new Date(a.dueDate) : (a.actionDate ? new Date(a.actionDate) : null);
                    return d && d >= new Date(dateStart);
                });
            }
            if(dateEnd) {
                data = data.filter(a => {
                    const d = a.dueDate ? new Date(a.dueDate) : (a.actionDate ? new Date(a.actionDate) : null);
                    return d && d <= new Date(dateEnd);
                });
            }

            // Helper to sum distance safely
            const sumDist = (arr) => arr.reduce((acc, curr) => acc + (parseFloat(curr.distance) || 0), 0);

            // --- Calculate Stats ---
            // 1. Amount Route [JobType/All]
            const totalCount = data.length;
            const totalDist = sumDist(data);
            
            $('#sum-stat-route').text(totalCount);
            $('#sum-stat-dist-route').text(totalDist.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}));
            $('#sum-title-route').text(jobTypeFilter !== 'all' ? `Total Plan (${jobTypeFilter})` : 'Total Plan');

            // 2. Amount Route SYMC Impact
            const impactData = data.filter(a => a.symImpact && a.symImpact.trim() !== '' && a.symImpact !== '-');
            const impactCount = impactData.length;
            const impactDist = sumDist(impactData);
            
            $('#sum-stat-impact').text(impactCount);
            $('#sum-stat-dist-impact').text(impactDist.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}));

            // 3. Amount Route SYMC Complete
            const completeData = data.filter(a => a.status === 'complete' || a.status === 'finish');
            const completeCount = completeData.length;
            const completeDist = sumDist(completeData);
            
            $('#sum-stat-complete').text(completeCount);
            $('#sum-stat-dist-complete').text(completeDist.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}));

            // 4. Amount Route SYMC Ongoing
            const ongoingData = data.filter(a => a.status === 'process');
            const ongoingCount = ongoingData.length;
            const ongoingDist = sumDist(ongoingData);
            
            $('#sum-stat-ongoing').text(ongoingCount);
            $('#sum-stat-dist-ongoing').text(ongoingDist.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}));

            // --- Charts ---
            // Chart 1: Job Type Distribution
            const jobTypes = {};
            data.forEach(a => { 
                const t = a.jobType || 'Other';
                jobTypes[t] = (jobTypes[t] || 0) + 1;
            });

            if(charts.sumJobType) charts.sumJobType.destroy();
            const ctx1 = document.getElementById('chartSumJobType');
            if(ctx1) {
                charts.sumJobType = new Chart(ctx1, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(jobTypes),
                        datasets: [{
                            data: Object.values(jobTypes),
                            backgroundColor: ['#f97316', '#3b82f6', '#8b5cf6', '#10b981', '#64748b']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
                });
            }

            // Chart 2: Status Overview
            const statuses = ['new', 'process', 'complete', 'cancel'];
            const statusCounts = statuses.map(s => data.filter(a => a.status === s).length);
            const statusLabels = ['New', 'Ongoing', 'Complete', 'Cancel'];

            if(charts.sumStatus) charts.sumStatus.destroy();
            const ctx2 = document.getElementById('chartSumStatus');
            if(ctx2) {
                charts.sumStatus = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: statusLabels,
                        datasets: [{
                            label: 'Jobs',
                            data: statusCounts,
                            backgroundColor: ['#3b82f6', '#eab308', '#22c55e', '#ef4444'],
                            barThickness: 40
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
                });
            }
        };

        window.renderSubDashboardCharts = function() { 
            const catFilter = $('#sub-filter-category').val();
            const dateStart = $('#sub-date-start').val();
            const dateEnd = $('#sub-date-end').val();
            let data = assignments.filter(a => ['sub_preventive', 'sub_reroute', 'sub_reconfigure'].includes(a.category));
            if(catFilter !== 'all') data = data.filter(a => a.category === catFilter);
            if(dateStart) data = data.filter(a => new Date(a.actionDate) >= new Date(dateStart));
            if(dateEnd) data = data.filter(a => new Date(a.actionDate) <= new Date(dateEnd));
            $('#sub-stat-total').text(data.length);
            const totalCost = data.reduce((sum, a) => sum + Number(a.expenses || 0), 0);
            $('#sub-stat-cost').text(totalCost.toLocaleString() + ' ฿');
            const activeSubs = [...new Set(data.map(a => a.subcontractor).filter(Boolean))];
            $('#sub-stat-active').text(activeSubs.length);
            const avgCost = data.length > 0 ? totalCost / data.length : 0;
            $('#sub-stat-avg').text(Math.round(avgCost).toLocaleString() + ' ฿');
            const expByStatus = {};
            data.forEach(a => { const s = a.status || 'unknown'; expByStatus[s] = (expByStatus[s] || 0) + Number(a.expenses || 0); });
            if(charts.subCostStatus) charts.subCostStatus.destroy();
            const statusCanvas = document.getElementById('chartSubCostStatus');
            if(statusCanvas) {
                charts.subCostStatus = new Chart(statusCanvas, { type: 'doughnut', data: { labels: Object.keys(expByStatus), datasets: [{ label: 'Expenses', data: Object.values(expByStatus), backgroundColor: ['#3b82f6', '#22c55e', '#eab308', '#ef4444', '#a855f7'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });
            }
            const subDataMap = {};
            data.forEach(a => { const s = a.subcontractor || 'Unknown'; if(!subDataMap[s]) subDataMap[s] = { count: 0, cost: 0 }; subDataMap[s].count++; subDataMap[s].cost += Number(a.expenses || 0); });
            const subLabels = Object.keys(subDataMap); const subCounts = subLabels.map(k => subDataMap[k].count); const subCosts = subLabels.map(k => subDataMap[k].cost);
            if(charts.subCount) charts.subCount.destroy();
            const countCanvas = document.getElementById('chartSubCount');
            if(countCanvas) {
                charts.subCount = new Chart(countCanvas, { type: 'bar', data: { labels: subLabels, datasets: [{ label: 'Job Count', data: subCounts, backgroundColor: '#3b82f6', xAxisID: 'x', }, { label: 'Total Cost (THB)', data: subCosts, backgroundColor: '#10b981', xAxisID: 'x1', }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { type: 'linear', position: 'bottom', title: { display: true, text: 'Job Count' } }, x1: { type: 'linear', position: 'top', grid: { drawOnChartArea: false }, title: { display: true, text: 'Total Cost (THB)' }, ticks: { callback: function(value) { return value.toLocaleString(); } } } }, plugins: { tooltip: { callbacks: { label: function(context) { let label = context.dataset.label || ''; if (label) { label += ': '; } if (context.parsed.x !== null) { label += context.parsed.x.toLocaleString(); if(context.dataset.label.includes('Cost')) label += ' ฿'; } return label; } } } } } });
            }
            const tbody = $('#table-sub-summary'); tbody.empty(); const subAgg = {};
            data.forEach(a => { const s = a.subcontractor || 'Unknown'; if(!subAgg[s]) subAgg[s] = { name: s, total: 0, finish: 0, cost: 0 }; subAgg[s].total++; if(a.status === 'finish' || a.status === 'complete') subAgg[s].finish++; subAgg[s].cost += Number(a.expenses || 0); });
            Object.values(subAgg).forEach(row => { tbody.append(`<tr class="border-b border-gray-50 hover:bg-gray-50"><td class="p-3 font-medium text-gray-700">${row.name}</td><td class="p-3 text-center">${row.total}</td><td class="p-3 text-center text-green-600 font-bold">${row.finish}</td><td class="p-3 text-right text-brand-600 font-bold">${row.cost.toLocaleString()}</td></tr>`); });
        };

        window.updateDashboard = function() {
             const data = assignments.filter(a => a.category === currentCategoryFilter);
             
             if(currentCategoryFilter === 'plan_interruption') {
                 const counts = { new:0, process:0, complete:0, update_fms:0, cancel:0 };
                 data.forEach(a => { const s = a.status || 'new'; if(counts[s] !== undefined) counts[s]++; });
                 $('#plan-count-new').text(counts.new); $('#plan-count-process').text(counts.process); $('#plan-count-complete').text(counts.complete); $('#plan-count-updatefms').text(counts.update_fms); $('#plan-count-cancel').text(counts.cancel);
             } else if(currentCategoryFilter === 'summary_plan') {
                 // UPDATE SUMMARY PLAN JOB LIST DASHBOARD
                 const counts = { new:0, process:0, complete:0, cancel:0 };
                 data.forEach(a => { 
                     let s = a.status || 'new';
                     // Map finish to complete for this dashboard
                     if(s === 'finish') s = 'complete'; 
                     if(counts[s] !== undefined) counts[s]++; 
                 });
                 $('#sum-list-new').text(counts.new); 
                 $('#sum-list-process').text(counts.process); 
                 $('#sum-list-complete').text(counts.complete); 
                 $('#sum-list-cancel').text(counts.cancel);
             } else {
                 // ... existing logic for other dashboards ...
                 const counts = { new:0, process:0, assign:0, approve:0, finish:0, complete:0, cancel:0 };
                 const costs = { new:0, process:0, assign:0, approve:0, finish:0, complete:0, cancel:0 };
                 let grandTotal = 0;
                 data.forEach(a => { const s = a.status || 'new'; if(counts[s] !== undefined) counts[s]++; const cost = Number(a.expenses || 0); if(costs[s] !== undefined) costs[s] += cost; grandTotal += cost; });
                 if(menuConfig[currentCategoryFilter]?.isSub) {
                    $('#sub-count-new').text(counts.new); $('#sub-cost-new').text(costs.new.toLocaleString() + ' ฿');
                    $('#sub-count-process').text(counts.process); $('#sub-cost-process').text(costs.process.toLocaleString() + ' ฿');
                    $('#sub-count-assign').text(counts.assign); $('#sub-cost-assign').text(costs.assign.toLocaleString() + ' ฿');
                    $('#sub-count-approve').text(counts.approve); $('#sub-cost-approve').text(costs.approve.toLocaleString() + ' ฿');
                    $('#sub-count-finish').text(counts.finish); $('#sub-cost-finish').text(costs.finish.toLocaleString() + ' ฿');
                    $('#sub-count-cancel').text(counts.cancel); $('#sub-cost-cancel').text(costs.cancel.toLocaleString() + ' ฿');
                    $('#table-grand-total').text('Total: ' + grandTotal.toLocaleString() + ' ฿').removeClass('hidden');
                 } else {
                    $('#table-grand-total').addClass('hidden');
                    $('#team-count-new').text(counts.new); $('#team-count-process').text(counts.process); $('#team-count-complete').text(counts.finish + counts.complete); $('#team-count-cancel').text(counts.cancel);
                 }
             }
        };

        window.renderDashboardCharts = function() {
            const catFilter = $('#dash-filter-category').val();
            const dateStart = $('#dash-date-start').val();
            const dateEnd = $('#dash-date-end').val();
            let data = assignments.filter(a => a.category !== 'summary_plan');
            if(catFilter !== 'all') data = data.filter(a => a.category === catFilter);
            if(dateStart) data = data.filter(a => new Date(a.actionDate) >= new Date(dateStart));
            if(dateEnd) data = data.filter(a => new Date(a.actionDate) <= new Date(dateEnd));
            $('#stat-total').text(data.length);
            const success = data.filter(a => a.status === 'finish' || a.status === 'complete' || a.status === 'update_fms').length;
            $('#stat-success').text(data.length > 0 ? Math.round((success/data.length)*100) + '%' : '0%');
            $('#stat-success-count').text(`${success} jobs`);
            $('#stat-pending').text(data.filter(a => ['new', 'process', 'assign', 'approve'].includes(a.status)).length);
            $('#stat-cancel').text(data.filter(a => a.status === 'cancel').length);
            const statuses = ['new', 'process', 'assign', 'approve', 'finish', 'complete', 'update_fms', 'cancel'];
            const statusLabels = statuses.map(s => s.toUpperCase().replace('_', ' '));
            const statusData = statuses.map(s => data.filter(a => a.status === s).length);
            if(charts.status) charts.status.destroy();
            const ctxStatus = document.getElementById('chartStatus');
            if (ctxStatus) { charts.status = new Chart(ctxStatus, { type: 'doughnut', data: { labels: statusLabels, datasets: [{ data: statusData, backgroundColor: ['#3b82f6', '#eab308', '#a855f7', '#06b6d4', '#22c55e', '#22c55e', '#0891b2', '#ef4444'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } }); }
            const dates = {}; data.forEach(a => { if(!a.actionDate) return; const d = new Date(a.actionDate).toLocaleDateString('th-TH'); dates[d] = (dates[d] || 0) + 1; });
            const sortedDateKeys = Object.keys(dates).sort((a,b) => { const da = a.split('/'); const db = b.split('/'); return new Date(da[2]-543, da[1]-1, da[0]) - new Date(db[2]-543, db[1]-1, db[0]); }).slice(-7);
            if(charts.trend) charts.trend.destroy();
            const ctxTrend = document.getElementById('chartTrend');
            if(ctxTrend) { charts.trend = new Chart(ctxTrend, { type: 'line', data: { labels: sortedDateKeys, datasets: [{ label: 'Jobs', data: sortedDateKeys.map(k => dates[k]), borderColor: '#3b82f6', tension: 0.3, fill: false }] }, options: { responsive: true, maintainAspectRatio: false } }); }
            const types = {}; data.forEach(a => { const t = a.jobType || 'Unknown'; types[t] = (types[t] || 0) + 1; });
            if(charts.jobType) charts.jobType.destroy();
            const ctxType = document.getElementById('chartJobType');
            if(ctxType) { charts.jobType = new Chart(ctxType, { type: 'bar', data: { labels: Object.keys(types), datasets: [{ label: 'Count', data: Object.values(types), backgroundColor: '#8b5cf6' }] }, options: { responsive: true, maintainAspectRatio: false } }); }
            const agencies = {}; data.forEach(a => { const g = a.agency || 'Unknown'; agencies[g] = (agencies[g] || 0) + 1; });
            if(charts.agency) charts.agency.destroy();
            const ctxAgency = document.getElementById('chartAgency');
            if(ctxAgency) { charts.agency = new Chart(ctxAgency, { type: 'bar', data: { labels: Object.keys(agencies), datasets: [{ label: 'Count', data: Object.values(agencies), backgroundColor: '#ec4899' }] }, options: { responsive: true, maintainAspectRatio: false } }); }
        };

        window.performSave = function() { if($("#assignment-form").valid()) { saveAssignment(); } };
        
        window.renderDropdowns = function() { 
            const populate = (id, list) => { const el = $(`#${id}`); el.empty().append('<option value="">เลือก...</option>'); if(list) list.forEach(i => el.append(`<option value="${i}">${i}</option>`)); };
            let targetCat = currentCategoryFilter === 'summary_dashboard' ? 'summary_plan' : currentCategoryFilter;
            const config = menuConfig[targetCat] || menuConfig['team'];
            const activeKey = config.jobTypeKey;
            
            populate('form-job-type', CONST_DATA.jobTypes[activeKey]); 
            populate('form-agency', CONST_DATA.agencies); 
            populate('form-project', CONST_DATA.projects); 
            populate('form-team-req', CONST_DATA.teamRequests); 
            populate('form-side-count', CONST_DATA.sideCounts); 
            
            const nsSelect = $('#form-ns-respond'); nsSelect.empty(); const nsList = masterData.nsRespond || masterData.NsRespond || [];
            nsList.forEach(i => nsSelect.append(new Option(i, i, false, false))); nsSelect.trigger('change');
        };

        window.changePage = function(p) {
            if (p < 1) p = 1;
            const totalPages = Math.ceil(filteredData.length / rowsPerPage);
            if (p > totalPages && totalPages > 0) p = totalPages;
            currentPage = p;
            renderTable();
        };

        window.changeRowsPerPage = function() {
            const val = $('#rows-per-page').val();
            rowsPerPage = val === 'all' ? 99999 : parseInt(val);
            currentPage = 1; 
            renderTable();
        };

        window.renderTable = function() { 
            const tbody = document.getElementById("table-body"); if(!tbody) return;
            const sv = $('#search-input').val().toLowerCase(), fs = $('#filter-status').val();
            const th = document.getElementById("table-header-row");
            const config = menuConfig[currentCategoryFilter];
            const thClass = "p-3 text-center align-middle whitespace-normal break-words font-semibold text-gray-700 bg-gray-50 border-b border-gray-200 min-w-[80px]";
            let cols = `<th class="${thClass}">Job ID</th>`;
            
            if (currentCategoryFilter === 'summary_plan') {
                // Custom columns for Summary Plan Job List
                cols += `<th class="${thClass}">Job Type</th><th class="${thClass}">Project Code</th><th class="${thClass}">Route Name</th><th class="${thClass}">Distance</th><th class="${thClass}">Due Date</th><th class="${thClass}">Sym Impact</th><th class="${thClass}">Progress</th><th class="${thClass}">NS</th><th class="${thClass}">Status</th><th class="${thClass}">Action</th>`;
            } else if (config && config.isSub) {
			   cols += `<th class="${thClass}">Job Type</th><th class="${thClass}">Desc</th><th class="${thClass}">asNumber</th><th class="${thClass}">Objective</th><th class="${thClass}">Expenses</th><th class="${thClass}">Route Code</th><th class="${thClass}">Action Date</th><th class="${thClass}">Subcontractor</th><th class="${thClass}">NS</th><th class="${thClass}">Location</th><th class="${thClass}">Status</th><th class="${thClass}">Action</th>`;
            } else if (config && config.isPlan) {
                 cols += `<th class="${thClass}">Interruption Type</th><th class="${thClass}">Project</th><th class="${thClass}">Desc</th><th class="${thClass}">Agency</th><th class="${thClass}">Sent Plan Date</th><th class="${thClass}">Action Date</th><th class="${thClass}">Location</th><th class="${thClass}">Status</th><th class="${thClass}">NS</th><th class="${thClass}">Item</th><th class="${thClass}">Action</th>`;
            } else {
                 cols += `<th class="${thClass}">Job Type</th><th class="${thClass}">Desc</th><th class="${thClass}">Action Date</th><th class="${thClass}">Due Date</th><th class="${thClass}">Team</th><th class="${thClass}">NS</th><th class="${thClass}">Location</th><th class="${thClass}">Status</th><th class="${thClass}">Action</th>`;
            }
            $('#table-header').html(`<i class="fa-solid fa-list-ul mr-2 text-brand-500"></i> รายการงาน ${config ? config.title : 'All'}`); th.innerHTML = cols;
            
            filteredData = assignments.filter(a => {
                if (currentCategoryFilter !== 'dashboard_analytics' && currentCategoryFilter !== 'sub_dashboard' && a.category !== currentCategoryFilter) return false;
                if (fs !== 'all' && a.status !== fs) return false;
                const searchFields = [ a.internalId, a.description, a.location, a.jobType, a.agency, a.teamReq, a.subcontractor, a.project, (a.nsRespond || []).join(' ') ];
                return searchFields.join(' ').toLowerCase().includes(sv);
            });
            const total = filteredData.length, start = (currentPage - 1) * rowsPerPage, pageData = filteredData.slice(start, start + rowsPerPage);
            tbody.innerHTML = "";
            if (total === 0) { $('#empty-state').removeClass('hidden'); $('#data-table').addClass('hidden'); }
            else {
                $('#empty-state').addClass('hidden'); $('#data-table').removeClass('hidden');
                pageData.forEach(item => {
                    const badge = `<span class="status-badge status-${item.status}">${item.status.toUpperCase().replace('_', ' ')}</span>`;
                    const sub = config && config.isSub ? (item.subcontractor || '-') : (item.teamReq || '-');
                    const acts = window.getActionButtons(item, config && config.isSub, config && config.isPlan);
                    let rowHtml = `<td class="p-3 text-center font-mono font-bold text-brand-600 text-xs">${item.internalId}</td>`;
                    
                    if (currentCategoryFilter === 'summary_plan') {
                        // Summary Plan Rows
                        const progressVal = item.progressPercent || 0;
                        const progressColor = progressVal === 100 ? 'bg-green-500' : 'bg-yellow-500';
                        const progressHtml = item.status === 'process' 
                            ? `<div class="w-full bg-gray-200 rounded-full h-2.5 mb-1 cursor-pointer" onclick="updateProgressSummary('${item.id}')" title="Click to update"><div class="${progressColor} h-2.5 rounded-full" style="width: ${progressVal}%"></div></div><div class="text-[10px] text-center font-bold text-gray-600 cursor-pointer" onclick="updateProgressSummary('${item.id}')">${progressVal}% <i class="fa-solid fa-pen ml-1 text-gray-400 hover:text-brand-500"></i></div>` 
                            : `<div class="text-center font-bold text-gray-500 text-xs">${progressVal}%</div>`;

                        rowHtml += `<td class="p-3 text-xs">${item.jobType||'-'}</td>
                                    <td class="p-3 text-center text-xs text-blue-500 truncate max-w-[150px] font-bold">${item.projectCode||'-'}</td>
                                    <td class="p-3 text-xs truncate max-w-[400px]">${item.routeName||'-'}</td>
                                    <td class="p-3 text-center text-xs">${item.distance||'-'}</td>
                                    <td class="p-3 text-center text-xs">${item.dueDate ? fmtDate(item.dueDate, true) : '-'}</td>
                                    <td class="p-3 text-center text-xs text-orange-600 font-medium">${item.symImpact||'-'}</td>
                                    <td class="p-3 w-24 align-middle">${progressHtml}</td>
                                    <td class="p-3 truncate max-w-[100px] text-xs">${extractNS(item.nsRespond).names}</td>
                                    <td class="p-3 text-center">${badge}</td>`;
                    
                    } else if (config && config.isPlan) {
                        rowHtml += `<td class="p-3 text-xs">${item.jobType||'-'}</td><td class="p-3 text-xs">${item.project||'-'}</td><td class="p-3 truncate max-w-[400px]">${item.description||'-'}</td><td class="p-3 text-xs">${item.agency||'-'}</td><td class="p-3 text-center text-xs">${item.sentPlanDate ? fmtDate(item.sentPlanDate, true) : '-'}</td>`;
                        const actionTime = (item.planStartTime && item.planEndTime) ? `<br><span class="text-gray-400">${item.planStartTime}-${item.planEndTime}</span>` : '';
                        rowHtml += `<td class="p-3 text-center text-xs">${item.planDate ? fmtDate(item.planDate, true) + actionTime : '-'}</td><td class="p-3 truncate max-w-[100px] text-xs">${item.location||'-'}</td><td class="p-3 text-center">${badge}</td><td class="p-3 truncate max-w-[100px] text-xs">${extractNS(item.nsRespond).names}</td><td class="p-3 text-center text-xs">${item.itemCount||'0'}</td>`;
                    } else {
                        rowHtml += `<td class="p-3 text-xs">${item.jobType||'-'}</td><td class="p-3 truncate max-w-[400px]">${item.description||'-'}</td>`;
                        if (config && config.isSub) rowHtml += `<td class="p-3 text-xs truncate max-w-[100px]" title="${item.asNumber||''}">${item.asNumber||'-'}</td><td class="p-3 text-xs truncate max-w-[100px]" title="${item.objective||''}">${item.objective||'-'}</td><td class="p-3 text-xs" title="${item.expenses||''}">${item.expenses||'-'}</td><td class="p-3 text-xs truncate max-w-[100px]" title="${item.routeCode||''}">${item.routeCode||'-'}</td>`;
                        rowHtml += `<td class="p-3 text-center text-xs">${fmtDate(item.actionDate)}</td>`;
                        if(config && !config.isSub) rowHtml += `<td class="p-3 text-center text-xs">${item.dueDate ? fmtDate(item.dueDate, true) : '-'}</td>`;
                        rowHtml += `<td class="p-3 text-blue-600 font-medium text-xs">${sub}</td><td class="p-3 truncate max-w-[100px] text-xs">${extractNS(item.nsRespond).names}</td>`;
                        if (!(config && config.isPlan)) rowHtml += `<td class="p-3 truncate max-w-[100px] text-xs">${item.location||'-'}</td>`;
                        rowHtml += `<td class="p-3 text-center">${badge}</td>`;
                    }
                    
                    let m = `<button onclick="viewDetail('${item.id}')" class="text-gray-400 hover:text-green-600 mx-1"><i class="fa-solid fa-file-lines"></i></button>`;
                    if(config && config.isSub) m += `<button onclick="requestApprove('${item.id}')" class="text-gray-400 hover:text-purple-600 mx-1"><i class="fa-solid fa-money-bill-wave"></i></button>`;
                    m += `<button onclick="openModal('${item.id}')" class="text-gray-400 hover:text-blue-600 mx-1"><i class="fa-solid fa-pen-to-square"></i></button><button onclick="deleteAssignment('${item.id}')" class="text-gray-400 hover:text-red-600 mx-1"><i class="fa-solid fa-trash-can"></i></button>`;
                    if(item.fileUrl && !(config && config.isPlan)) m+= `<a href="${item.fileUrl}" target="_blank" class="text-gray-400 hover:text-blue-500 mx-1"><i class="fa-solid fa-cloud-arrow-down"></i></a>`;
                    rowHtml += `<td class="p-3 text-center"><div class="flex items-center justify-center space-x-2"><div class="flex gap-1">${acts}</div><div class="h-4 w-px bg-gray-200"></div><div class="flex">${m}</div></div></td>`;
                    tbody.insertAdjacentHTML('beforeend', `<tr class="hover:bg-gray-50 border-b border-gray-50">${rowHtml}</tr>`);
                });
            }
            $('#pagination-info').text(`Showing ${Math.min(start+1, total)}-${Math.min(start+pageData.length, total)} of ${total}`);
            $('#pagination-controls').html(`<button onclick="changePage(${Math.max(1, currentPage-1)})" class="px-2 border rounded"><</button><button onclick="changePage(${Math.min(Math.ceil(total/rowsPerPage), currentPage+1)})" class="px-2 border rounded">></button>`);
        };

        window.getActionButtons = function(item, isSub, isPlan) {
		
            // FIX: Check item.category for robustness in Calendar view
            if (item.category === 'summary_plan' || currentCategoryFilter === 'summary_plan') {
                if (item.status === 'new') {
                    return `<button onclick="actionReceiveSummary('${item.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-0.5 rounded text-[10px] shadow-sm transition">Receive</button>
                            <button onclick="actionCancelSummary('${item.id}')" class="bg-red-500 hover:bg-red-600 text-white px-2 py-0.5 rounded text-[10px] shadow-sm ml-1 transition">Cancel Job</button>`;
                } else if (item.status === 'process') {
                    return `<button onclick="actionCompleteSummary('${item.id}')" class="bg-green-500 hover:bg-green-600 text-white px-2 py-0.5 rounded text-[10px] shadow-sm transition">Complete</button>
                            <button onclick="actionCancelSummary('${item.id}')" class="bg-red-500 hover:bg-red-600 text-white px-2 py-0.5 rounded text-[10px] shadow-sm ml-1 transition">Cancel Job</button>`;
                } else {
                    return '-';
                }
            }
            if (isPlan) {
                const cancelBtn = `<button onclick="actionCancelPlan('${item.id}')" class="bg-red-500 text-white px-2 py-0.5 rounded text-[10px] ml-1">Cancel Job</button>`;
                if (item.status === 'new') return `<button onclick="actionReceivePlan('${item.id}')" class="bg-blue-500 text-white px-2 py-0.5 rounded text-[10px]">Receive</button>${cancelBtn}`;
                if (item.status === 'process') return `<button onclick="actionCompletePlan('${item.id}')" class="bg-green-500 text-white px-2 py-0.5 rounded text-[10px]">Complete</button>${cancelBtn}`;
                
                // Logic: Only 'Interruption OFC' can proceed to Update FMS after Complete
                if (item.status === 'complete') {
                    if (item.jobType === 'Interruption OFC') {
                        return `<button onclick="actionUpdateFMS('${item.id}')" class="bg-cyan-600 text-white px-2 py-0.5 rounded text-[10px]">Update FMS</button>`;
                    }
                    return '-'; // Other job types stop at Complete
                }
				}
				
            if (!isSub) {
                if (item.status === 'new') return `<button onclick="updateStatus('${item.id}','process',{receiveDate:new Date().toISOString()})" class="bg-yellow-500 text-white px-2 py-0.5 rounded text-[10px] mr-1">Receive</button><button onclick="actionCancel('${item.id}')" class="bg-red-500 text-white px-2 py-0.5 rounded text-[10px]">Cancel</button>`;
                if (item.status === 'process') return `<button onclick="updateStatus('${item.id}','complete',{completeDate:new Date().toISOString()})" class="bg-green-500 text-white px-2 py-0.5 rounded text-[10px]">Finish</button>`;
                return '-';
            }
            switch(item.status) {
                case 'new': return `<button onclick="updateStatus('${item.id}','process',{receiveDate:new Date().toISOString()})" class="bg-yellow-500 text-white px-2 py-0.5 rounded text-[10px] mr-1">Receive</button><button onclick="actionCancel('${item.id}')" class="bg-red-500 text-white px-2 py-0.5 rounded text-[10px]">Cancel</button>`;
                case 'process': return `<button onclick="actionAssign('${item.id}')" class="bg-purple-500 text-white px-2 py-0.5 rounded text-[10px]">Assign</button>`;
                case 'assign': return `<button onclick="actionApprove('${item.id}')" class="bg-cyan-500 text-white px-2 py-0.5 rounded text-[10px]">Approve</button>`;
                case 'approve': return `<button onclick="actionFinish('${item.id}')" class="bg-green-500 text-white px-2 py-0.5 rounded text-[10px]">Finish</button>`;
                default: return '-';
            }
        };

        // === Summary Plan Specific Actions ===
        window.actionReceiveSummary = function(id) {
            // Receive moves to Process (Inprocess)
            window.updateStatus(id, 'process', { receiveDate: new Date().toISOString() });
        };

        window.actionCancelSummary = function(id) {
            const ops = (masterData.nsRespond || []).map(n => `<option value="${n}">${n}</option>`).join('');
            Swal.fire({
                title: 'ยกเลิกงาน (Cancel Job)',
                html: `
                    <div class="text-left space-y-3">
                        <div>
                            <label class="text-sm font-bold text-gray-700 block mb-1">ผู้แจ้งยกเลิก (NS Respond) <span class="text-red-500">*</span></label>
                            <select id="cancel-ns" class="swal2-select w-full m-0 border border-gray-300 rounded p-2 text-sm">
                                <option value="">เลือกชื่อ...</option>
                                ${ops}
                            </select>
                        </div>
                        <div>
                            <label class="text-sm font-bold text-gray-700 block mb-1">สาเหตุการยกเลิก (Reason) <span class="text-red-500">*</span></label>
                            <input id="cancel-reason" class="swal2-input m-0 w-full text-sm" placeholder="ระบุสาเหตุ...">
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                confirmButtonText: 'ยืนยันยกเลิก',
                preConfirm: () => {
                    const ns = document.getElementById('cancel-ns').value;
                    const reason = document.getElementById('cancel-reason').value;
                    if (!ns) Swal.showValidationMessage('กรุณาเลือกชื่อผู้แจ้งยกเลิก');
                    else if (!reason) Swal.showValidationMessage('กรุณาระบุสาเหตุ');
                    return { ns, reason };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    window.updateStatus(id, 'cancel', { 
                        cancelBy: result.value.ns, 
                        cancelReason: result.value.reason, 
                        cancelDate: new Date().toISOString() 
                    });
                }
            });
        };

        window.actionCompleteSummary = function(id) {
            Swal.fire({
                title: 'ยืนยันจบงาน (Complete)',
                html: `
                    <div class="text-left">
                        <label class="text-sm font-bold text-gray-700 block mb-1">Project Code <span class="text-red-500">*</span></label>
                        <input id="comp-proj-code" class="swal2-input m-0 w-full text-sm" placeholder="ระบุเลข Project Code">
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#22c55e',
                confirmButtonText: 'บันทึก (Complete)',
                preConfirm: () => {
                    const code = document.getElementById('comp-proj-code').value;
                    if (!code) Swal.showValidationMessage('กรุณาระบุ Project Code');
                    return code;
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    window.updateStatus(id, 'complete', { 
                        projectCode: result.value,
                        progressPercent: 100, // Force 100% on complete
                        completeDate: new Date().toISOString() 
                    });
                }
            });
        };

        window.updateProgressSummary = function(id) {
            const item = assignments.find(a => a.id === id);
            if (!item) return;

            const steps = [
                { key: 'survey', label: 'สำรวจ', val: 10 },
                { key: 'plan', label: 'วางแผน', val: 10 },
                { key: 'req_approve', label: 'ขออนุมัติ', val: 10 },
                { key: 'approve', label: 'อนุมัติ', val: 10 },
                { key: 'plan_cm', label: 'Plan to CM', val: 10 },
                { key: 'cut_cable', label: 'ตัดถ่ายเคเบิล', val: 30 },
                { key: 'cleanup', label: 'เก็บงาน', val: 10 },
                { key: 'remove', label: 'รื้อสาย', val: 10 }
            ];

            const currentSteps = item.progressSteps || []; // Array of keys e.g. ['survey', 'plan']

            let checkboxes = steps.map(s => {
                const checked = currentSteps.includes(s.key) ? 'checked' : '';
                return `
                    <div class="flex items-center mb-2">
                        <input type="checkbox" id="step-${s.key}" value="${s.key}" class="w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500" ${checked}>
                        <label for="step-${s.key}" class="ml-2 text-sm text-gray-700 font-medium">${s.label} (${s.val}%)</label>
                    </div>
                `;
            }).join('');

            Swal.fire({
                title: 'อัปเดตความคืบหน้า (Progress)',
                html: `<div class="text-left mt-2 pl-4">${checkboxes}</div>`,
                showCancelButton: true,
                confirmButtonText: 'บันทึก',
                confirmButtonColor: '#3b82f6',
                preConfirm: () => {
                    const selected = [];
                    let total = 0;
                    steps.forEach(s => {
                        if (document.getElementById(`step-${s.key}`).checked) {
                            selected.push(s.key);
                            total += s.val;
                        }
                    });
                    return { steps: selected, percent: total > 100 ? 100 : total };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    window.updateStatus(id, 'process', { 
                        progressSteps: result.value.steps,
                        progressPercent: result.value.percent
                    });
                }
            });
        };

        window.actionReceivePlan = function(id) { window.updateStatus(id, 'process', { receiveDate: new Date().toISOString() }); };
        window.actionCompletePlan = function(id) { Swal.fire({ title: 'ยืนยันงานเสร็จสิ้น?', text: "ต้องการเปลี่ยนสถานะเป็น Complete ใช่หรือไม่", icon: 'question', showCancelButton: true, confirmButtonColor: '#22c55e', confirmButtonText: 'ตกลง (Yes)' }).then((result) => { if (result.isConfirmed) { window.updateStatus(id, 'complete', { completeDate: new Date().toISOString() }); } }); };
        window.actionUpdateFMS = function(id) { Swal.fire({ title: 'Update FMS', html: '<label class="block text-left text-sm mb-1">วันที่อัปเดต (Date)</label><input type="date" id="fms-date" class="swal2-input">', showCancelButton: true, preConfirm: () => { const d = document.getElementById('fms-date').value; if (!d) Swal.showValidationMessage('กรุณาใส่วันที่'); return d; } }).then((result) => { if (result.isConfirmed) { window.updateStatus(id, 'update_fms', { fmsDate: result.value }); } }); };
        window.actionCancelPlan = function(id) { const ops = (masterData.nsRespond || []).map(n => `<option value="${n}">${n}</option>`).join(''); Swal.fire({ title: 'Cancel Job', html: `<div class="text-left"><label class="text-sm font-bold text-gray-700">ผู้แจ้งยกเลิก (NS Respond)</label><select id="cancel-ns" class="swal2-select w-full m-0 mb-3 border border-gray-300 rounded p-2"><option value="">เลือกชื่อ...</option>${ops}</select><label class="text-sm font-bold text-gray-700">สาเหตุการยกเลิก (Reason)</label><input id="cancel-reason" class="swal2-input m-0 w-full" placeholder="ระบุสาเหตุ..."></div>`, showCancelButton: true, confirmButtonColor: '#ef4444', preConfirm: () => { const ns = document.getElementById('cancel-ns').value; const reason = document.getElementById('cancel-reason').value; if (!ns) Swal.showValidationMessage('กรุณาเลือกชื่อผู้แจ้งยกเลิก'); return { ns, reason }; } }).then((result) => { if (result.isConfirmed) { window.updateStatus(id, 'cancel', { cancelBy: result.value.ns, cancelReason: result.value.reason, cancelDate: new Date().toISOString() }); } }); };

        window.openModal = function(id = null) {
		 // FIX: ถ้ามี ID (โหมดแก้ไข) ให้ดึง Category จาก Item นั้นมาเซ็ตเป็น Context ก่อน
            if (id) {
                const existItem = assignments.find(a => a.id === id);
                if(existItem && existItem.category) {
                    currentCategoryFilter = existItem.category;
                }
            }
            $('#assignment-form')[0].reset(); $('#doc-id').val(''); $('.select2').val(null).trigger('change');
            if(!menuConfig[currentCategoryFilter] && currentCategoryFilter !== 'summary_dashboard') currentCategoryFilter = 'team'; 
            
            let targetCat = currentCategoryFilter === 'summary_dashboard' ? 'summary_plan' : currentCategoryFilter;
            const conf = menuConfig[targetCat];
            window.renderDropdowns();
            $('.group-sub, .plan-only, .team-only, .not-plan-only, .summary-plan-only').addClass('hidden');
            $('.summary-plan-hide').removeClass('hidden'); 
            
            // Reset Special Job View
            $('#rr-normal-view').removeClass('hidden');
            $('#rr-special-view').addClass('hidden');
            $('#form-manual-sub').empty().append('<option value="">เลือกผู้รับเหมา...</option>');
            $('#form-sub-name').removeData('original'); // Clear old data

            if(targetCat === 'summary_plan') {
                $('#form-agency').removeAttr('required');
                $('#label-agency').html('Agency Inf.'); 
            } else {
                $('#form-agency').attr('required', 'required');
                $('#label-agency').html('Agency Inf. <span class="text-red-500">*</span>');
            }

            if(targetCat === 'summary_plan' && !id) $('#summary-copy-actions').removeClass('hidden'); else $('#summary-copy-actions').addClass('hidden');
            
            if(conf.isSub) { 
                $('.group-sub').removeClass('hidden'); 
                $('.not-plan-only').removeClass('hidden'); 
                
                // Populate manual sub list for Special Job
                const subs = masterData.subcontractors || masterData.Subcontractors || [];
                subs.forEach(s => $('#form-manual-sub').append(new Option(s, s)));

                if(!id) {
                    $('#rr-action-buttons').show();
                    fetchRoundRobinState(); 
                } else {
                    $('#rr-action-buttons').hide();
                }
            } else if(targetCat === 'summary_plan') { 
                $('.summary-plan-only').removeClass('hidden'); 
                $('.summary-plan-hide').addClass('hidden'); 
            } else if(conf.isPlan) { 
                $('.plan-only').removeClass('hidden'); 
                $('.not-plan-only').addClass('hidden'); 
            } else { 
                $('.team-only').removeClass('hidden'); 
                $('.not-plan-only').removeClass('hidden'); 
            }
            
            if(id) { 
                const item = assignments.find(a => a.id === id); 
                if(item) { 
                    $('#doc-id').val(item.id); $('#form-internal-id').val(item.internalId);
                    $('#form-job-type').val(item.jobType); $('#form-desc').val(item.description); $('#form-agency').val(item.agency); 
                    
                    // Trigger change to handle Special Job view if editing
                    if(conf.isSub && item.jobType === 'Special Job') {
                        $('#rr-normal-view').addClass('hidden');
                        $('#rr-special-view').removeClass('hidden');
                        $('#form-manual-sub').val(item.subcontractor);
                    }

                    if (targetCat === 'summary_plan') {
                        $('#form-route-code').val(item.routeCode); $('#form-electric-district').val(item.electricDistrict); $('#form-route-name').val(item.routeName); $('#form-side-count').val(item.sideCount); $('#form-gps-start').val(item.gpsStart); $('#form-gps-end').val(item.gpsEnd); $('#form-distance').val(item.distance); $('#form-owner').val(item.owner); $('#form-cross-req').val(item.crossReq); $('#form-due-date-summary').val(item.dueDate); 
                        
                        const impactVal = item.symImpact;
                        if(impactVal && impactVal !== 'Impact' && impactVal !== 'Non Impact' && impactVal !== 'Other' && impactVal.trim() !== '') {
                            $('#form-sym-impact').val('Other').trigger('change');
                            $('#form-sym-impact-other').val(impactVal);
                        } else if (impactVal === 'Other') {
                             $('#form-sym-impact').val('Other').trigger('change');
                        } else {
                            $('#form-sym-impact').val(impactVal).trigger('change');
                            $('#form-sym-impact-other').val('');
                        }

                    } else if(conf.isPlan) {
                        $('#form-plan-date').val(item.planDate || ''); $('#form-plan-start').val(item.planStartTime || ''); $('#form-plan-end').val(item.planEndTime || ''); $('#form-sent-plan-date').val(item.sentPlanDate || ''); $('#form-unplanned-impact').val(item.unplannedImpact || ''); $('#form-team-req').val(item.teamReq); $('#form-interruption-id-cm').val(item.cmId); $('#form-project').val(item.project); $('#form-interruption-item').val(item.itemCount); 
                    } else {
                        $('#form-action-date').val(item.actionDate ? item.actionDate.slice(0,16) : '');
                    }
                    $('#form-location').val(item.location); $('#form-remark').val(item.remark); if(item.nsRespond) $('#form-ns-respond').val(item.nsRespond).trigger('change');
                    if(conf.isSub) { 
                        $('#form-objective').val(item.objective); $('#form-expenses').val(item.expenses); $('#form-route-code-sub').val(item.routeCode); 
                        $('#form-sub-name').val(item.subcontractor);
                        // FIX: เก็บค่า Original Subcontractor ไว้ใช้ตอนเปลี่ยน Job Type กลับมา
                        $('#form-sub-name').data('original', item.subcontractor);  
                        $('#rr-next-name').text(item.subcontractor); 
                        $('.rr-label.text-brand-600').text('ทีมที่รับงานนี้ (Assigned)'); 
                    }
                    else { $('#form-due-date').val(item.dueDate); $('#form-team-req').val(item.teamReq); $('#form-req-person').val(item.reqPerson); $('#form-ref-job-id').val(item.refJobId); $('#form-gps').val(item.gps); }
                    if(conf.isSub) $('#form-due-date-sub').val(item.dueDate);
                    if(item.fileName) { $('#file-name-display').text(item.fileName); }
                    if(item.fileUrl) { $('#existing-file-link').removeClass('hidden').find('a').attr('href', item.fileUrl); }
                    $('#modal-title').html('<span class="bg-brand-100 text-brand-600 p-2 rounded-lg mr-3"><i class="fa-solid fa-pen-to-square"></i></span> แก้ไขข้อมูล ' + conf.title); 
                }
            } else {
                 generateNextInternalId().then(newId => { $('#form-internal-id').val(newId); $('#display-internal-id').text(newId); });
                 
                 if(conf.isSub) { $('.rr-label.text-brand-600').text('ทีมที่ได้รับงานนี้ (Current)'); }
                 $('#modal-title').html('<span class="bg-brand-100 text-brand-600 p-2 rounded-lg mr-3"><i class="fa-solid fa-plus"></i></span> บันทึกงานใหม่ ' + conf.title);
                 $('#file-name-display').text('คลิกเพื่อเลือกไฟล์ หรือลากไฟล์มาวางที่นี่'); $('#existing-file-link').addClass('hidden');
            }
            $('#assignment-modal').removeClass('hidden'); 
        };

        window.closeModal = function() { $('#assignment-modal').addClass('hidden'); };
        window.toggleSidebar = function() { const s=document.getElementById('sidebar'); s.classList.toggle('-translate-x-full'); document.getElementById('sidebar-overlay').classList.toggle('hidden'); };
        
        window.toggleDesktopSidebar = function() {
            const s = document.getElementById('sidebar');
            const btn = document.getElementById('desktop-toggle-btn');
            
            if (s.classList.contains('lg:w-0')) {
                s.classList.remove('lg:w-0', 'lg:overflow-hidden', 'lg:border-none');
                btn.classList.remove('rotate-180');
            } else {
                s.classList.add('lg:w-0', 'lg:overflow-hidden', 'lg:border-none');
                btn.classList.add('rotate-180');
            }
        };

        window.toggleSubmenu = function(id, btn) { document.getElementById(id).classList.toggle('open'); btn.querySelector('.fa-chevron-down').classList.toggle('rotate-180'); };
        
        window.switchView = function(v) { currentView = v; updateView(); };
        
        window.updateView = function() { 
            $('.view-section').addClass('hidden'); 
            if(currentView==='dashboard_analytics') { $('#view-dashboard-analytics').removeClass('hidden'); renderDashboardCharts(); } 
            else if(currentView==='sub_dashboard') { $('#view-sub-dashboard').removeClass('hidden'); renderSubDashboardCharts(); } 
            else if(currentView==='summary_dashboard') { $('#view-summary-dashboard').removeClass('hidden'); renderSummaryDashboard(); } 
            else if(currentView==='calendar') { 
                $('#view-calendar').removeClass('hidden'); 
                window.renderCalendar(); 
            } 
            else if(currentView==='setting') { $('#view-setting').removeClass('hidden'); renderSettings(); } 
            else if(currentView==='link_support') { 
                $('#view-link-support').removeClass('hidden'); 
                renderLinkSupport(); 
            }
            else { 
                currentCategoryFilter=currentView; 
                $('#view-datatable').removeClass('hidden'); 
                const config = menuConfig[currentCategoryFilter];
                
                // Hide all dashboards first
                $('#sub-dashboard, #team-dashboard, #plan-dashboard, #summary-plan-dashboard').addClass('hidden');

                if (config && config.isSub) { 
                    $('#sub-dashboard').removeClass('hidden'); 
                    updateDashboard(); 
                } 
                else if (currentCategoryFilter === 'summary_plan') { 
                    // Show Summary Plan Job List Dashboard
                    $('#summary-plan-dashboard').removeClass('hidden'); 
                    updateDashboard();
                } 
                else if (config && config.isPlan) { 
                    $('#plan-dashboard').removeClass('hidden'); 
                    updateDashboard(); 
                } 
                else if (config && config.jobTypeKey === 'team') { 
                    $('#team-dashboard').removeClass('hidden'); 
                    updateDashboard(); 
                } 
                
                renderTable(); 
            }
            $('.nav-item').removeClass('bg-brand-50 text-brand-600 font-semibold active-nav');
            if(currentView === 'summary_plan' || currentView === 'summary_dashboard') {
                 $('#summary-menu').addClass('open');
                 $(`a[data-view="${currentView}"]`).addClass('bg-brand-50 text-brand-600 font-semibold active-nav');
            } else {
                 $(`a[data-view="${currentView}"]`).addClass('bg-brand-50 text-brand-600 font-semibold active-nav');
            }
        };

        async function fetchRoundRobinState() { if (!menuConfig[currentCategoryFilter]?.isSub) return; const subs = masterData.subcontractors || masterData.Subcontractors || []; if (subs.length === 0) { $('#rr-next-name').text('No Data'); return; } const rr = masterData.rrIndexes || {}; const catData = rr[currentCategoryFilter] || { index: 0, lastJob: '-' }; const idx = catData.index % subs.length; const prev = (idx - 1 + subs.length) % subs.length; $('#rr-prev-name').text(subs[prev]); $('#rr-prev-job').text(`Job: ${catData.lastJob}`); $('#rr-next-name').text(subs[idx]); $('#form-sub-name').val(subs[idx]); }
        async function updateRoundRobinIndex(isSkip, jobName) { const k = `rrIndexes.${currentCategoryFilter}`; const next = (masterData.rrIndexes?.[currentCategoryFilter]?.index || 0) + 1; await getSettingsRef().update({[k]: {index: next, lastJob: jobName}}).catch(() => getSettingsRef().set({rrIndexes:{[currentCategoryFilter]:{index:next, lastJob:jobName}}}, {merge:true})); fetchRoundRobinState(); }
        
        async function generateNextInternalId() {
            let targetCat = currentCategoryFilter === 'summary_dashboard' ? 'summary_plan' : currentCategoryFilter;
            const conf = menuConfig[targetCat];
            const now = new Date(); 
            const prefix = `${conf.prefix}${String(now.getFullYear()).slice(-2)}${String(now.getMonth()+1).padStart(2,'0')}`;
            
            const padLength = targetCat === 'summary_plan' ? 4 : 3;
            
            try { 
                const snapshot = await getAssignmentsRef().where('internalId', '>=', prefix).where('internalId', '<=', prefix + '\uf8ff').get(); 
                let maxNum = 0; 
                snapshot.forEach(doc => { 
                    const id = doc.data().internalId; 
                    if(id) { 
                        const num = parseInt(id.slice(prefix.length)); 
                        if(!isNaN(num) && num > maxNum) maxNum = num; 
                    } 
                }); 
                return `${prefix}${String(maxNum + 1).padStart(padLength, '0')}`; 
            } catch(e) { 
                const existingIds = assignments.filter(a => a.internalId && a.internalId.startsWith(prefix)).map(a => parseInt(a.internalId.slice(prefix.length))).sort((a,b) => b-a); 
                const nextNum = (existingIds.length > 0) ? existingIds[0] + 1 : 1; 
                return `${prefix}${String(nextNum).padStart(padLength, '0')}`; 
            }
        }
        
        window.skipRoundRobin = function() { const nsList = masterData.nsRespond || masterData.NsRespond || []; const ops = nsList.map(n => `<option value="${n}">${n}</option>`).join(''); Swal.fire({ title: 'ข้ามคิว', html: `<input id="sk-r" class="swal2-input" placeholder="สาเหตุ"><select id="sk-b" class="swal2-input"><option value="">ผู้รับผิดชอบ</option>${ops}</select>`, showCancelButton: true, preConfirm:()=>{ return {r:$('#sk-r').val(), b:$('#sk-b').val()} } }).then(r => { if(r.isConfirmed) updateRoundRobinIndex(true, `Skip: ${r.value.r}`); }); };
        window.resetRoundRobin = function() { Swal.fire({ title: 'Reset?', icon: 'warning', showCancelButton: true }).then(async r => { if(r.isConfirmed) { const k = `rrIndexes.${currentCategoryFilter}`; await getSettingsRef().update({[k]: {index:0, lastJob:'Reset'}}).catch(()=>getSettingsRef().set({rrIndexes:{[currentCategoryFilter]:{index:0, lastJob:'Reset'}}}, {merge:true})); fetchRoundRobinState(); } }); };
        window.addSettingItem = async function(key, inputId) { const value = $(`#${inputId}`).val(); if (!value) return; try { const ref = getSettingsRef(); const doc = await ref.get(); if (doc.exists) { await ref.update({ [key]: firebase.firestore.FieldValue.arrayUnion(value) }); } else { await ref.set({ [key]: [value] }, { merge: true }); } $(`#${inputId}`).val(''); Swal.fire({ icon: 'success', title: 'บันทึกเรียบร้อย', toast: true, position: 'top-end', showConfirmButton: false, timer: 1500 }); } catch (error) { console.error("Error adding setting:", error); Swal.fire('Error', 'บันทึกไม่สำเร็จ: ' + error.message, 'error'); } };
        window.removeSettingItem = function(k, v) { getSettingsRef().update({[k]: firebase.firestore.FieldValue.arrayRemove(v)}).catch(err => Swal.fire('Error', err.message, 'error')); };
        window.addNSRespond = function() { const n = $('#add-ns-name').val(); const p = $('#add-ns-phone').val(); if(n) { const val = p ? `${n} - ${p}` : n; getSettingsRef().update({nsRespond: firebase.firestore.FieldValue.arrayUnion(val)}).then(() => { $('#add-ns-name').val(''); $('#add-ns-phone').val(''); Swal.fire({ icon: 'success', title: 'เพิ่มข้อมูลเรียบร้อย', toast: true, position: 'top-end', showConfirmButton: false, timer: 1500 }); }).catch(err => Swal.fire('Error', err.message, 'error')); } };
        async function uploadToDrive(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = async function() { const content = reader.result.split(',')[1]; const formData = new URLSearchParams(); formData.append('action', 'upload'); formData.append('fileName', file.name); formData.append('mimeType', file.type); formData.append('fileData', content); try { const response = await fetch(GAS_URL, { method: 'POST', body: formData, redirect: 'follow' }); const result = await response.json(); if (result.status === 'success') { resolve(result.url); } else { reject(new Error(result.message)); } } catch (error) { reject(error); } }; reader.onerror = error => reject(error); reader.readAsDataURL(file); }); }
        async function sendToSheet(data, sheetName) { const fd = new URLSearchParams(); fd.append('action','save'); fd.append('sheetName',sheetName); fd.append('jobId',data.internalId); fd.append('fullData',JSON.stringify(data)); fetch(GAS_URL, {method:'POST', body:fd}); }
        window.confirmClearDatabase = function() { Swal.fire({title:'Reset All?', icon:'warning', showCancelButton:true}).then(r=>{ if(r.isConfirmed) { getAssignmentsRef().get().then(s=>{ s.forEach(d=>d.ref.delete()); }); initializeDatabase(true); } }); };
        function initializeDatabase(h) { const d = { nsRespond: ["Support"], subcontractors: ["Sub A", "Sub B"], rrIndexes: {} }; getSettingsRef().set(d, {merge:true}); }
        window.testConnection = function() { getSettingsRef().get().then(()=>Swal.fire('OK','Connected','success')).catch(e=>Swal.fire('Fail',e.message,'error')); };
        window.actionCancel = function(id) { Swal.fire({title: 'Cancel', input: 'text'}).then(r => { if(r.value) window.updateStatus(id, 'cancel', {cancelReason: r.value}); }); };
        window.actionAssign = function(id) { Swal.fire({title: 'Assign', input: 'text', inputPlaceholder: 'ระบุเลข AS'}).then(r => { if(r.value) { window.updateStatus(id, 'assign', { asNumber: r.value, assignDate: new Date().toISOString() }); } }); };
        window.actionApprove = function(id) { Swal.fire({title: 'Approve', text: 'ยืนยันการอนุมัติ?', showCancelButton:true}).then(r => { if(r.isConfirmed) { window.updateStatus(id, 'approve', { approveDate: new Date().toISOString() }); } }); };
        window.actionFinish = function(id) { Swal.fire({title: 'Finish', input: 'text', inputPlaceholder: 'ระบุเลข SSF'}).then(r => { if(r.value) { window.updateStatus(id, 'finish', { ssfNumber: r.value, ssfDate: new Date().toISOString() }); } }); };
        window.requestApprove = function(id) { 
            const item = assignments.find(a => a.id === id); if(!item) return; 
            let nextSubName = '-'; 
            if (masterData.subcontractors && masterData.rrIndexes) { const rr = masterData.rrIndexes[item.category]?.index || 0; const subList = masterData.subcontractors || []; if (subList.length > 0) nextSubName = subList[rr % subList.length]; } 
            const nsInfo = extractNS(item.nsRespond); const actionDateStr = fmtDate(item.actionDate); 
            let fileDisplay = '<span class="text-gray-400 text-sm italic">- ไม่มีไฟล์แนบ -</span>'; 
            if(item.fileUrl) { const isImg = item.fileUrl.match(/\.(jpeg|jpg|gif|png)$/i) || item.fileUrl.includes('googleusercontent') || item.fileUrl.includes('drive.google.com'); if(isImg) fileDisplay = `<img src="${item.fileUrl}" class="max-w-full h-auto rounded-lg border border-gray-300 shadow-sm mt-2 mx-auto" style="max-height: 250px;">`; else fileDisplay = `<div class="mt-2"><a href="${item.fileUrl}" target="_blank" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"><i class="fa-solid fa-file-arrow-down mr-2 text-brand-500"></i> เปิดไฟล์แนบ</a></div>`; } 
            const html = `<div class="text-left font-prompt text-sm space-y-2 select-text"><div class="text-center font-bold text-xl text-gray-800 mb-4 border-b pb-3 border-gray-200"><i class="fa-solid fa-file-invoice-dollar text-yellow-500 mr-2"></i> รายการอนุมัติค่าใช้จ่าย</div><div class="grid grid-cols-12 gap-2 items-center"><div class="col-span-1 text-center text-gray-400"><i class="fa-solid fa-id-card"></i></div><div class="col-span-4 font-bold text-gray-600">Job ID :</div><div class="col-span-7 font-mono font-bold text-gray-800">${item.internalId}</div></div><div class="grid grid-cols-12 gap-2 items-center"><div class="col-span-1 text-center text-gray-400"><i class="fa-solid fa-helmet-safety"></i></div><div class="col-span-4 font-bold text-gray-600">ผู้รับเหมา :</div><div class="col-span-7"><span class="border-2 border-red-500 text-red-600 font-bold px-2 py-0.5 rounded bg-red-50 inline-block shadow-sm">${item.subcontractor || '-'}</span></div></div><div class="grid grid-cols-12 gap-2 items-start"><div class="col-span-1 text-center text-gray-400 mt-1"><i class="fa-solid fa-tools"></i></div><div class="col-span-4 font-bold text-gray-600 mt-1">ประเภทงาน :</div><div class="col-span-7">${item.jobType}</div></div><div class="grid grid-cols-12 gap-2 items-start"><div class="col-span-1 text-center text-gray-400 mt-1"><i class="fa-solid fa-comment-alt"></i></div><div class="col-span-4 font-bold text-gray-600 mt-1">ชื่องาน :</div><div class="col-span-7">${item.description}</div></div><div class="grid grid-cols-12 gap-2 items-start"><div class="col-span-1 text-center text-gray-400 mt-1"><i class="fa-solid fa-building"></i></div><div class="col-span-4 font-bold text-gray-600 mt-1">หน่วยงานแจ้ง :</div><div class="col-span-7">${item.agency || '-'}</div></div><div class="grid grid-cols-12 gap-2 items-center"><div class="col-span-1 text-center text-gray-400"><i class="fa-solid fa-route"></i></div><div class="col-span-4 font-bold text-gray-600">Code :</div><div class="col-span-7 font-mono">${item.routeCode || '-'}</div></div><div class="grid grid-cols-12 gap-2 items-center bg-yellow-50 p-1.5 rounded-lg -mx-2"><div class="col-span-1 text-center text-gray-400"><i class="fa-solid fa-coins text-yellow-600"></i></div><div class="col-span-4 font-bold text-gray-600">ประมาณราคา :</div><div class="col-span-7"><span class="border-2 border-red-500 text-red-600 font-bold px-2 py-0.5 rounded bg-white inline-block shadow-sm">${(item.expenses || '0').toLocaleString()} ฿</span></div></div><div class="grid grid-cols-12 gap-2 items-center"><div class="col-span-1 text-center text-gray-400"><i class="fa-solid fa-calendar-day"></i></div><div class="col-span-4 font-bold text-gray-600">วันดำเนินการ :</div><div class="col-span-7 text-blue-600 font-medium">${actionDateStr}</div></div><div class="grid grid-cols-12 gap-2 items-start"><div class="col-span-1 text-center text-gray-400 mt-1"><i class="fa-solid fa-user-tie"></i></div><div class="col-span-4 font-bold text-gray-600 mt-1">ผู้รับผิดชอบ :</div><div class="col-span-7">${nsInfo.names}</div></div><div class="grid grid-cols-12 gap-2 items-center"><div class="col-span-1 text-center text-gray-400"><i class="fa-solid fa-phone"></i></div><div class="col-span-4 font-bold text-gray-600">เบอร์โทร :</div><div class="col-span-7">${nsInfo.phones}</div></div><div class="grid grid-cols-12 gap-2 items-center mt-2 pt-2 border-t border-gray-100"><div class="col-span-1 text-center text-gray-400"><i class="fa-solid fa-forward text-brand-500"></i></div><div class="col-span-4 font-bold text-gray-600">ทีมถัดไป :</div><div class="col-span-7"><span class="border-2 border-red-500 text-red-600 font-bold px-2 py-0.5 rounded bg-white inline-block shadow-sm">${nextSubName}</span></div></div><div class="mt-4 pt-3 border-t-2 border-dashed border-gray-200 text-center"><div class="font-bold text-gray-500 mb-2 text-xs uppercase tracking-wider">ไฟล์แนบ (Attachment)</div>${fileDisplay}</div></div>`; Swal.fire({ title: '', html: html, width: '550px', showCancelButton: true, confirmButtonText: '<i class="fa-brands fa-line text-lg mr-2"></i> Copy for LINE', confirmButtonColor: '#06c755', cancelButtonText: 'ปิด', customClass: { container: 'font-sans', popup: 'rounded-2xl' } }).then((result) => { if(result.isConfirmed) { const text = `💸 รายการอนุมัติค่าใช้จ่าย\n🆔 Job ID : ${item.internalId}\n👷 ผู้รับเหมาที่รับผิดชอบ : 🟥 ${item.subcontractor || '-'} 🟥\n🛠️ ประเภทงาน : ${item.jobType}\n📝 ชื่องาน : ${item.description}\n🏢 หน่วยงานที่แจ้ง : ${item.agency || '-'}\n🔢 Code : ${item.routeCode || '-'}\n💰 ประมาณราคา : 🟥 ${(item.expenses || '0').toLocaleString()} ฿ 🟥\n📅 วันที่และเวลาที่ดำเนินการ : ${actionDateStr}\n👤 ผู้รับผิดชอบ : ${nsInfo.names}\n📞 เบอร์โทร : ${nsInfo.phones}\n⏭️ ผู้รับเหมาถัดไป : 🟥 ${nextSubName} 🟥\n📎 ไฟล์แนบ : ${item.fileUrl || '-'}`; fallbackCopyTextToClipboard(text); } }); };
        window.exportExcel = function() { const dt = document.getElementById('data-table'); if(!dt || dt.rows.length <= 1) { Swal.fire('Info','ไม่มีข้อมูลให้ Export','info'); return; } const wb = XLSX.utils.table_to_book(dt, {sheet: "Data"}); XLSX.writeFile(wb, 'Assignment_Data.xlsx'); };
        window.getLocation = function() { if(!navigator.geolocation) { Swal.fire('Error','Browser not support','error'); return; } $.LoadingOverlay("show"); navigator.geolocation.getCurrentPosition(p => { $.LoadingOverlay("hide"); const loc = `${p.coords.latitude},${p.coords.longitude}`; const url = `https://www.google.com/maps?q=${loc}`; const old = $('#form-gps').val(); $('#form-gps').val(old ? old + '\n' + url : url); }, e => { $.LoadingOverlay("hide"); Swal.fire('Error',e.message,'error'); }); };
        window.saveAssignment = async function() { 
            $.LoadingOverlay("show", { text: "Processing..." });
            const docId = $('#doc-id').val();
            // Use local mapping if in dashboard mode
            let saveCat = currentCategoryFilter === 'summary_dashboard' ? 'summary_plan' : currentCategoryFilter;
            const config = menuConfig[saveCat];
            if (!config) { $.LoadingOverlay("hide"); Swal.fire('Error','Please select a menu first','error'); return; }
            
            let fileUrl = $('#form-file-url').val();
            const fileInput = $('#form-file')[0];
            if (fileInput.files.length > 0) { try { $.LoadingOverlay("text", "Uploading to Drive..."); fileUrl = await uploadToDrive(fileInput.files[0]); } catch (uploadError) { $.LoadingOverlay("hide"); Swal.fire('Upload Failed', 'Cannot upload file to Drive. Please try again.', 'error'); return; } }
            let data = { category: saveCat || '', internalId: $('#form-internal-id').val() || '', updatedAt: firebase.firestore.FieldValue.serverTimestamp(), jobType: $('#form-job-type').val() || '', description: $('#form-desc').val() || '', agency: $('#form-agency').val() || '', location: $('#form-location').val() || '', remark: $('#form-remark').val() || '', nsRespond: $('#form-ns-respond').val() || [], };
            if (saveCat === 'summary_plan') {
                data.routeCode = $('#form-route-code').val(); data.electricDistrict = $('#form-electric-district').val(); data.routeName = $('#form-route-name').val(); data.sideCount = $('#form-side-count').val(); data.gpsStart = $('#form-gps-start').val(); data.gpsEnd = $('#form-gps-end').val(); data.distance = $('#form-distance').val(); data.owner = $('#form-owner').val(); data.crossReq = $('#form-cross-req').val(); data.dueDate = $('#form-due-date-summary').val(); 
                
                // Save Sym Impact Logic
                let symVal = $('#form-sym-impact').val();
                if(symVal === 'Other') {
                    symVal = $('#form-sym-impact-other').val();
                }
                data.symImpact = symVal;

                const existingItem = docId ? assignments.find(a => a.id === docId) : null; data.actionDate = existingItem ? existingItem.actionDate : new Date().toISOString(); data.planDate = null; data.planStartTime = null; data.planEndTime = null;
            } else if (config.isPlan) {
                const pDate = $('#form-plan-date').val(); const pStart = $('#form-plan-start').val(); const pEnd = $('#form-plan-end').val(); data.actionDate = (pDate && pStart) ? `${pDate}T${pStart}` : (pDate ? `${pDate}T00:00` : new Date().toISOString()); data.planDate = pDate; data.planStartTime = pStart; data.planEndTime = pEnd; data.sentPlanDate = $('#form-sent-plan-date').val(); data.unplannedImpact = $('#form-unplanned-impact').val(); data.cmId = $('#form-interruption-id-cm').val() || ''; data.project = $('#form-project').val() || ''; data.itemCount = $('#form-interruption-item').val() || ''; data.teamReq = $('#form-team-req').val() || ''; data.gps = ''; data.fileName = ''; data.fileUrl = '';
            } else {
                data.actionDate = $('#form-action-date').val() || ''; data.fileName = $('#file-name-display').text() || ''; data.fileUrl = fileUrl || ''; data.gps = $('#form-gps').val() || '';
                if (config.isSub) { 
                    data.dueDate = $('#form-due-date-sub').val() || ''; 
                    data.objective = $('#form-objective').val() || ''; 
                    data.expenses = $('#form-expenses').val() || ''; 
                    data.routeCode = $('#form-route-code-sub').val() || ''; 
                    data.subcontractor = $('#form-sub-name').val() || ''; 
                }
                else { data.dueDate = $('#form-due-date').val() || ''; data.teamReq = $('#form-team-req').val() || ''; data.reqPerson = $('#form-req-person').val() || ''; data.refJobId = $('#form-ref-job-id').val() || ''; }
            }
            if(!docId) { data.createdAt = firebase.firestore.FieldValue.serverTimestamp(); data.status = 'new'; }
            try {
                const nowIso = new Date().toISOString();
                if(docId) {
                    await getAssignmentsRef().doc(docId).update(data);
                    const existingItem = assignments.find(a => a.id === docId);
                    if (existingItem) { const mergedData = { ...existingItem, ...data }; mergedData.updatedAt = nowIso; await sendToSheet(mergedData, config.sheetName); } 
                    else { data.updatedAt = nowIso; await sendToSheet(data, config.sheetName); }
                } else {
                    await getAssignmentsRef().add(data);
                    // แก้ไข: ถ้าเป็น Special Job ไม่ต้องอัปเดต Round Robin
                    if(config.isSub && !docId && data.jobType !== 'Special Job') { 
                        await updateRoundRobinIndex(false, data.description); 
                    }
                    let sheetData = { ...data }; sheetData.createdAt = nowIso; sheetData.updatedAt = nowIso; await sendToSheet(sheetData, config.sheetName); 
                }
                $.LoadingOverlay("hide"); closeModal(); Swal.fire('Saved', '', 'success');
            } catch(e) { $.LoadingOverlay("hide"); Swal.fire('Error', e.message, 'error'); }
        };
        window.updateStatus = function(id, status, extra) { $.LoadingOverlay("show"); getAssignmentsRef().doc(id).update({status: status, ...extra}).then(async () => { const item = assignments.find(a => a.id === id); if(item) { const u = {...item, status, ...extra}; const c = menuConfig[u.category]; if(c) await sendToSheet(u, c.sheetName); } $.LoadingOverlay("hide"); }).catch(e => { $.LoadingOverlay("hide"); Swal.fire('Error',e.message,'error'); }); };
        window.deleteAssignment = function(id) { Swal.fire({ title: 'Delete?', icon: 'warning', showCancelButton: true }).then((r) => { if (r.isConfirmed) getAssignmentsRef().doc(id).delete(); }); };
        window.viewDetail = function(id) { 
            const item = assignments.find(a => a.id === id); if(!item) return; const nsInfo = extractNS(item.nsRespond); const conf = menuConfig[item.category]; const isSub = conf && conf.isSub; const isPlan = conf && conf.isPlan; const fileLink = item.fileUrl ? `<a href="${item.fileUrl}" target="_blank" class="text-blue-500 hover:underline break-all">${item.fileUrl}</a>` : '-'; const fileDisplay = (item.fileUrl && (item.fileUrl.match(/\.(jpeg|jpg|gif|png)$/) != null || item.fileUrl.includes('googleusercontent') || item.fileUrl.includes('drive.google.com'))) ? `<br><img src="${item.fileUrl}" class="mt-2 rounded-lg max-h-48 object-cover border border-gray-200" alt="Attached Image">` : ''; 
            
            // FIX: แก้ไขการคำนวณ Next Team ให้เป็น Relative ต่อจากงานนี้ ไม่ใช่ Global Index
            let nextSubName = '-'; 
            if (isSub && masterData.subcontractors) { 
                const subList = masterData.subcontractors || []; 
                if (subList.length > 0) {
                    const currentSub = item.subcontractor;
                    const currentIndex = subList.indexOf(currentSub);
                    if (currentIndex !== -1) {
                         // ถ้าหาเจอ ให้เอาตัวถัดไปในลิสต์ (วนกลับถ้าสุด)
                         nextSubName = subList[(currentIndex + 1) % subList.length];
                    }
                }
            } 
            
            const createdStr = item.createdAt ? fmtDate(item.createdAt) : '-'; const actionDateStr = fmtDate(item.actionDate); let html = `<div class="text-left text-sm space-y-3 font-prompt">`;
            
			 if (item.category === 'summary_plan') {
                 html += `
                   <div class="font-bold text-lg border-b pb-2 mb-3 text-brand-600 flex items-center"><i class="fa-solid fa-file-contract mr-2"></i> รายละเอียดงาน (Project Plan)</div>
                   <div class="grid grid-cols-12 gap-2 items-start"><div class="col-span-4 text-gray-500 font-bold">Job ID :</div><div class="col-span-8 font-mono font-bold text-gray-800">${item.internalId}</div></div>
                   <div class="grid grid-cols-12 gap-2 items-start"><div class="col-span-4 text-gray-500 font-bold">Job Type :</div><div class="col-span-8">${item.jobType || '-'}</div></div>
                   <div class="grid grid-cols-12 gap-2 items-start"><div class="col-span-4 text-gray-500 font-bold">Project Code :</div><div class="col-span-8 text-blue-600 font-bold">${item.projectCode || '-'}</div></div>
                   <div class="grid grid-cols-12 gap-2 items-start"><div class="col-span-4 text-gray-500 font-bold">Route Code :</div><div class="col-span-8 font-mono text-gray-700">${item.routeCode || '-'}</div></div>
                   <div class="grid grid-cols-12 gap-2 items-start"><div class="col-span-4 text-gray-500 font-bold">Route Name :</div><div class="col-span-8">${item.routeName || '-'}</div></div>
                   <div class="grid grid-cols-12 gap-2 items-start"><div class="col-span-4 text-gray-500 font-bold">Electric Dist. :</div><div class="col-span-8">${item.electricDistrict || '-'}</div></div>
                   <div class="grid grid-cols-12 gap-2 items-start"><div class="col-span-4 text-gray-500 font-bold">Side Count :</div><div class="col-span-8">${item.sideCount || '-'}</div></div>
                   <div class="grid grid-cols-12 gap-2 items-start"><div class="col-span-4 text-gray-500 font-bold">Distance :</div><div class="col-span-8 font-bold">${item.distance || '-'} km.</div></div>
                   <div class="grid grid-cols-12 gap-2 items-start"><div class="col-span-4 text-gray-500 font-bold">Owner :</div><div class="col-span-8">${item.owner || '-'}</div></div>
                   <div class="grid grid-cols-12 gap-2 items-start"><div class="col-span-4 text-gray-500 font-bold">Cross Req :</div><div class="col-span-8">${item.crossReq || '-'}</div></div>
                   <div class="grid grid-cols-12 gap-2 items-start"><div class="col-span-4 text-gray-500 font-bold">Sym Impact :</div><div class="col-span-8 text-orange-600 font-bold">${item.symImpact || '-'}</div></div>
                   <div class="grid grid-cols-12 gap-2 items-start"><div class="col-span-4 text-gray-500 font-bold">GPS Start :</div><div class="col-span-8 text-xs font-mono break-all text-gray-600 bg-gray-50 p-1 rounded">${item.gpsStart || '-'}</div></div>
                   <div class="grid grid-cols-12 gap-2 items-start"><div class="col-span-4 text-gray-500 font-bold">GPS End :</div><div class="col-span-8 text-xs font-mono break-all text-gray-600 bg-gray-50 p-1 rounded">${item.gpsEnd || '-'}</div></div>
                   <div class="grid grid-cols-12 gap-2 items-start"><div class="col-span-4 text-gray-500 font-bold">Due Date :</div><div class="col-span-8">${item.dueDate ? fmtDate(item.dueDate, true) : '-'}</div></div>
                   <div class="grid grid-cols-12 gap-2 items-start"><div class="col-span-4 text-gray-500 font-bold">Progress :</div><div class="col-span-8"><span class="inline-block px-2 py-0.5 rounded text-white text-xs ${item.progressPercent===100?'bg-green-500':'bg-yellow-500'}">${item.progressPercent || '0'}%</span></div></div>
                   <div class="grid grid-cols-12 gap-2 items-start"><div class="col-span-4 text-gray-500 font-bold">NS Respond :</div><div class="col-span-8">${nsInfo.names}</div></div>
                   <div class="grid grid-cols-12 gap-2 items-start"><div class="col-span-4 text-gray-500 font-bold">Remark :</div><div class="col-span-8 text-gray-600 italic">${item.remark || '-'}</div></div>
                   <div class="mt-3 pt-3 border-t border-dashed border-gray-200"><div class="font-bold text-gray-500 mb-1"><i class="fa-solid fa-paperclip mr-1"></i> ไฟล์แนบ :</div><div class="text-xs">${fileLink}${fileDisplay}</div></div>
                 `;
             } else if (isSub) {
                html += `
                   <div class="font-bold text-lg border-b pb-2 mb-3 text-brand-600 flex items-center"><i class="fa-solid fa-clipboard-check mr-2"></i> รายการงานใหม่ (${conf.title})</div>
                   <div class="grid grid-cols-3 gap-1 items-start"><div class="col-span-1 text-gray-500 font-bold"><i class="fa-regular fa-clock mr-1"></i> วันที่บันทึก :</div><div class="col-span-2">${createdStr}</div></div>
                   <div class="grid grid-cols-3 gap-1 items-start"><div class="col-span-1 text-gray-500 font-bold"><i class="fa-solid fa-fingerprint mr-1"></i> Job ID :</div><div class="col-span-2 font-mono font-bold text-gray-800">${item.internalId}</div></div>
                   <div class="grid grid-cols-3 gap-1 items-center"><div class="col-span-1 text-gray-500 font-bold"><i class="fa-solid fa-helmet-safety mr-1"></i> ผู้รับเหมา :</div><div class="col-span-2"><span class="border-2 border-red-500 text-red-600 font-bold px-2 py-0.5 rounded bg-red-50 inline-block shadow-sm">${item.subcontractor || '-'}</span></div></div>
                   <div class="grid grid-cols-3 gap-1 items-start"><div class="col-span-1 text-gray-500 font-bold"><i class="fa-solid fa-screwdriver-wrench mr-1"></i> ประเภทงาน :</div><div class="col-span-2">${item.jobType}</div></div>
                   <div class="grid grid-cols-3 gap-1 items-start"><div class="col-span-1 text-gray-500 font-bold"><i class="fa-solid fa-align-left mr-1"></i> ชื่องาน :</div><div class="col-span-2">${item.description}</div></div>
                   <div class="grid grid-cols-3 gap-1 items-start"><div class="col-span-1 text-gray-500 font-bold"><i class="fa-solid fa-calendar-days mr-1"></i> ดำเนินการ :</div><div class="col-span-2 text-blue-600 font-medium">${actionDateStr}</div></div>
                   <div class="grid grid-cols-3 gap-1 items-start"><div class="col-span-1 text-gray-500 font-bold"><i class="fa-solid fa-location-dot mr-1"></i> สถานที่ :</div><div class="col-span-2">${item.location || '-'}</div></div>
                   <div class="grid grid-cols-3 gap-1 items-start"><div class="col-span-1 text-gray-500 font-bold"><i class="fa-solid fa-map-location-dot mr-1"></i> GPS :</div><div class="col-span-2 text-xs font-mono break-all bg-gray-100 p-1 rounded">${item.gps || '-'}</div></div>
                   <div class="grid grid-cols-3 gap-1 items-start"><div class="col-span-1 text-gray-500 font-bold"><i class="fa-solid fa-user-tag mr-1"></i> ผู้รับผิดชอบ :</div><div class="col-span-2">${nsInfo.names}</div></div>
                   <div class="grid grid-cols-3 gap-1 items-start"><div class="col-span-1 text-gray-500 font-bold"><i class="fa-solid fa-phone mr-1"></i> เบอร์โทร :</div><div class="col-span-2">${nsInfo.phones}</div></div>
                   <div class="grid grid-cols-3 gap-1 items-center bg-orange-50 p-2 rounded-lg border border-orange-100 mt-2"><div class="col-span-1 text-gray-600 font-bold"><i class="fa-solid fa-forward mr-1"></i> ทีมถัดไป :</div><div class="col-span-2"><span class="border-2 border-red-500 text-red-600 font-bold px-2 py-0.5 rounded bg-white inline-block shadow-sm">${nextSubName}</span></div></div>
                   <div class="mt-2 pt-2 border-t border-dashed border-gray-200"><div class="font-bold text-gray-500 mb-1"><i class="fa-solid fa-paperclip mr-1"></i> ไฟล์แนบ :</div><div class="text-xs">${fileLink}${fileDisplay}</div></div>`;
            } else if (isPlan) {
                 html += `<div class="font-bold border-b pb-2 mb-2">📋 Interruption Plan Detail</div><div>🆔 Job ID : ${item.internalId}</div><div>🛠️ Project : ${item.project || '-'}</div><div>📝 Description : ${item.description}</div><div>📅 Action Date : ${fmtDate(item.planDate, true)}</div><div>⏰ Time : ${(item.planStartTime && item.planEndTime) ? item.planStartTime + ' - ' + item.planEndTime : '-'}</div><div>📨 Sent Plan : ${fmtDate(item.sentPlanDate, true)}</div><div>💥 Impact : ${item.unplannedImpact || '-'}</div><div>👤 NS : ${nsInfo.names}</div>`;
            } else {
                 html += `<div class="font-bold border-b pb-2 mb-2">🆕 รายการงานใหม่</div><div>📅 วันที่บันทึก : ${createdStr}</div><div>🆔 Job ID : ${item.internalId}</div><div>👷 ผู้รับเหมา : ${item.subcontractor || '-'}</div><div>🛠️ ประเภทงาน : ${item.jobType}</div><div>📝 ชื่องาน : ${item.description}</div><div>🕒 วันที่ดำเนินการ : ${actionDateStr}</div><div>📍 สถานที่ : ${item.location}</div><div class="whitespace-pre-line">🟢 GPS : ${item.gps || '-'}</div><div>👤 ผู้รับผิดชอบ : ${nsInfo.names}</div><div>📞 เบอร์โทร : ${nsInfo.phones}</div><div>📎 ไฟล์แนบ : ${fileLink}</div>`;
            }
			
			// --- NEW: Add Action Buttons to Popup ---
            const actionButtons = window.getActionButtons(item, isSub, isPlan);
            const editButton = `<button onclick="Swal.close(); openModal('${item.id}')" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 transition shadow-sm"><i class="fa-solid fa-pen-to-square mr-1"></i> แก้ไข (Edit)</button>`;
            
            html += `
                <div class="mt-4 pt-3 border-t border-gray-200">
                    <div class="font-bold text-gray-500 mb-2 text-xs uppercase tracking-wider text-center">จัดการงาน (Actions)</div>
                    <div class="flex flex-wrap justify-center gap-2 items-center">
                        ${actionButtons !== '-' ? actionButtons : ''}
                        ${editButton}
                    </div>
                </div>
            `;
            // ----------------------------------------
			
            html += `</div>`;
            Swal.fire({ title: '', html: html, showCancelButton: true, confirmButtonText: '<i class="fa-regular fa-copy"></i> Copy Text', confirmButtonColor: '#06c755', cancelButtonText: 'ปิด', customClass: { container: 'font-sans', popup: 'rounded-2xl' } }).then(r => { if(r.isConfirmed) { let text = ''; 
            if (item.category === 'summary_plan') {
                text = `📋 Project Plan Detail\n🆔 Job ID: ${item.internalId}\n🛠️ Type: ${item.jobType}\n🛣️ Route: ${item.routeName} (${item.routeCode})\n📏 Dist: ${item.distance} km\n📅 Due: ${item.dueDate ? fmtDate(item.dueDate, true) : '-'}\n💥 Impact: ${item.symImpact}\n👤 NS: ${nsInfo.names}`;
            } else if (isSub) { text = `🆕 รายการงานใหม่\n📅 วันที่บันทึก : ${createdStr}\n🆔 Job ID : ${item.internalId}\n👷 ผู้รับเหมาที่รับผิดชอบ : 🟥 ${item.subcontractor || '-'} 🟥\n🛠️ ประเภทงาน : ${item.jobType}\n📝 ชื่องาน : ${item.description}\n🕒 วันที่และเวลาที่ดำเนินการ : ${actionDateStr}\n📍 สถานที่ : ${item.location || '-'}\n🟢 GPS : ${item.gps || '-'}\n👤 ผู้รับผิดชอบ : ${nsInfo.names}\n📞 เบอร์โทร : ${nsInfo.phones}\n⏭️ ผู้รับเหมาถัดไป : 🟥 ${nextSubName} 🟥\n📎 ไฟล์แนบ : ${item.fileUrl || '-'}`; } else if (isPlan) { text = `Job ID: ${item.internalId}\nDesc: ${item.description}\nDate: ${fmtDate(item.actionDate)}`; } else { text = `🆕 รายการงานใหม่\nJob ID: ${item.internalId}\nDesc: ${item.description}\nDate: ${actionDateStr}`; } fallbackCopyTextToClipboard(text); } });
        };
			
        window.showJobDetail = function(id) { window.viewDetail(id); };
        function fallbackCopyTextToClipboard(text) { const textArea = document.createElement("textarea"); textArea.value = text; textArea.style.top = "0"; textArea.style.left = "0"; textArea.style.position = "fixed"; document.body.appendChild(textArea); textArea.focus(); textArea.select(); try { const successful = document.execCommand('copy'); const msg = successful ? 'successful' : 'unsuccessful'; Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'คัดลอกข้อความแล้ว', showConfirmButton: false, timer: 1500 }); } catch (err) { console.error('Fallback: Oops, unable to copy', err); } document.body.removeChild(textArea); }
        
        // NEW: Function to update sidebar notification badges
        window.updateSidebarBadges = function() {
            // Categories to track
            const cats = ['plan_interruption', 'summary_plan', 'team', 'sub_preventive', 'sub_reroute', 'sub_reconfigure'];
            
            // Reset counts
            const counts = {};
            cats.forEach(c => counts[c] = 0);

            // Calculate 'new' jobs
            assignments.forEach(a => {
                if (a.status === 'new' && counts[a.category] !== undefined) {
                    counts[a.category]++;
                }
            });

            // Update Leaf Badges
            cats.forEach(c => {
                const el = $(`#badge-${c}`);
                if (counts[c] > 0) {
                    el.text(counts[c]).removeClass('hidden');
                } else {
                    el.addClass('hidden');
                }
            });
            
            // Update Parent Menu Badges (Sum of children)
            // 1. Project Plan Parent
            const sumPlan = counts['summary_plan'];
            const badgeSumPlan = $('#badge-parent-summary');
            if(sumPlan > 0) badgeSumPlan.text(sumPlan).removeClass('hidden'); 
            else badgeSumPlan.addClass('hidden');

            // 2. Subcontractor Parent
            const sumSub = counts['sub_preventive'] + counts['sub_reroute'] + counts['sub_reconfigure'];
            const badgeSub = $('#badge-parent-sub');
            if(sumSub > 0) badgeSub.text(sumSub).removeClass('hidden'); 
            else badgeSub.addClass('hidden');
        };

        async function initAuth() { 
            try { 
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { 
                    await auth.signInWithCustomToken(__initial_auth_token); 
                } else { 
                    await auth.signInAnonymously(); 
                } 
                auth.onAuthStateChanged(user => { 
                    if(user) { 
                        $('#status-text').text('Online').parent().addClass('bg-green-100 text-green-700'); 
                        getAssignmentsRef().onSnapshot(snap => { 
                            assignments = []; 
                            snap.forEach(d => assignments.push({id:d.id, ...d.data()})); 
                            assignments.sort((a,b)=>(b.internalId||'').localeCompare(a.internalId||'')); 
                            
                            // Call Badge Update here
                            window.updateSidebarBadges();
                            
                            window.updateView(); 
                        }, err => console.error("Snapshot Error:", err)); 
                        
                        getSettingsRef().onSnapshot(doc => { 
                            if(doc.exists) { 
                                masterData = doc.data(); 
                                window.renderDropdowns(); 
                                if(currentView === 'setting') window.renderSettings(); 
                            } else { 
                                initializeDatabase(false); 
                            } 
                        }, err => console.error("Settings Error:", err)); 
                    } 
                }); 
            } catch (e) { 
                console.error("Auth Error:", e); 
                Swal.fire('Connection Error', e.message, 'error'); 
            } 
        }
        
        $(document).ready(function() { 
            $('.select2').select2({ placeholder: "เลือกชื่อ", allowClear: true }); 
            $('#search-input').on('input', function() { currentPage = 1; renderTable(); }); 
            $('#filter-status').on('change', function() { currentPage = 1; renderTable(); }); 
            initAuth(); 
            $('#form-file').change(function(e) { $('#file-name-display').text(e.target.files[0] ? e.target.files[0].name : 'Click to upload'); }); 
            document.getElementById('sidebar-overlay').addEventListener('click', toggleSidebar); 
            ['#form-job-type', '#form-agency', '#form-team-req'].forEach(id => { $(id).change(function() { if($(this).val() === 'Other') $(id + '-other').addClass('show'); else $(id + '-other').removeClass('show'); }); }); 
            
            // Auto-populate Summary Dashboard Job Type Filter
            const sumDashSelect = $('#sum-dash-jobtype');
            if(sumDashSelect.length) {
                CONST_DATA.jobTypes.summary_plan.forEach(t => {
                    sumDashSelect.append(new Option(t, t));
                });
            }

            // Logic เปลี่ยนกล่อง Round Robin ตาม Job Type
            $('#form-job-type').change(function() {
                const val = $(this).val();
                const isSubMenu = menuConfig[currentCategoryFilter]?.isSub;
                if (isSubMenu) {
                    if (val === 'Special Job') {
                        $('#rr-normal-view').addClass('hidden');
                        $('#rr-special-view').removeClass('hidden');
                        // Reset sub name so user must select manually
                        $('#form-sub-name').val($('#form-manual-sub').val()); 
                    } else {
                        $('#rr-normal-view').removeClass('hidden');
                        $('#rr-special-view').addClass('hidden');
                        
                        // FIX: ตรวจสอบว่าอยู่ในโหมดแก้ไขหรือไม่
                        const docId = $('#doc-id').val();
                        if (!docId) {
                             // ถ้าเป็นงานใหม่ ให้ดึงคิวล่าสุด
                             fetchRoundRobinState();
                        } else {
                             // ถ้าแก้ไข ให้คืนค่าเดิมที่เคยบันทึกไว้ (ไม่ดึงคิวใหม่)
                             const originalSub = $('#form-sub-name').data('original');
                             if(originalSub) {
                                 $('#form-sub-name').val(originalSub);
                                 $('#rr-next-name').text(originalSub);
                             }
                        }
                    }
                }
            });

            // Sym Impact Other Toggle
            $('#form-sym-impact').change(function() {
                if($(this).val() === 'Other') $('#form-sym-impact-other').addClass('show');
                else $('#form-sym-impact-other').removeClass('show');
            });

            // Link Support Type Toggle
            $('#ls-type').change(function() {
                if($(this).val() === 'Other') {
                    $('#ls-type-other').removeClass('hidden').addClass('block').focus();
                } else {
                    $('#ls-type-other').addClass('hidden').removeClass('block');
                }
            });
        });
        
    </script>
</body>
</html>


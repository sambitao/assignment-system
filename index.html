<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assignment System (V.50 Logo Fix)</title>
    
    <!-- CSS & Libs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 50:'#fff7ed', 100:'#ffedd5', 500:'#f97316', 600:'#ea580c', 700:'#c2410c' },
                        status: { new:'#3b82f6', process:'#eab308', assign:'#a855f7', approve:'#06b6d4', finish:'#22c55e', complete:'#22c55e', cancel:'#ef4444' }
                    },
                    fontFamily: { sans: ['Prompt', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Prompt', sans-serif; background-color: #f8fafc; }
        .submenu { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .submenu.open { max-height: 500px; transition: max-height 0.5s ease-in; }
        .status-badge { @apply px-2.5 py-0.5 text-xs rounded-full font-bold border whitespace-nowrap uppercase tracking-wider; }
        .status-new { @apply bg-blue-100 text-blue-700 border-blue-200; }
        .status-process { @apply bg-yellow-100 text-yellow-800 border-yellow-200; }
        .status-assign { @apply bg-purple-100 text-purple-700 border-purple-200; }
        .status-approve { @apply bg-cyan-100 text-cyan-700 border-cyan-200; }
        .status-finish { @apply bg-green-100 text-green-700 border-green-200; } 
        .status-complete { @apply bg-green-100 text-green-700 border-green-200; }
        .status-cancel { @apply bg-red-100 text-red-700 border-red-200; }
        .rr-box { @apply border border-orange-200 rounded-xl p-4 bg-orange-50 mb-6 shadow-sm relative; }
        .rr-label { @apply text-xs font-bold text-gray-500 uppercase tracking-wider mb-1; }
        .rr-value { @apply font-bold text-gray-800 text-lg; }
        input:disabled, select:disabled, textarea:disabled { background-color: #f3f4f6; color: #9ca3af; cursor: not-allowed; }
        .other-input { display: none; margin-top: 0.5rem; }
        .other-input.show { display: block; animation: fadeIn 0.3s; }
        .indicator { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .indicator.loading { background-color: #fbbf24; animation: pulse 1.5s infinite; }
        .indicator.online { background-color: #22c55e; box-shadow: 0 0 5px #22c55e; }
        .indicator.error { background-color: #ef4444; }
        .calendar-day:hover { transform: translateY(-2px); z-index: 10; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); cursor: pointer; border-color: #f97316; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 2px; }
        .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 200ms; }
        
        /* Select2 Custom */
        .select2-container .select2-selection--multiple { min-height: 42px; border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 4px; }
        .select2-container--default .select2-selection--multiple .select2-selection__choice { background-color: #ffedd5; border: 1px solid #fed7aa; border-radius: 0.25rem; color: #c2410c; padding: 0 4px; margin-top: 4px; }
        .select2-container--default .select2-selection--multiple .select2-selection__choice__remove { color: #c2410c; margin-right: 5px; }
        .select2-container--default.select2-container--focus .select2-selection--multiple { border-color: #f97316; box-shadow: 0 0 0 1px #f97316; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-gray-800">
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden lg:hidden transition-opacity"></div>
    
    <!-- Sidebar -->
    <aside id="sidebar" class="fixed lg:static inset-y-0 left-0 w-72 bg-white shadow-xl transform -translate-x-full lg:translate-x-0 transition-transform duration-300 z-30 flex flex-col h-full border-r border-gray-200">
        <div class="p-6 border-b border-gray-100 flex items-center justify-center bg-gray-50">
            <div class="text-center">
                <!-- LOGO AREA: Try loading SYMC logo, fallback to Bolt icon if missing -->
                <div class="flex justify-center items-center mb-3">
                    <img src="SYMC logo.png" 
                         alt="SYMC Logo" 
                         class="h-16 object-contain"
                         onerror="this.style.display='none'; document.getElementById('logo-fallback').classList.remove('hidden');">
                    <i id="logo-fallback" class="fa-solid fa-bolt text-4xl text-brand-500 hidden"></i>
                </div>
                <h1 class="text-xl font-bold text-gray-800 tracking-tight">Assignment</h1>
                <h2 class="text-xs font-semibold text-gray-500 tracking-wide uppercase mt-1">Interruption Team</h2>
            </div>
        </div>
        <nav class="flex-1 overflow-y-auto p-4 space-y-2">
            <a href="#" onclick="switchView('calendar')" class="nav-item flex items-center p-3 rounded-lg hover:bg-brand-50 hover:text-brand-600 transition-all active-nav bg-brand-50 text-brand-600 font-semibold" data-view="calendar"><div class="w-8 flex justify-center"><i class="fa-regular fa-calendar-days text-lg"></i></div><span class="ml-3">ปฏิทินงาน (Calendar)</span></a>
            <a href="#" onclick="switchView('plan_interruption')" class="nav-item flex items-center p-3 rounded-lg hover:bg-brand-50 hover:text-brand-600 transition-all group" data-view="plan_interruption"><div class="w-8 flex justify-center"><i class="fa-solid fa-clipboard-list text-lg group-hover:text-brand-500"></i></div><span class="ml-3">Interruption Plan</span></a>
            <a href="#" onclick="switchView('team', 'Interruption Team')" class="nav-item flex items-center p-3 rounded-lg text-gray-700 hover:bg-brand-50 hover:text-brand-600 transition-all" data-view="team"><div class="w-8 flex justify-center"><i class="fa-solid fa-users text-lg"></i></div><span class="ml-3">Interruption Team</span></a>
            <div>
                <button onclick="toggleSubmenu('subcontractor-menu', this)" class="w-full flex items-center justify-between p-3 rounded-lg text-gray-700 hover:bg-brand-50 hover:text-brand-600 transition-all group"><div class="flex items-center"><div class="w-8 flex justify-center"><i class="fa-solid fa-helmet-safety text-lg group-hover:text-brand-500"></i></div><span class="ml-3">Subcontractor</span></div><i class="fa-solid fa-chevron-down text-xs transition-transform duration-300 text-gray-400"></i></button>
                <div id="subcontractor-menu" class="submenu pl-4 space-y-1 mt-1">
                    <a href="#" onclick="switchView('sub_preventive', 'Assignment Preventive')" class="block p-2 rounded-md text-sm text-gray-600 hover:text-brand-600 hover:bg-brand-50 pl-12 border-l-2 border-transparent hover:border-brand-300">Preventive</a>
                    <a href="#" onclick="switchView('sub_reroute', 'Assignment Reroute')" class="block p-2 rounded-md text-sm text-gray-600 hover:text-brand-600 hover:bg-brand-50 pl-12 border-l-2 border-transparent hover:border-brand-300">Reroute</a>
                    <a href="#" onclick="switchView('sub_reconfigure', 'Assignment Reconfigure')" class="block p-2 rounded-md text-sm text-gray-600 hover:text-brand-600 hover:bg-brand-50 pl-12 border-l-2 border-transparent hover:border-brand-300">Reconfigure</a>
                    <a href="#" onclick="switchView('setting')" class="block p-2 rounded-md text-sm text-gray-600 hover:text-brand-600 hover:bg-brand-50 pl-12 border-l-2 border-transparent hover:border-brand-300"><i class="fa-solid fa-gear mr-2"></i>Setting</a>
                </div>
            </div>
        </nav>
        <div class="p-4 border-t border-gray-100 text-xs text-gray-400 text-center bg-gray-50"><p>© 2026 Assignment Interruption Team</p></div>
    </aside>
    
    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full relative overflow-hidden bg-gray-50">
        <header class="bg-white shadow-sm h-16 flex-none flex items-center justify-between px-4 lg:px-8 z-10 border-b border-gray-200">
            <div class="flex items-center"><button onclick="toggleSidebar()" class="lg:hidden text-gray-500 hover:text-brand-600 mr-4 focus:outline-none"><i class="fa-solid fa-bars text-2xl"></i></button><h2 id="page-title" class="text-xl font-bold text-gray-800"><span class="text-brand-500 mr-2">|</span> ปฏิทินงาน</h2></div>
            <div class="flex items-center space-x-4"><div class="flex flex-col items-end"><div id="db-status" class="text-xs px-3 py-1.5 rounded-full bg-gray-100 text-gray-600 flex items-center cursor-pointer hover:bg-gray-200 transition" onclick="testConnection()"><span class="indicator loading" id="status-dot"></span> <span id="status-text" class="font-medium">Connecting...</span></div></div><div class="h-10 w-10 bg-gradient-to-br from-brand-100 to-orange-200 rounded-full flex items-center justify-center text-brand-600 shadow-sm border border-white"><i class="fa-regular fa-user"></i></div></div>
        </header>
        
        <!-- Content -->
        <div id="content-container" class="flex-1 flex flex-col overflow-hidden relative p-4 lg:p-6">
            <!-- VIEW: CALENDAR -->
            <div id="view-calendar" class="view-section flex-1 flex flex-col overflow-hidden">
                <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-200 h-full flex flex-col overflow-hidden">
                     <div class="flex flex-col md:flex-row justify-between items-center mb-6 flex-none">
                        <div class="flex items-center space-x-4"><button onclick="changeMonth(-1)" class="w-10 h-10 rounded-full hover:bg-gray-100 text-gray-600 transition"><i class="fa-solid fa-chevron-left"></i></button><h2 id="calendar-month-year" class="text-2xl font-bold text-gray-800 w-48 text-center"></h2><button onclick="changeMonth(1)" class="w-10 h-10 rounded-full hover:bg-gray-100 text-gray-600 transition"><i class="fa-solid fa-chevron-right"></i></button></div>
                        <button onclick="jumpToToday()" class="px-5 py-2 bg-brand-500 text-white rounded-lg text-sm hover:bg-brand-600 shadow-md hover:shadow-lg transition font-medium">วันนี้ (Today)</button>
                    </div>
                    <div class="grid grid-cols-7 gap-2 mb-2 text-center font-bold text-gray-500 text-sm flex-none uppercase tracking-wide"><div class="text-red-500">อา</div><div>จ</div><div>อ</div><div>พ</div><div>พฤ</div><div>ศ</div><div class="text-brand-500">ส</div></div>
                    <div id="calendar-days" class="grid grid-cols-7 gap-2 flex-1 overflow-y-auto pr-1"></div>
                </div>
            </div>
            
            <!-- VIEW: DATA TABLE -->
            <div id="view-datatable" class="view-section hidden flex-1 flex flex-col overflow-hidden">
                <!-- Dashboard Sub -->
                <div id="sub-dashboard" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3 hidden mb-4 flex-none transition-all">
                    <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-blue-500"><p class="text-[10px] text-gray-500 uppercase font-bold tracking-wide">New Job</p><h3 id="sub-count-new" class="text-2xl font-bold text-blue-600">0</h3></div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-yellow-500"><p class="text-[10px] text-gray-500 uppercase font-bold tracking-wide">Inprocess</p><h3 id="sub-count-process" class="text-2xl font-bold text-yellow-600">0</h3></div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-purple-500"><p class="text-[10px] text-gray-500 uppercase font-bold tracking-wide">Assign Job</p><h3 id="sub-count-assign" class="text-2xl font-bold text-purple-600">0</h3></div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-cyan-500"><p class="text-[10px] text-gray-500 uppercase font-bold tracking-wide">Approve Job</p><h3 id="sub-count-approve" class="text-2xl font-bold text-cyan-600">0</h3></div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-green-500"><p class="text-[10px] text-gray-500 uppercase font-bold tracking-wide">Finish</p><h3 id="sub-count-finish" class="text-2xl font-bold text-green-600">0</h3></div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-red-500"><p class="text-[10px] text-gray-500 uppercase font-bold tracking-wide">Job Cancel</p><h3 id="sub-count-cancel" class="text-2xl font-bold text-red-600">0</h3></div>
                </div>

                <div id="team-dashboard" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 hidden mb-4 flex-none">
                    <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-blue-500 flex justify-between"><div><p class="text-xs text-gray-500 uppercase font-bold">New Job</p><h3 id="team-count-new" class="text-2xl font-bold text-blue-600">0</h3></div><i class="fa-solid fa-file-circle-plus text-blue-100 text-3xl"></i></div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-yellow-500 flex justify-between"><div><p class="text-xs text-gray-500 uppercase font-bold">Inprocess</p><h3 id="team-count-process" class="text-2xl font-bold text-yellow-600">0</h3></div><i class="fa-solid fa-spinner text-yellow-100 text-3xl"></i></div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-green-500 flex justify-between"><div><p class="text-xs text-gray-500 uppercase font-bold">Complete</p><h3 id="team-count-complete" class="text-2xl font-bold text-green-600">0</h3></div><i class="fa-solid fa-check-circle text-green-100 text-3xl"></i></div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-red-500 flex justify-between"><div><p class="text-xs text-gray-500 uppercase font-bold">Job Cancel</p><h3 id="team-count-cancel" class="text-2xl font-bold text-red-600">0</h3></div><i class="fa-solid fa-ban text-red-100 text-3xl"></i></div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 flex-1 flex flex-col overflow-hidden">
                    <div class="p-6 flex-none border-b border-gray-100">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4"><h3 id="table-header" class="text-xl font-bold text-gray-800 flex items-center"><i class="fa-solid fa-list-ul mr-2 text-brand-500"></i> รายการงาน</h3><div class="flex space-x-2"><button onclick="exportExcel()" class="px-4 py-2 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 transition flex items-center text-sm font-medium"><i class="fa-solid fa-file-excel mr-2"></i> Export</button><button onclick="openModal()" class="px-4 py-2 bg-brand-500 text-white rounded-lg shadow hover:bg-brand-600 transition flex items-center text-sm font-medium"><i class="fa-solid fa-plus mr-2"></i> เพิ่มงาน</button></div></div>
                        <div class="flex flex-wrap gap-3 items-center bg-gray-50 p-3 rounded-xl border border-gray-100"><div class="flex-1 min-w-[200px] relative"><i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-gray-400"></i><input type="text" id="search-input" placeholder="ค้นหา Job ID, รายละเอียด..." class="w-full border border-gray-300 rounded-lg pl-10 pr-4 py-2 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 text-sm transition"></div><select id="filter-status" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-brand-500 bg-white"><option value="all">สถานะทั้งหมด</option><option value="new">New Job</option><option value="process">Inprocess</option><option value="assign">Assign</option><option value="approve">Approve</option><option value="finish">Finish</option><option value="cancel">Cancel</option></select></div>
                    </div>
                    <div class="flex-1 overflow-auto bg-white relative"><table class="w-full text-left border-collapse min-w-[1200px]" id="data-table"><thead class="bg-gray-50 text-gray-600 text-xs uppercase sticky top-0 z-10 shadow-sm font-semibold tracking-wider"><tr id="table-header-row"></tr></thead><tbody id="table-body" class="text-xs divide-y divide-gray-100"></tbody></table><div id="empty-state" class="hidden py-20 text-center text-gray-400 absolute inset-0 flex items-center justify-center flex-col pointer-events-none"><i class="fa-regular fa-folder-open text-5xl mb-4 text-gray-300"></i><p class="text-sm font-medium">ไม่พบข้อมูลในระบบ</p></div></div>
                    <div class="flex-none p-4 border-t border-gray-100 bg-gray-50 flex justify-between items-center text-xs text-gray-500"><div class="flex items-center gap-2">Rows per page: <select id="rows-per-page" onchange="changeRowsPerPage()" class="border rounded p-1 bg-white"><option value="10">10</option><option value="20">20</option><option value="50">50</option><option value="all">All</option></select></div><div id="pagination-controls" class="flex items-center gap-2"></div><div id="pagination-info"></div></div>
                </div>
            </div>
            
            <!-- SETTING View -->
            <div id="view-setting" class="view-section hidden flex-1 flex flex-col overflow-auto">
                <div class="max-w-6xl mx-auto w-full space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 flex flex-col md:flex-row justify-between items-center gap-4"><div><h3 class="text-2xl font-bold text-gray-800 flex items-center"><i class="fa-solid fa-database mr-3 text-brand-500"></i> ฐานข้อมูล (Master Data)</h3><p class="text-sm text-gray-500 mt-1">จัดการเฉพาะข้อมูล Subcontractor และ NS Respond</p></div><button onclick="confirmClearDatabase()" class="px-5 py-2.5 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 text-sm font-medium border border-red-200 transition flex items-center shadow-sm"><i class="fa-solid fa-trash-can mr-2"></i> ล้างข้อมูลทั้งหมด (Reset Database)</button></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 flex flex-col"><h4 class="font-bold text-gray-800 mb-4 pb-3 border-b border-gray-100 flex items-center"><i class="fa-solid fa-helmet-safety text-orange-500 mr-2"></i> Subcontractors (Round Robin)</h4><div class="flex gap-2 mb-4"><input type="text" id="add-sub" class="flex-1 border border-gray-300 rounded-lg px-4 py-2 text-sm focus:border-brand-500 focus:outline-none" placeholder="ชื่อทีม..."><button onclick="addSettingItem('subcontractors', 'add-sub')" class="bg-brand-500 text-white px-4 rounded-lg hover:bg-brand-600 shadow-md transition"><i class="fa-solid fa-plus"></i></button></div><ul id="list-subcontractors" class="space-y-2 overflow-y-auto flex-1 max-h-64 pr-2 scrollbar-thin"></ul></div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 flex flex-col"><h4 class="font-bold text-gray-800 mb-4 pb-3 border-b border-gray-100 flex items-center"><i class="fa-solid fa-user-tag text-blue-500 mr-2"></i> NS Respond</h4><div class="flex gap-2 mb-4"><input type="text" id="add-ns-name" class="flex-1 border border-gray-300 rounded-lg px-4 py-2 text-sm focus:border-blue-500 focus:outline-none" placeholder="ชื่อ..."><input type="text" id="add-ns-phone" class="w-28 border border-gray-300 rounded-lg px-4 py-2 text-sm focus:border-blue-500 focus:outline-none" placeholder="โทร..."><button onclick="addNSRespond()" class="bg-blue-500 text-white px-4 rounded-lg hover:bg-blue-600 shadow-md transition"><i class="fa-solid fa-plus"></i></button></div><ul id="list-nsRespond" class="space-y-2 overflow-y-auto flex-1 max-h-64 pr-2 scrollbar-thin"></ul></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- ASSIGNMENT MODAL -->
    <div id="assignment-modal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-900 bg-opacity-60 transition-opacity backdrop-blur-sm" onclick="closeModal()"></div>
            <div class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl w-full border border-gray-100">
                <form id="assignment-form" onsubmit="return false;">
                    <div class="bg-white px-8 py-6">
                        <div class="flex justify-between items-center border-b border-gray-100 pb-4 mb-6"><h3 class="text-2xl font-bold text-gray-800 flex items-center" id="modal-title"><span class="bg-brand-100 text-brand-600 p-2 rounded-lg mr-3"><i class="fa-solid fa-pen-to-square"></i></span> บันทึกงานใหม่</h3><span id="display-internal-id" class="px-3 py-1 bg-gray-100 text-gray-600 rounded-lg text-sm font-mono font-bold border border-gray-200">Auto ID</span></div>
                        <input type="hidden" id="doc-id" name="docId"><input type="hidden" id="form-internal-id" name="internalId"><input type="hidden" id="form-category" name="category"><input type="hidden" id="form-file-url" name="fileUrl"><input type="hidden" id="form-file-name" name="fileName">
                        
                        <!-- RR BOX -->
                        <div class="group-sub hidden mb-6"><div class="rr-box flex justify-between items-center bg-orange-50 border border-orange-200 rounded-xl p-4"><div><p class="rr-label text-gray-500 text-xs font-bold uppercase mb-1">ทีมก่อนหน้า (Previous)</p><div class="flex flex-col"><p class="text-xl font-bold text-gray-400 mr-2" id="rr-prev-name">-</p><p class="text-xs text-gray-400 truncate max-w-[200px]" id="rr-prev-job">Job: -</p></div></div><div class="text-right"><p class="rr-label text-brand-600 text-xs font-bold uppercase mb-1">ทีมที่ได้รับงานนี้ (Current)</p><p class="text-4xl font-extrabold text-brand-600" id="rr-next-name">-</p><input type="hidden" id="form-sub-name"><div class="mt-3 flex justify-end gap-2"><button type="button" onclick="skipRoundRobin()" class="text-xs bg-white border border-gray-200 hover:bg-gray-50 text-gray-600 px-3 py-1.5 rounded-lg shadow-sm transition"><i class="fa-solid fa-forward mr-1"></i> ข้าม (Skip)</button><button type="button" onclick="resetRoundRobin()" class="text-xs bg-white border border-red-200 hover:bg-red-50 text-red-600 px-3 py-1.5 rounded-lg shadow-sm transition"><i class="fa-solid fa-rotate-left mr-1"></i> เริ่มใหม่ (Reset)</button></div></div></div></div>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                            
                            <!-- === PLAN FIELDS === -->
                            <div class="plan-only hidden"><label>Interruption ID - CM</label><input type="text" id="form-interruption-id-cm" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm"></div>
                            <div class="plan-only hidden"><label>Team Request</label><select id="form-team-req-plan" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm"></select><input type="text" id="form-team-req-plan-other" class="w-full border border-gray-300 rounded-lg p-2.5 mt-2 text-sm other-input" placeholder="ระบุอื่นๆ..."></div>
                            <div class="plan-only hidden"><label>Project</label><select id="form-project" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm"><option value="">เลือก Project...</option></select><input type="text" id="form-project-other" class="w-full border border-gray-300 rounded-lg p-2.5 mt-2 text-sm other-input" placeholder="ระบุอื่นๆ..."></div>

                            <!-- === COMMON / SUB / PLAN SHARED === -->
                            <div><label>Job Type / Int. Type <span class="text-red-500">*</span></label><select id="form-job-type" name="jobType" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm" required><option value="">เลือก...</option></select><input type="text" id="form-job-type-other" class="w-full border border-gray-300 rounded-lg p-2.5 mt-2 text-sm other-input" placeholder="ระบุอื่นๆ..."></div>
                            <div class="col-span-1 md:col-span-2"><label>Description <span class="text-red-500">*</span></label><input type="text" id="form-desc" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm" required placeholder="รายละเอียดงาน"></div>
                            <div><label>Agency Inf. <span class="text-red-500">*</span></label><select id="form-agency" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm" required></select><input type="text" id="form-agency-other" class="w-full border border-gray-300 rounded-lg p-2.5 mt-2 text-sm other-input" placeholder="ระบุอื่นๆ..."></div>
                            <div><label>Action Date <span class="text-red-500">*</span></label><input type="datetime-local" id="form-action-date" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm" required></div>
                            <div class="plan-only hidden"><label>Interruption Item (ลูกค้าที่กระทบ)</label><input type="number" id="form-interruption-item" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm" min="0" placeholder="0"></div>

                            <div class="team-only"><label>Due Date</label><input type="date" id="form-due-date" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm"></div>
                            <div class="group-sub hidden"><label>Due Date</label><input type="date" id="form-due-date-sub" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm"></div>

                            <div class="team-only hidden"><label>Team Request</label><select id="form-team-req" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm"></select><input type="text" id="form-team-req-other" class="w-full border border-gray-300 rounded-lg p-2.5 mt-2 text-sm other-input" placeholder="ระบุทีมอื่นๆ..."></div>
                            <div class="team-only hidden"><label>Req Person</label><input type="number" id="form-req-person" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm" min="1" value="1"></div>
                            <div class="team-only hidden"><label>Ref Job ID</label><input type="text" id="form-ref-job-id" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm"></div>

                            <div class="group-sub hidden"><label>รายละเอียดราคา (Objective)</label><input type="text" id="form-objective" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm"></div>
                            <div class="group-sub hidden"><label>ราคาประมาณการ (Expenses)</label><input type="number" id="form-expenses" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm"></div>
                            <div class="group-sub hidden"><label>Route Code</label><input type="text" id="form-route-code" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm"></div>
                            
                            <div class="col-span-1 md:col-span-2"><label>Location / Road</label><input type="text" id="form-location" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm"></div>
                            <div class="row-span-2"><label>NS Respond (ผู้รับผิดชอบ)</label><select id="form-ns-respond" class="select2 w-full border border-gray-300 rounded-lg p-2.5 text-sm" multiple="multiple" style="width: 100%;"></select></div>
                            
                            <div class="group-sub hidden col-span-2"><label>GPS (Multi-line)</label><textarea id="form-gps" rows="3" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm" placeholder="วางพิกัดได้หลายบรรทัด"></textarea><button type="button" onclick="getLocation('sub')" class="text-brand-500 text-xs mt-1 hover:underline"><i class="fa-solid fa-location-crosshairs"></i> Get Location</button></div>
                            <div class="team-only hidden col-span-2"><label>GPS</label><div class="flex relative"><textarea id="form-gps-team" rows="1" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm"></textarea><button type="button" onclick="getLocation('team')" class="absolute right-2 top-2 text-brand-500 hover:text-brand-600 p-1"><i class="fa-solid fa-location-crosshairs"></i></button></div></div>
                            <div class="plan-only hidden col-span-2"><label>GPS</label><div class="flex relative"><textarea id="form-gps-plan" rows="1" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm"></textarea><button type="button" onclick="getLocation('plan')" class="absolute right-2 top-2 text-brand-500 hover:text-brand-600 p-1"><i class="fa-solid fa-location-crosshairs"></i></button></div></div>
                            
                            <div class="col-span-1 md:col-span-2"><label>Remark</label><input type="text" id="form-remark" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm"></div>
                            <div class="col-span-1 md:col-span-3"><label>Image/File แนบรูปหรือไฟล์</label><div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:bg-brand-50 hover:border-brand-300 cursor-pointer relative bg-gray-50 transition group"><input type="file" id="form-file" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx"><div class="flex flex-col items-center"><i class="fa-solid fa-cloud-arrow-up text-3xl text-gray-400 group-hover:text-brand-500 mb-2 transition"></i><p class="text-sm text-gray-600 font-medium" id="file-name-display">คลิกเพื่อเลือกไฟล์ หรือลากไฟล์มาวางที่นี่</p></div></div><div id="existing-file-link" class="mt-2 text-xs text-brand-600 hidden font-medium flex items-center"><i class="fa-solid fa-paperclip mr-1"></i> <a href="#" target="_blank" class="hover:underline">ดูไฟล์เดิม</a></div></div>
                        </div>
                    </div>
                    <div class="bg-gray-50 px-8 py-5 sm:flex sm:flex-row-reverse border-t border-gray-100">
                        <button type="button" onclick="performSave()" class="w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-6 py-2.5 bg-brand-600 text-base font-medium text-white hover:bg-brand-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm transition"><i class="fa-solid fa-save mr-2 mt-0.5"></i> บันทึกข้อมูล</button>
                        <button type="button" onclick="closeModal()" class="mt-3 w-full inline-flex justify-center rounded-lg border border-gray-300 shadow-sm px-6 py-2.5 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm transition">ยกเลิก</button>
                    </div>
                </form>
             </div>
        </div>
    </div>

    <script>
        // === GLOBAL SETUP ===
        const firebaseConfig = { apiKey: "AIzaSyBY0ZewKLp8MJbkq2xxcQ2Z_cz7p04e0EY", authDomain: "assignment-interruption-final.firebaseapp.com", projectId: "assignment-interruption-final", storageBucket: "assignment-interruption-final.firebasestorage.app", messagingSenderId: "578868197362", appId: "1:578868197362:web:09649a591443922fe69d6b" };
        let auth, db; try { firebase.initializeApp(firebaseConfig); auth = firebase.auth(); db = firebase.firestore(); } catch (e) { console.error("Firebase Init Error:", e); }
        const GAS_URL = "https://script.google.com/macros/s/AKfycbx5KFStUdu_gJ-FmB99YluYydM6ObImyUqrF2vGh6DO1gCAK5JWIxz5AGG40B_iViiULQ/exec";
        const appId = "assignment-app";

        let assignments = [], masterData = {}, currentView = 'calendar', currentCategoryFilter = 'all', rrState = { next: null, prev: null }, currentPage = 1, rowsPerPage = 10, filteredData = [], currentMonth = new Date().getMonth(), currentYear = new Date().getFullYear();

        const CONST_DATA = { 
            projects: [
                "MEA", "PEA", "NBTC", "Sky Train", "Bangkok Metropolis", "BTS", "MRT", "NT", 
                "Customer", "Department Of Highways", "Department Of Rural Road", "Landlord", 
                "Local Authorty", "Motorway", "State Railway OF Thailand", "Underground", "MOI", 
                "Noah", "DWDM", "OLT and ONU", "Site Relocation", "Fiber Infra Sharing", "Improvement", "Other"
            ], 
            agencies: [
                "MEA", "PEA", "NBTC", "Sky Train", "NPD", "SQM", "Region", "NOC", 
                "SQI", "ROW", "Landlord", "TPD", "Customer", "Bangkok Metropolis", 
                "BTS", "MRT", "NT", "Motorway", "Department Of Highways", 
                "Department Of Rural Road", "Other"
            ],
            teamRequests: [
                "NOC", "HelpDesk", "TPD", "NPD", "SQM", "SQI", "Sale", 
                "Region BKK", "Cores Network", "Landlord", "SDM", 
                "Region Provincial", "ROW", "Other"
            ], 
            jobTypes: { 
                team: ["Improvement", "Create Route", "Meeting", "Team Daily", "Support", "Other"], 
                plan: ["Interruption OFC", "Interruption Equipment", "Information", "Other"], 
                preventive: ["Preventive มัดรวบสาย", "Preventive ย้ายแนวสาย", "Preventive เข้าคอนใหม่", "Preventive ติดสติ๊กเกอร์", "Preventive รื้อถอนสายตาย", "Preventive Stand by", "Preventive ทำความสะอาดSite", "Other"], 
                reroute: ["Reroute Project", "Underground", "MOI", "Reconfig for Reroute", "Other"], 
                reconfigure: ["Reconfig high loss", "Reconfig New Route", "Other"] 
            } 
        };
        const menuConfig = { 'plan_interruption': { title: 'Interruption Plan', isSub: false, isPlan: true, prefix: 'IP', jobTypeKey: 'plan', sheetName: 'Interruption Plan' }, 'team': { title: 'Assignment Interruption Team', isSub: false, prefix: 'AI', jobTypeKey: 'team', sheetName: 'Interruption Team' }, 'sub_preventive': { title: 'Assignment Preventive', isSub: true, prefix: 'PVT', jobTypeKey: 'preventive', sheetName: 'Assignment Preventive' }, 'sub_reroute': { title: 'Assignment Reroute', isSub: true, prefix: 'RER', jobTypeKey: 'reroute', sheetName: 'Assignment Reroute' }, 'sub_reconfigure': { title: 'Assignment Reconfigure', isSub: true, prefix: 'REF', jobTypeKey: 'reconfigure', sheetName: 'Assignment Reconfigure' } };

        function getAssignmentsRef() { return db ? db.collection('assignments') : null; }
        function getSettingsRef() { return db ? db.collection('settings').doc('masterData') : null; }
        
        function fmtDate(s, d) {
            if(!s) return '-';
            let dt;
            if (s && s.seconds) {
                dt = new Date(s.seconds * 1000);
            } else {
                dt = new Date(s);
            }
            if (isNaN(dt.getTime())) return '-';
            
            const day = dt.getDate();
            const month = dt.getMonth() + 1;
            const year = dt.getFullYear() + 543;
            const hours = String(dt.getHours()).padStart(2, '0');
            const minutes = String(dt.getMinutes()).padStart(2, '0');
            
            return d ? `${day}/${month}/${year}` : `${day}/${month}/${year} ${hours}:${minutes}`;
        }
        
        function extractNS(d) { const a=Array.isArray(d)?d:(d?[d]:[]); const names=[], phones=[]; a.forEach(s=>{ if(s.includes(' - ')){ const p=s.split(' - '); names.push(p[0]); phones.push(p[1]); } else { names.push(s); } }); return {names:names.join(', '), phones:phones.join(', ') || '-'}; }
        function extractGPS(g) { const lines = (g||'').split('\n'); return {start: lines[0]||'-', end: lines[1]||'-'}; }

        // === GLOBAL FUNCTIONS ===
        window.performSave = function() { if($("#assignment-form").valid()) { saveAssignment(); } };

        window.renderDropdowns = function() {
            const populate = (id, list) => { const el = $(`#${id}`); el.empty().append('<option value="">เลือก...</option>'); if(list) list.forEach(i => el.append(`<option value="${i}">${i}</option>`)); };
            const config = menuConfig[currentCategoryFilter] || menuConfig['team'];
            const activeKey = config.jobTypeKey;
            
            // Populate based on category
            populate('form-job-type', CONST_DATA.jobTypes[activeKey]); 
            populate('form-agency', CONST_DATA.agencies); 
            populate('form-project', CONST_DATA.projects); 
            populate('form-team-req-plan', CONST_DATA.teamRequests);
            populate('form-team-req', CONST_DATA.teamRequests);
            
            const nsSelect = $('#form-ns-respond');
            nsSelect.empty();
            (masterData.nsRespond || []).forEach(i => nsSelect.append(new Option(i, i, false, false)));
            nsSelect.trigger('change');
        };

        window.renderTable = function() {
            const tbody = document.getElementById("table-body"); if(!tbody) return;
            const sv = $('#search-input').val().toLowerCase(), fs = $('#filter-status').val();
            
            // DYNAMIC HEADERS
            const th = document.getElementById("table-header-row");
            const config = menuConfig[currentCategoryFilter];
            let cols = `<th>Job ID</th>`;
            if (config && config.isSub) {
                 cols += `<th>Job Type</th><th>Desc</th><th>Objective</th><th>Expenses</th><th>Route</th><th>Action</th><th>Subcontractor</th><th>NS</th><th>Loc/Road</th><th>Status</th><th>Action</th>`;
            } else if (config && config.isPlan) {
                 cols += `<th>Project</th><th>Item</th><th>Job Type</th><th>Desc</th><th>Action</th><th>Team</th><th>NS</th><th>Loc</th><th>Status</th><th>Action</th>`;
            } else {
                 cols += `<th>Job Type</th><th>Desc</th><th>Action</th><th>Due Date</th><th>Team</th><th>NS</th><th>Loc</th><th>Status</th><th>Action</th>`;
            }
            $('#table-header').html(`<i class="fa-solid fa-list-ul mr-2 text-brand-500"></i> รายการงาน ${config ? config.title : 'All'}`);
            th.innerHTML = cols;

            filteredData = assignments.filter(a => {
                if (a.category !== currentCategoryFilter) return false;
                if (fs !== 'all' && a.status !== fs) return false;
                const searchFields = [ a.internalId, a.description, a.location, a.jobType, a.agency, a.teamReq, a.subcontractor, a.project, (a.nsRespond || []).join(' ') ];
                return searchFields.join(' ').toLowerCase().includes(sv);
            });
            const total = filteredData.length, start = (currentPage - 1) * rowsPerPage, pageData = filteredData.slice(start, start + rowsPerPage);
            tbody.innerHTML = "";
            if (total === 0) { $('#empty-state').removeClass('hidden'); $('#data-table').addClass('hidden'); }
            else {
                $('#empty-state').addClass('hidden'); $('#data-table').removeClass('hidden');
                pageData.forEach(item => {
                    const badge = `<span class="status-badge status-${item.status}">${item.status.toUpperCase()}</span>`;
                    const sub = config.isSub ? (item.subcontractor || '-') : (item.teamReq || '-');
                    const acts = window.getActionButtons(item, config.isSub);
                    let rowHtml = `<td class="p-3 text-center font-mono font-bold text-brand-600 text-xs">${item.internalId}</td>`;
                    
                    if (config.isPlan) rowHtml += `<td class="p-3 text-xs">${item.project||'-'}</td><td class="p-3 text-center text-xs">${item.itemCount||'0'}</td>`;
                    
                    rowHtml += `<td class="p-3 text-xs">${item.jobType||'-'}</td><td class="p-3 truncate max-w-xs">${item.description||'-'}</td>`;
                    
                    if (config.isSub) {
                        rowHtml += `<td class="p-3 text-xs">${item.objective||'-'}</td><td class="p-3 text-xs">${item.expenses||'-'}</td><td class="p-3 text-xs">${item.routeCode||'-'}</td>`;
                    }
                    
                    rowHtml += `<td class="p-3 text-center text-xs">${fmtDate(item.actionDate)}</td>`;
                    
                    if(!config.isSub && !config.isPlan) rowHtml += `<td class="p-3 text-center text-xs">${item.dueDate ? fmtDate(item.dueDate, true) : '-'}</td>`;

                    if (!config.isPlan) rowHtml += `<td class="p-3 text-blue-600 font-medium text-xs">${sub}</td>`;
                    
                    rowHtml += `<td class="p-3 truncate max-w-[100px] text-xs">${extractNS(item.nsRespond).names}</td><td class="p-3 truncate max-w-[100px] text-xs">${item.location||'-'}</td><td class="p-3 text-center">${badge}</td>`;
                    
                    let m = `<button onclick="viewDetail('${item.id}')" class="text-gray-400 hover:text-green-600 mx-1"><i class="fa-solid fa-file-lines"></i></button>`;
                    if(config.isSub) m += `<button onclick="requestApprove('${item.id}')" class="text-gray-400 hover:text-purple-600 mx-1"><i class="fa-solid fa-money-bill-wave"></i></button>`;
                    m += `<button onclick="openModal('${item.id}')" class="text-gray-400 hover:text-blue-600 mx-1"><i class="fa-solid fa-pen-to-square"></i></button><button onclick="deleteAssignment('${item.id}')" class="text-gray-400 hover:text-red-600 mx-1"><i class="fa-solid fa-trash-can"></i></button>`;
                    if(item.fileUrl) m+= `<a href="${item.fileUrl}" target="_blank" class="text-gray-400 hover:text-blue-500 mx-1"><i class="fa-solid fa-cloud-arrow-down"></i></a>`;

                    rowHtml += `<td class="p-3 text-center"><div class="flex items-center justify-center space-x-2"><div class="flex gap-1">${acts}</div><div class="h-4 w-px bg-gray-200"></div><div class="flex">${m}</div></div></td>`;
                    
                    tbody.insertAdjacentHTML('beforeend', `<tr class="hover:bg-gray-50 border-b border-gray-50">${rowHtml}</tr>`);
                });
            }
            $('#pagination-info').text(`Showing ${Math.min(start+1, total)}-${Math.min(start+pageData.length, total)} of ${total}`);
            $('#pagination-controls').html(`<button onclick="changePage(${Math.max(1, currentPage-1)})" class="px-2 border rounded"><</button><button onclick="changePage(${Math.min(Math.ceil(total/rowsPerPage), currentPage+1)})" class="px-2 border rounded">></button>`);
        };

        window.renderCalendar = function(m, y) {
            $('#calendar-month-year').text(`${["ม.ค.","ก.พ.","มี.ค.","เม.ย.","พ.ค.","มิ.ย.","ก.ค.","ส.ค.","ก.ย.","ต.ค.","พ.ย.","ธ.ค."][m]} ${y}`);
            const c = document.getElementById("calendar-days"); if(!c) return; c.innerHTML = "";
            const f = new Date(y, m, 1).getDay(), d = new Date(y, m + 1, 0).getDate();
            for(let i=0; i<f; i++) c.appendChild(document.createElement("div"));
            for(let i=1; i<=d; i++) {
                const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                const jobs = assignments.filter(a => (a.actionDate||'').startsWith(ds) && a.status!=='new' && a.status!=='cancel' && a.jobType!=='Team Daily').sort((a,b) => (a.actionDate||'').localeCompare(b.actionDate||''));
                const el = document.createElement("div"); el.className = "calendar-day relative h-24 border rounded-xl p-1 bg-white hover:bg-gray-50 overflow-hidden";
                let h = ''; jobs.forEach(j => { 
                    let cl = j.status==='process'?'bg-yellow-100 text-yellow-800':(j.status==='finish'||j.status==='complete'?'bg-green-100 text-green-800':'bg-gray-100');
                    h += `<div class="text-[9px] ${cl} rounded px-1 mb-1 truncate cursor-pointer hover:opacity-80" onclick="showJobDetail('${j.id}'); event.stopPropagation();"><b>${j.actionDate.split('T')[1].slice(0,5)}</b> ${j.internalId}</div>`; 
                });
                el.innerHTML = `<div class="text-right text-xs font-bold text-gray-400 mb-1">${i}</div><div class="overflow-y-auto h-16 custom-scrollbar">${h}</div>`;
                c.appendChild(el);
            }
        };

        window.renderSettings = function() {
            const list = $('#list-subcontractors'); list.empty(); (masterData.subcontractors||[]).forEach(i => list.append(`<li class="flex justify-between items-center bg-white border rounded px-2 py-1">${i}<button onclick="removeSettingItem('subcontractors', '${i}')" class="text-red-500 ml-2"><i class="fa-solid fa-trash text-xs"></i></button></li>`));
            const list2 = $('#list-nsRespond'); list2.empty(); (masterData.nsRespond||[]).forEach(i => list2.append(`<li class="flex justify-between items-center bg-white border rounded px-2 py-1">${i}<button onclick="removeSettingItem('nsRespond', '${i}')" class="text-red-500 ml-2"><i class="fa-solid fa-trash text-xs"></i></button></li>`));
        };

        window.getActionButtons = function(item, isSub) {
            if (!isSub) {
                if (item.status === 'new') return `<button onclick="updateStatus('${item.id}','process',{receiveDate:new Date().toISOString()})" class="bg-yellow-500 text-white px-2 py-0.5 rounded text-[10px] mr-1">Receive</button><button onclick="actionCancel('${item.id}')" class="bg-red-500 text-white px-2 py-0.5 rounded text-[10px]">Cancel</button>`;
                if (item.status === 'process') return `<button onclick="updateStatus('${item.id}','complete',{completeDate:new Date().toISOString()})" class="bg-green-500 text-white px-2 py-0.5 rounded text-[10px]">Finish</button>`;
                return '-';
            }
            switch(item.status) {
                case 'new': return `<button onclick="updateStatus('${item.id}','process',{receiveDate:new Date().toISOString()})" class="bg-yellow-500 text-white px-2 py-0.5 rounded text-[10px] mr-1">Receive</button><button onclick="actionCancel('${item.id}')" class="bg-red-500 text-white px-2 py-0.5 rounded text-[10px]">Cancel</button>`;
                case 'process': return `<button onclick="actionAssign('${item.id}')" class="bg-purple-500 text-white px-2 py-0.5 rounded text-[10px]">Assign</button>`;
                case 'assign': return `<button onclick="actionApprove('${item.id}')" class="bg-cyan-500 text-white px-2 py-0.5 rounded text-[10px]">Approve</button>`;
                case 'approve': return `<button onclick="actionFinish('${item.id}')" class="bg-green-500 text-white px-2 py-0.5 rounded text-[10px]">Finish</button>`;
                default: return '-';
            }
        };

        window.openModal = function(id = null) {
            $('#assignment-form')[0].reset(); $('#doc-id').val(''); 
            
            // Clear and Init Select2
            $('.select2').val(null).trigger('change');

            if(!menuConfig[currentCategoryFilter]) currentCategoryFilter = 'team';
            const conf = menuConfig[currentCategoryFilter];
            window.renderDropdowns();

            // Toggle Groups
            $('.group-sub, .plan-only, .team-only, .not-plan-only').addClass('hidden');

            if(conf.isSub) { 
                $('.group-sub').removeClass('hidden'); 
                fetchRoundRobinState(); 
            } else if(conf.isPlan) {
                $('.plan-only').removeClass('hidden');
                // Note: Due Date hidden for Plan
            } else {
                $('.team-only').removeClass('hidden');
                $('.not-plan-only').removeClass('hidden');
            }

            if(id) { 
                const item = assignments.find(a => a.id === id); 
                if(item) { 
                    $('#doc-id').val(item.id); $('#form-internal-id').val(item.internalId);
                    // Map Shared
                    $('#form-job-type').val(item.jobType); $('#form-desc').val(item.description); 
                    $('#form-agency').val(item.agency); $('#form-action-date').val(item.actionDate);
                    $('#form-location').val(item.location); $('#form-remark').val(item.remark);
                    
                    if(item.nsRespond) $('#form-ns-respond').val(item.nsRespond).trigger('change');

                    // Map Sub
                    if(conf.isSub) {
                        $('#form-job-type-sub').val(item.jobType); $('#form-desc-sub').val(item.description);
                        $('#form-agency-sub').val(item.agency); $('#form-action-date-sub').val(item.actionDate);
                        $('#form-due-date-sub').val(item.dueDate); $('#form-location-sub').val(item.location);
                        $('#form-gps-sub').val(item.gps); $('#form-ns-respond-sub').val(item.nsRespond).trigger('change');
                        $('#form-objective').val(item.objective); $('#form-expenses').val(item.expenses); 
                        $('#form-route-code').val(item.routeCode); $('#form-remark-sub').val(item.remark);
                    }
                    
                    // Map Plan
                    if(conf.isPlan) {
                         $('#form-interruption-id-cm').val(item.cmId); $('#form-project').val(item.project);
                         $('#form-interruption-item').val(item.itemCount); $('#form-team-req-plan').val(item.teamReq);
                         $('#form-remark').val(item.remark); $('#form-gps-plan').val(item.gps);
                    } else {
                         // Map Team
                         $('#form-due-date').val(item.dueDate); $('#form-team-req').val(item.teamReq);
                         $('#form-req-person').val(item.reqPerson); $('#form-ref-job-id').val(item.refJobId);
                         $('#form-remark').val(item.remark); $('#form-gps-team').val(item.gps);
                    }

                    // File
                    if(item.fileName) { $('#file-name-display').text(item.fileName); }
                    if(item.fileUrl) { $('#existing-file-link').removeClass('hidden').find('a').attr('href', item.fileUrl); }

                    $('#modal-title').html('<span class="bg-brand-100 text-brand-600 p-2 rounded-lg mr-3"><i class="fa-solid fa-pen-to-square"></i></span> แก้ไขข้อมูล ' + conf.title); 
                }
            } else {
                 const now = new Date(); const prefix = `${conf.prefix}${String(now.getFullYear()).slice(-2)}${String(now.getMonth()+1).padStart(2,'0')}`;
                 // V.40 FIX: Use Real-time ID Generation from Server
                 generateNextInternalId().then(newId => {
                     $('#form-internal-id').val(newId); $('#display-internal-id').text(newId); 
                 });
                 $('#modal-title').html('<span class="bg-brand-100 text-brand-600 p-2 rounded-lg mr-3"><i class="fa-solid fa-plus"></i></span> บันทึกงานใหม่ ' + conf.title);
                 $('#file-name-display').text('คลิกเพื่อเลือกไฟล์ หรือลากไฟล์มาวางที่นี่');
                 $('#existing-file-link').addClass('hidden');
            }
            $('#assignment-modal').removeClass('hidden'); 
        };

        window.closeModal = function() { $('#assignment-modal').addClass('hidden'); };
        window.toggleSidebar = function() { const s=document.getElementById('sidebar'); s.classList.toggle('-translate-x-full'); document.getElementById('sidebar-overlay').classList.toggle('hidden'); };
        window.toggleSubmenu = function(id, btn) { document.getElementById(id).classList.toggle('open'); btn.querySelector('.fa-chevron-down').classList.toggle('rotate-180'); };
        window.switchView = function(v) { currentView = v; updateView(); };
        window.updateView = function() { 
            $('.view-section').addClass('hidden'); 
            if(currentView==='calendar') { $('#view-calendar').removeClass('hidden'); renderCalendar(currentMonth, currentYear); }
            else if(currentView==='setting') { $('#view-setting').removeClass('hidden'); renderSettings(); }
            else { 
                currentCategoryFilter=currentView; 
                $('#view-datatable').removeClass('hidden'); 
                
                // Toggle Dashboard Visibility based on menu
                const config = menuConfig[currentCategoryFilter];
                if (config && config.isSub) {
                    $('#sub-dashboard').removeClass('hidden');
                    $('#team-dashboard').addClass('hidden');
                } else if (config && config.isPlan) {
                     $('#sub-dashboard').addClass('hidden');
                     $('#team-dashboard').removeClass('hidden'); 
                } else {
                     $('#sub-dashboard').addClass('hidden');
                     $('#team-dashboard').removeClass('hidden');
                }
                
                // Update Dashboard Counts
                updateDashboard();
                renderTable(); 
            }
            $('.nav-item').removeClass('bg-brand-50 text-brand-600 font-semibold active-nav');
            $(`a[data-view="${currentView}"]`).addClass('bg-brand-50 text-brand-600 font-semibold active-nav');
        };

        // --- LOGIC ---
        function updateDashboard() {
             const data = assignments.filter(a => a.category === currentCategoryFilter);
             // Helper for Sub Dashboard
             if(menuConfig[currentCategoryFilter]?.isSub) {
                $('#sub-count-new').text(data.filter(a => a.status === 'new').length);
                $('#sub-count-process').text(data.filter(a => a.status === 'process').length);
                $('#sub-count-assign').text(data.filter(a => a.status === 'assign').length);
                $('#sub-count-approve').text(data.filter(a => a.status === 'approve').length);
                $('#sub-count-finish').text(data.filter(a => a.status === 'finish' || a.status === 'complete').length);
                $('#sub-count-cancel').text(data.filter(a => a.status === 'cancel').length);
             } else {
                // Helper for Team Dashboard
                $('#team-count-new').text(data.filter(a => a.status === 'new').length);
                $('#team-count-process').text(data.filter(a => a.status === 'process').length);
                $('#team-count-complete').text(data.filter(a => a.status === 'complete' || a.status === 'finish').length);
                $('#team-count-cancel').text(data.filter(a => a.status === 'cancel').length);
             }
        }

        async function fetchRoundRobinState() { 
            if (!menuConfig[currentCategoryFilter]?.isSub) return;
            const subs = masterData.subcontractors || [];
            if (subs.length === 0) { $('#rr-next-name').text('No Data'); return; }
            const rr = masterData.rrIndexes || {};
            const catData = rr[currentCategoryFilter] || { index: 0, lastJob: '-' };
            const idx = catData.index % subs.length;
            const prev = (idx - 1 + subs.length) % subs.length;
            $('#rr-prev-name').text(subs[prev]); $('#rr-prev-job').text(`Job: ${catData.lastJob}`);
            $('#rr-next-name').text(subs[idx]); $('#form-sub-name').val(subs[idx]);
        }
        
        async function updateRoundRobinIndex(isSkip, jobName) {
            const k = `rrIndexes.${currentCategoryFilter}`; const next = (masterData.rrIndexes?.[currentCategoryFilter]?.index || 0) + 1;
            await getSettingsRef().update({[k]: {index: next, lastJob: jobName}}).catch(() => getSettingsRef().set({rrIndexes:{[currentCategoryFilter]:{index:next, lastJob:jobName}}}, {merge:true}));
            // Immediate UI update
            fetchRoundRobinState();
        }
        
        async function generateNextInternalId() {
            const conf = menuConfig[currentCategoryFilter];
            const now = new Date(); 
            const prefix = `${conf.prefix}${String(now.getFullYear()).slice(-2)}${String(now.getMonth()+1).padStart(2,'0')}`;
            
            // V.40 FIX: Query DB directly for max ID
            try {
                const snapshot = await getAssignmentsRef()
                    .where('internalId', '>=', prefix)
                    .where('internalId', '<=', prefix + '\uf8ff')
                    .get();
                
                let maxNum = 0;
                snapshot.forEach(doc => {
                    const id = doc.data().internalId;
                    if(id) {
                        const num = parseInt(id.slice(prefix.length));
                        if(!isNaN(num) && num > maxNum) maxNum = num;
                    }
                });
                return `${prefix}${String(maxNum + 1).padStart(3, '0')}`;
            } catch(e) {
                console.error("ID Gen Error", e);
                // Fallback to local
                const existingIds = assignments.filter(a => a.internalId && a.internalId.startsWith(prefix))
                    .map(a => parseInt(a.internalId.slice(prefix.length))).sort((a,b) => b-a);
                const nextNum = (existingIds.length > 0) ? existingIds[0] + 1 : 1;
                return `${prefix}${String(nextNum).padStart(3, '0')}`;
            }
        }

        window.skipRoundRobin = function() {
             const ops = (masterData.nsRespond || []).map(n => `<option value="${n}">${n}</option>`).join('');
             Swal.fire({ title: 'ข้ามคิว', html: `<input id="sk-r" class="swal2-input" placeholder="สาเหตุ"><select id="sk-b" class="swal2-input"><option value="">ผู้รับผิดชอบ</option>${ops}</select>`, showCancelButton: true, preConfirm:()=>{ return {r:$('#sk-r').val(), b:$('#sk-b').val()} } }).then(r => { if(r.isConfirmed) updateRoundRobinIndex(true, `Skip: ${r.value.r}`); });
        };
        
        window.resetRoundRobin = function() {
            Swal.fire({ title: 'Reset?', icon: 'warning', showCancelButton: true }).then(async r => { 
                if(r.isConfirmed) {
                    const k = `rrIndexes.${currentCategoryFilter}`;
                    await getSettingsRef().update({[k]: {index:0, lastJob:'Reset'}}).catch(()=>getSettingsRef().set({rrIndexes:{[currentCategoryFilter]:{index:0, lastJob:'Reset'}}}, {merge:true}));
                    fetchRoundRobinState();
                }
            });
        };

        // NEW: uploadToDrive using GAS and redirect: follow
        async function uploadToDrive(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async function() {
                    const content = reader.result.split(',')[1]; // Get base64 content
                    const formData = new URLSearchParams();
                    formData.append('action', 'upload');
                    formData.append('fileName', file.name);
                    formData.append('mimeType', file.type);
                    formData.append('fileData', content);

                    try {
                        const response = await fetch(GAS_URL, { 
                            method: 'POST', 
                            body: formData,
                            redirect: 'follow' // Important for GAS web app
                        });
                        const result = await response.json();
                        if (result.status === 'success') {
                            resolve(result.url);
                        } else {
                            reject(new Error(result.message));
                        }
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        window.saveAssignment = async function() {
            $.LoadingOverlay("show", { text: "Processing..." });
            const docId = $('#doc-id').val();
            const config = menuConfig[currentCategoryFilter];
            if (!config) { $.LoadingOverlay("hide"); Swal.fire('Error','Please select a menu first','error'); return; }
            
            // File Upload Logic
            let fileUrl = $('#form-file-url').val();
            const fileInput = $('#form-file')[0];
            if (fileInput.files.length > 0) {
                try {
                     $.LoadingOverlay("text", "Uploading to Drive...");
                     fileUrl = await uploadToDrive(fileInput.files[0]);
                } catch (uploadError) {
                     $.LoadingOverlay("hide");
                     Swal.fire('Upload Failed', 'Cannot upload file to Drive. Please try again.', 'error');
                     return;
                }
            }

            // Data Construction
            let data = {
                category: currentCategoryFilter, internalId: $('#form-internal-id').val(),
                fileName: $('#file-name-display').text(), fileUrl: fileUrl,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (config.isSub) {
                 data = { ...data,
                     jobType: $('#form-job-type-sub').val(), description: $('#form-desc-sub').val(), agency: $('#form-agency-sub').val(),
                     actionDate: $('#form-action-date-sub').val(), dueDate: $('#form-due-date-sub').val(), location: $('#form-location-sub').val(), 
                     nsRespond: $('#form-ns-respond-sub').val() || [], remark: $('#form-remark-sub').val(), gps: $('#form-gps-sub').val(),
                     objective: $('#form-objective').val(), expenses: $('#form-expenses').val(), routeCode: $('#form-route-code').val(),
                     subcontractor: $('#form-sub-name').val()
                 };
            } else if (config.isPlan) {
                 data = { ...data,
                     cmId: $('#form-interruption-id-cm').val(), project: $('#form-project').val(), 
                     jobType: $('#form-job-type').val(), description: $('#form-desc').val(), 
                     agency: $('#form-agency').val(), actionDate: $('#form-action-date').val(),
                     location: $('#form-location').val(), nsRespond: $('#form-ns-respond').val() || [],
                     itemCount: $('#form-interruption-item').val(), teamReq: $('#form-team-req-plan').val(),
                     remark: $('#form-remark').val(), gps: $('#form-gps-plan').val()
                 };
            } else {
                 // TEAM
                 data = { ...data,
                     jobType: $('#form-job-type').val(), description: $('#form-desc').val(), agency: $('#form-agency').val(),
                     actionDate: $('#form-action-date').val(), dueDate: $('#form-due-date').val(), location: $('#form-location').val(),
                     nsRespond: $('#form-ns-respond').val() || [], teamReq: $('#form-team-req').val(),
                     reqPerson: $('#form-req-person').val(), refJobId: $('#form-ref-job-id').val(),
                     remark: $('#form-remark').val(), gps: $('#form-gps-team').val()
                 };
            }
            
            if(!docId) { data.createdAt = firebase.firestore.FieldValue.serverTimestamp(); data.status = 'new'; }

            try {
                if(docId) await getAssignmentsRef().doc(docId).update(data); else await getAssignmentsRef().add(data);
                
                if(config.isSub && !docId) await updateRoundRobinIndex(false, data.description);
                
                // Sync to sheet
                sendToSheet(data, config.sheetName); 
                
                $.LoadingOverlay("hide"); closeModal(); Swal.fire('Saved', '', 'success');
            } catch(e) { $.LoadingOverlay("hide"); Swal.fire('Error', e.message, 'error'); }
        };

        window.updateStatus = function(id, status, extra) { 
            $.LoadingOverlay("show"); 
            getAssignmentsRef().doc(id).update({status: status, ...extra})
            .then(async () => {
                 const item = assignments.find(a => a.id === id);
                 if(item) { const u = {...item, status, ...extra}; const c = menuConfig[u.category]; if(c) await sendToSheet(u, c.sheetName); }
                 $.LoadingOverlay("hide");
            }).catch(e => { $.LoadingOverlay("hide"); Swal.fire('Error',e.message,'error'); });
        };
        
        window.deleteAssignment = function(id) { 
            Swal.fire({ title: 'Delete?', icon: 'warning', showCancelButton: true }).then((r) => { if (r.isConfirmed) getAssignmentsRef().doc(id).delete(); });
        };

        window.viewDetail = function(id) {
            const item = assignments.find(a => a.id === id); if(!item) return;
            const nsInfo = extractNS(item.nsRespond);
            const gpsInfo = extractGPS(item.gps, true);
            const fileLink = item.fileUrl ? `<a href="${item.fileUrl}" target="_blank">Link</a>` : '-';
            
            const html = `
                <div class="text-left text-sm space-y-2">
                   <div class="font-bold border-b pb-2 mb-2">🆕 รายการงานใหม่</div>
                   <div>📅 วันที่บันทึก : ${fmtDate(item.createdAt)}</div>
                   <div>🆔 Job ID : ${item.internalId}</div>
                   <div>👷 ผู้รับเหมาที่รับผิดชอบ : <span class="text-red-600 border border-red-500 px-1">${item.subcontractor || '-'}</span></div>
                   <div>🛠️ ประเภทงาน : ${item.jobType}</div>
                   <div>📝 ชื่องาน : ${item.description}</div>
                   <div>🕒 วันที่ดำเนินการ : ${fmtDate(item.actionDate)}</div>
                   <div>📍 สถานที่ : ${item.location}</div>
                   <div>🟢 GPS Start : ${gpsInfo.start}</div>
                   <div>🔴 GPS End : ${gpsInfo.end}</div>
                   <div>👤 ผู้รับผิดชอบ : ${nsInfo.names}</div>
                   <div>📞 เบอร์โทร : ${nsInfo.phones}</div>
                   <div class="mt-2">⏭️ ผู้รับเหมาถัดไป : <span class="text-red-600 border border-red-500 px-1" id="popup-next-sub">Loading...</span></div>
                   <div>📎 ไฟล์แนบ : ${fileLink}</div>
                </div>
            `;
            
            let nextSubName = '-';
            if(menuConfig[item.category]?.isSub && masterData.subcontractors) {
                 const rr = masterData.rrIndexes?.[item.category]?.index || 0;
                 nextSubName = masterData.subcontractors[rr % masterData.subcontractors.length];
            }
            
            Swal.fire({ title: '', html: html, showCancelButton: true, confirmButtonText: 'Copy Text', confirmButtonColor: '#06c755' }).then(r => { 
                if(r.isConfirmed) {
                    const text = `🆕 รายการงานใหม่
📅 วันที่บันทึก : ${fmtDate(item.createdAt)}
🆔 Job ID : ${item.internalId}
👷 ผู้รับเหมาที่รับผิดชอบ : 🟥 ${item.subcontractor || '-'} 🟥
🛠️ ประเภทงาน : ${item.jobType}
📝 ชื่องาน : ${item.description}
🕒 วันที่ดำเนินการ : ${fmtDate(item.actionDate)}
📍 สถานที่ : ${item.location}
🟢 GPS Start : ${gpsInfo.start}
🔴 GPS End : ${gpsInfo.end}
👤 ผู้รับผิดชอบ : ${nsInfo.names}
📞 เบอร์โทร : ${nsInfo.phones}
⏭️ ผู้รับเหมาถัดไป : 🟥 ${nextSubName} 🟥
📎 ไฟล์แนบ : ${item.fileUrl || '-'}`;
                    fallbackCopyTextToClipboard(text);
                }
            });
            setTimeout(() => $('#popup-next-sub').text(nextSubName), 100);
        };
        window.showJobDetail = function(id) { window.viewDetail(id); };

        window.requestApprove = function(id) { 
             const item = assignments.find(a => a.id === id); if (!item) return;
             const nsInfo = extractNS(item.nsRespond);
             
             let nextSubName = '-';
             if(menuConfig[item.category]?.isSub && masterData.subcontractors) {
                 const rr = masterData.rrIndexes?.[item.category]?.index || 0;
                 nextSubName = masterData.subcontractors[rr % masterData.subcontractors.length];
             }

             const html = `
                <div class="text-left text-sm space-y-2">
                   <div class="font-bold border-b pb-2 mb-2">💸 รายการอนุมัติค่าใช้จ่าย</div>
                   <div>🆔 Job ID : ${item.internalId}</div>
                   <div>👷 ผู้รับเหมา : <span class="text-red-600 border border-red-500 px-1">${item.subcontractor}</span></div>
                   <div>🛠️ ประเภทงาน : ${item.jobType}</div>
                   <div>📝 ชื่องาน : ${item.description}</div>
                   <div>🏢 หน่วยงานที่แจ้ง : ${item.agency}</div>
                   <div>🔢 Code : ${item.routeCode}</div>
                   <div>💰 ประมาณราคา : <span class="text-red-600 border border-red-500 px-1">${item.expenses}</span></div>
                   <div>🕒 วันที่ดำเนินการ : ${fmtDate(item.actionDate)}</div>
                   <div>👤 ผู้รับผิดชอบ : ${nsInfo.names}</div>
                   <div>📞 เบอร์โทร : ${nsInfo.phones}</div>
                   <div class="mt-2">⏭️ ถัดไป : <span class="text-red-600 border border-red-500 px-1">${nextSubName}</span></div>
                </div>
            `;
            
            Swal.fire({ title: '', html: html, showCancelButton: true, confirmButtonText: 'Copy Text', confirmButtonColor: '#06c755' }).then(r => { 
                if(r.isConfirmed) {
                     const text = `💸 รายการอนุมัติค่าใช้จ่าย
🆔 Job ID : ${item.internalId}
👷 ผู้รับเหมา : 🟥 ${item.subcontractor} 🟥
🛠️ ประเภทงาน : ${item.jobType}
📝 ชื่องาน : ${item.description}
🏢 หน่วยงานที่แจ้ง : ${item.agency}
🔢 Code : ${item.routeCode}
💰 ประมาณราคา : 🟥 ${item.expenses} 🟥
🕒 วันที่ดำเนินการ : ${fmtDate(item.actionDate)}
👤 ผู้รับผิดชอบ : ${nsInfo.names}
📞 เบอร์โทร : ${nsInfo.phones}
⏭️ ถัดไป : 🟥 ${nextSubName} 🟥
📎 ไฟล์แนบ : ${item.fileUrl || '-'}`;
                     fallbackCopyTextToClipboard(text);
                }
            });
        };
        
        function fallbackCopyTextToClipboard(text) {
            var textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                var successful = document.execCommand('copy');
                if(successful) Swal.fire({ icon: 'success', title: 'คัดลอกเรียบร้อย!', timer: 1000, showConfirmButton: false });
                else Swal.fire({ icon: 'error', title: 'คัดลอกไม่สำเร็จ', text: 'Browser not supported', timer: 1000, showConfirmButton: false });
            } catch (err) {
                Swal.fire({ icon: 'error', title: 'Oops...', text: 'ไม่สามารถคัดลอกได้', timer: 1000 });
            }
            document.body.removeChild(textArea);
        }

        window.actionAssign = function(id) { Swal.fire({title: 'Assign', input: 'text'}).then(r => { if(r.value) window.updateStatus(id, 'assign', {asNumber: r.value}); }); };
        window.actionApprove = function(id) { Swal.fire({title: 'Approve', showCancelButton:true}).then(r => { if(r.isConfirmed) window.updateStatus(id, 'approve', {}); }); };
        window.actionFinish = function(id) { Swal.fire({title: 'Finish', input: 'text'}).then(r => { if(r.value) window.updateStatus(id, 'finish', {ssfNumber: r.value}); }); };
        window.actionCancel = function(id) { Swal.fire({title: 'Cancel', input: 'text'}).then(r => { if(r.value) window.updateStatus(id, 'cancel', {cancelReason: r.value}); }); };
        
        window.testConnection = function() {
             getSettingsRef().get().then(()=>Swal.fire('OK','Connected','success')).catch(e=>Swal.fire('Fail',e.message,'error'));
        };

        window.addSettingItem = function(k, i) { const v = $(`#${i}`).val(); if(v) getSettingsRef().update({[k]: firebase.firestore.FieldValue.arrayUnion(v)}); };
        window.removeSettingItem = function(k, v) { getSettingsRef().update({[k]: firebase.firestore.FieldValue.arrayRemove(v)}); };
        window.addNSRespond = function() { const n=$('#add-ns-name').val(); if(n) getSettingsRef().update({nsRespond: firebase.firestore.FieldValue.arrayUnion(n)}); };
        window.confirmClearDatabase = function() { Swal.fire({title:'Reset All?', icon:'warning', showCancelButton:true}).then(r=>{ if(r.isConfirmed) { getAssignmentsRef().get().then(s=>{ s.forEach(d=>d.ref.delete()); }); initializeDatabase(true); } }); };
        
        function initializeDatabase(h) {
             const d = { nsRespond: ["Support"], subcontractors: ["Sub A", "Sub B"], rrIndexes: {} };
             getSettingsRef().set(d, {merge:true});
        }

        async function sendToSheet(data, sheetName) {
            const fd = new URLSearchParams(); fd.append('action','save'); fd.append('sheetName',sheetName); fd.append('jobId',data.internalId); fd.append('fullData',JSON.stringify(data));
            fetch(GAS_URL, {method:'POST', body:fd});
        }

        function changePage(p) { currentPage=p; renderTable(); }
        function changeRowsPerPage() { currentPage=1; renderTable(); }
        function changeMonth(d) { let m=currentMonth+d, y=currentYear; if(m<0){m=11;y--}else if(m>11){m=0;y++} currentMonth=m;currentYear=y;renderCalendar(m,y); }
        function jumpToToday() { const d=new Date(); currentMonth=d.getMonth(); currentYear=d.getFullYear(); renderCalendar(currentMonth,currentYear); }
        function exportExcel() { 
             if(filteredData.length===0) return;
             const ws = XLSX.utils.json_to_sheet(filteredData.map(i=>({ID:i.internalId, Desc:i.description, Status:i.status}))); 
             const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Data"); XLSX.writeFile(wb,"Export.xlsx"); 
        }
        window.getLocation = function(mode) {
             if (navigator.geolocation) {
                 $.LoadingOverlay("show");
                 navigator.geolocation.getCurrentPosition(p => { 
                     const val = `${p.coords.latitude},${p.coords.longitude}`;
                     const el = $(`#form-gps${mode ? '-'+mode : ''}`); // Smart selector
                     el.val(el.val() ? el.val() + '\n' + val : val);
                     $.LoadingOverlay("hide"); 
                 }, () => { $.LoadingOverlay("hide"); Swal.fire('Error', 'GPS Fail', 'error'); });
             }
        };

        // --- INIT ---
        $(document).ready(function() {
            $('.select2').select2({ placeholder: "เลือกชื่อ", allowClear: true });
            
            $('#search-input').on('input', function() { currentPage = 1; renderTable(); });
            $('#filter-status').on('change', function() { currentPage = 1; renderTable(); });

            initAuth();
            $('#form-file').change(function(e) { $('#file-name-display').text(e.target.files[0] ? e.target.files[0].name : 'Click to upload'); });
            document.getElementById('sidebar-overlay').addEventListener('click', toggleSidebar);
            ['#form-job-type', '#form-agency', '#form-team-req'].forEach(id => {
                $(id).change(function() { if($(this).val() === 'Other') $(id + '-other').addClass('show'); else $(id + '-other').removeClass('show'); });
            });
        });

        async function initAuth() {
            try { await auth.signInAnonymously();
                auth.onAuthStateChanged(user => { if(user) { 
                    $('#status-text').text('Online').parent().addClass('bg-green-100 text-green-700');
                    getAssignmentsRef().onSnapshot(snap => { assignments = []; snap.forEach(d => assignments.push({id:d.id, ...d.data()})); assignments.sort((a,b)=>(b.internalId||'').localeCompare(a.internalId||'')); window.updateView(); });
                    getSettingsRef().onSnapshot(doc => { if(doc.exists) { masterData = doc.data(); window.renderDropdowns(); window.renderSettings(); } else initializeDatabase(false); });
                } });
            } catch (e) { Swal.fire('Error', e.message, 'error'); }
        }
    </script>
</body>
</html>